<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resource Manager - Project Plan</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --sidebar-w:250px;
  --topbar-h:44px;
  --header-h:48px;
  --row-h:34px;
  --cat-row-h:32px;
  --border:#e5e7eb;
  --bg:#ffffff;
  --bg2:#f9fafb;
  --bg-weekend:rgba(0,0,0,.07);
  --text:#1f2937;
  --text2:#6b7280;
  --text3:#9ca3af;
  --blue:#3b82f6;
  --blue-light:#dbeafe;
  --red:#ef4444;
  --green:#10b981;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --day-w:120px;
  --border-subtle:#f3f4f6;
}
html.dark{
  --border:#253040;
  --border-subtle:#1b2535;
  --bg:#0f1419;
  --bg2:#161d27;
  --bg-weekend:rgba(255,255,255,.025);
  --text:#c9d1d9;
  --text2:#7d8590;
  --text3:#4d5768;
  --blue:#58a6ff;
  --blue-light:#131d2e;
  --red:#f07070;
  --green:#3fb68b;
  --shadow:0 2px 8px rgba(0,0,0,.5);
}

/* Dark mode: surfaces & overlays */
html.dark .modal{background:#1a2230;border:1px solid #253040}
html.dark .modal-bg{background:rgba(0,0,0,.55)}
html.dark .ctx-menu{background:#1a2230;border-color:#253040}
html.dark .ai-panel{background:#0f1419;border-left:1px solid #253040}
html.dark .detail-panel{background:#0f1419;box-shadow:-4px 0 24px rgba(0,0,0,.4)}
html.dark .panel-overlay.open{background:rgba(0,0,0,.4)}
html.dark .tooltip{background:#253040;box-shadow:0 2px 8px rgba(0,0,0,.4)}
html.dark .drag-date-label{background:#253040}

/* Dark mode: form inputs */
html.dark select{background:var(--bg2);color:var(--text);border-color:var(--border)}
html.dark input[type="date"]{color-scheme:dark}
html.dark input,html.dark textarea,html.dark select{background:var(--bg2);color:var(--text);border-color:var(--border)}
html.dark .form-group input:focus,html.dark .form-group select:focus,html.dark .form-group textarea:focus{box-shadow:0 0 0 3px rgba(88,166,255,.12)}
html.dark .dp-input:focus,html.dark .dp-select:focus,html.dark .dp-textarea:focus{box-shadow:0 0 0 3px rgba(88,166,255,.12)}
html.dark .ai-setup-fields input:focus{box-shadow:0 0 0 3px rgba(88,166,255,.12)}
html.dark .form-group input:disabled,html.dark .form-group input[readonly]{background:#111820;color:var(--text3)}

/* Dark mode: buttons & interactive */
html.dark .btn:hover{background:var(--bg2);border-color:#354050}
html.dark .btn-primary:hover{background:#4088e0}
html.dark .btn-danger:hover{background:rgba(240,112,112,.1)}
html.dark .ctx-item.danger:hover{background:rgba(240,112,112,.1)}
html.dark .s-cat-header:hover{filter:brightness(1.08)}
html.dark .t-row.task-row:hover{background:rgba(88,166,255,.04)}
html.dark .modal-link-add button:hover{background:var(--blue-light);border-color:var(--blue);color:var(--blue)}

/* Dark mode: scrollbar */
html.dark .timeline-body-wrap::-webkit-scrollbar-track{background:#111820}
html.dark .timeline-body-wrap::-webkit-scrollbar-thumb{background:#2a3545;border-radius:4px}
html.dark .timeline-body-wrap::-webkit-scrollbar-thumb:hover{background:#35445a}

/* Dark mode: dependency banners */
html.dark .dep-banner.is-dependent{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.3);color:#fbbf24}
html.dark .dep-banner.is-master{background:rgba(88,166,255,.08);border-color:rgba(88,166,255,.3);color:#79b8ff}
html.dark .dep-banner.is-both{background:rgba(139,92,246,.08);border-color:rgba(139,92,246,.3);color:#b4a0f0}

/* Dark mode: AI panel */
html.dark .ai-msg.system{background:rgba(245,158,11,.08);color:#fbbf24;border:1px solid rgba(245,158,11,.2)}
html.dark .ai-msg.assistant{background:#161d27}
html.dark .ai-provider-option.selected{background:var(--blue-light);border-color:rgba(88,166,255,.4)}

/* Dark mode: task bars softening */
html.dark .task-bar{box-shadow:0 1px 3px rgba(0,0,0,.3)}
html.dark .task-bar:hover{box-shadow:0 2px 10px rgba(0,0,0,.4)}

/* Dark mode: dependency arrows */
html.dark .dep-arrow{stroke:#4d5768}
html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;color:var(--text);background:var(--bg)}

/* ===== TOPBAR ===== */
.topbar{height:var(--topbar-h);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:var(--bg);z-index:100;position:relative}
.topbar h1{font-size:16px;font-weight:600;display:flex;align-items:center;gap:6px}
.project-name{cursor:pointer;border-radius:4px;padding:0 4px;transition:background .15s}
.project-name:hover{background:var(--bg2)}
.project-name-input{font-size:16px;font-weight:600;border:1px solid var(--blue);border-radius:4px;padding:0 4px;outline:none;background:var(--bg);color:var(--text);font-family:inherit}
.topbar-controls{display:flex;align-items:center;gap:6px}
.btn{border:1px solid var(--border);background:var(--bg);border-radius:5px;padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text);display:inline-flex;align-items:center;gap:4px;transition:all .15s}
.btn:hover{background:var(--bg2);border-color:#d1d5db}
.btn-primary{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn-primary:hover{background:#2563eb}
.btn-icon{padding:4px 6px;min-width:28px;justify-content:center}
.btn-danger{color:var(--red);border-color:var(--red)}
.btn-danger:hover{background:#fef2f2}
.zoom-select{border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;background:var(--bg);cursor:pointer;color:var(--text)}
.today-btn{font-weight:500}

/* ===== MAIN LAYOUT ===== */
.main-area{display:flex;flex:1;overflow:hidden;height:calc(100vh - var(--topbar-h))}
.sidebar{width:var(--sidebar-w);min-width:120px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg);z-index:10;position:relative}
.sidebar-resize{position:absolute;top:0;right:-3px;width:6px;height:100%;cursor:col-resize;z-index:20;background:transparent}
.sidebar-resize:hover,.sidebar-resize.active{background:var(--blue);opacity:.3}
.sidebar-header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;align-items:flex-end;padding:0 10px 6px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;background:var(--bg)}
.sidebar-body{flex:1;overflow-y:auto;overflow-x:hidden}
.sidebar-body::-webkit-scrollbar{width:0}

/* ===== SIDEBAR ROWS ===== */
.s-cat{}
.s-cat.cat-drag-ghost{opacity:.4}
.s-cat-reorder-line{position:absolute;left:0;right:0;height:3px;background:var(--blue);z-index:20;pointer-events:none;border-radius:1px}
.s-cat-header{height:var(--cat-row-h);display:flex;align-items:center;padding:0 8px 0 0;cursor:pointer;position:relative;background:var(--bg);border-bottom:1px solid var(--border)}
.s-cat-header:hover{filter:brightness(0.97)}
.s-cat-grip{width:20px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:grab;opacity:0;transition:opacity .15s;color:var(--text3)}
.s-cat-header:hover .s-cat-grip{opacity:.5}
.s-cat-grip:hover{opacity:1!important}
.s-cat-grip svg{pointer-events:none}
.s-cat-color{width:4px;height:100%;flex-shrink:0;border-radius:0 2px 2px 0}
.s-cat-toggle{width:28px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text3);font-size:10px;transition:transform .2s}
.s-cat-toggle.collapsed{transform:rotate(-90deg)}
.s-cat-name{flex:1;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.s-num{color:var(--text3);font-weight:500;margin-right:5px;font-size:11px}
.s-cat-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s}
.s-cat-header:hover .s-cat-actions{opacity:1}
.s-action{width:24px;height:24px;border:none;background:transparent;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:12px}
.s-action:hover{background:var(--border);color:var(--text)}

.s-task{min-height:var(--row-h);display:flex;align-items:center;padding:0 6px 0 8px;border-bottom:1px solid var(--border-subtle);position:relative;cursor:pointer}
.s-task:hover{background:var(--bg2)}
.s-task-grip{width:16px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:grab;opacity:0;transition:opacity .15s;color:var(--text3);font-size:10px;letter-spacing:1px}
.s-task:hover .s-task-grip{opacity:.6}
.s-task-grip:hover{opacity:1!important}
.s-task-grip svg{pointer-events:none}
.s-reorder-line{position:absolute;left:28px;right:8px;height:2px;background:var(--blue);z-index:20;pointer-events:none;border-radius:1px}
.s-task.drag-ghost{opacity:.4}
.s-task.selected{background:var(--blue-light)}
.s-task-dot{width:7px;height:7px;border-radius:50%;margin-right:6px;flex-shrink:0}
.s-task-name{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.s-task-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s}
.s-task:hover .s-task-actions{opacity:1}

.s-add-row{height:24px;display:flex;align-items:center;padding:0 6px 0 28px;cursor:pointer;color:var(--text3);font-size:11px;gap:4px;border-bottom:1px solid var(--border-subtle)}
.s-add-row:hover{background:var(--bg2);color:var(--blue)}

.s-add-cat{height:32px;display:flex;align-items:center;padding:0 12px;cursor:pointer;color:var(--text3);font-size:12px;gap:6px;border-bottom:1px solid var(--border)}
.s-add-cat:hover{background:var(--bg2);color:var(--blue)}

/* ===== TIMELINE ===== */
.timeline{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
.timeline-header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;background:var(--bg);flex-shrink:0;position:relative}
.t-header-row{display:flex;height:50%}
.t-header-row.row1{border-bottom:1px solid var(--border-subtle)}
.t-group{display:flex;align-items:center;font-size:12px;color:var(--text2);font-weight:500;border-right:1px solid var(--border-subtle);white-space:nowrap;overflow:hidden;position:relative}
.t-group-label{position:relative;padding:0 4px;z-index:1}
.t-col{display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text3);border-right:1px solid var(--border-subtle);white-space:nowrap;flex-shrink:0;position:relative}
.t-col.today{color:var(--blue);font-weight:700}
.t-col.today::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:22px;height:22px;background:var(--blue);border-radius:50%;z-index:-1;opacity:.1}
.t-col.weekend{background:var(--bg-weekend)}

.timeline-body-wrap{flex:1;overflow:auto;position:relative}
.timeline-body{position:relative;min-height:100%}
.t-grid{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0}
.t-month-band{position:absolute;top:0;bottom:0;pointer-events:none}
.t-weekend{position:absolute;top:0;bottom:0;background:var(--bg-weekend)}
.t-today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--blue);z-index:5;opacity:.6}
.t-gridline{position:absolute;top:0;bottom:0;width:1px;background:var(--border);opacity:.5}

.t-rows{position:relative;z-index:1}
.t-row{height:var(--row-h);position:relative;border-bottom:1px solid var(--border-subtle)}
.t-row.cat-row{height:var(--cat-row-h);background:var(--bg2);border-bottom:1px solid var(--border)}
.t-row.task-row{cursor:default}
.t-row.task-row:hover{background:rgba(59,130,246,.02)}

/* ===== TASK BARS ===== */
.task-bar{position:absolute;top:6px;height:calc(var(--row-h) - 14px);border-radius:6px;display:flex;align-items:center;padding:0 8px;font-size:12px;font-weight:500;color:#fff;cursor:grab;z-index:2;transition:box-shadow .15s,filter .15s;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;user-select:none;min-width:24px}
.task-bar:hover{box-shadow:0 2px 8px rgba(0,0,0,.2);filter:brightness(1.05);z-index:3}
.task-bar .resize-handle{position:absolute;top:0;width:10px;height:100%;cursor:col-resize;z-index:1}
.task-bar .resize-handle.left{left:-2px}
.task-bar .resize-handle.right{right:-2px}
.task-bar-label{position:relative;z-index:0;pointer-events:none;text-shadow:0 1px 2px rgba(0,0,0,.2)}
.task-bar-dates{position:absolute;top:-16px;left:0;font-size:10px;color:var(--text3);white-space:nowrap;pointer-events:none;font-weight:400}
body.dragging{cursor:grabbing!important}
body.dragging *{cursor:grabbing!important}
body.resizing{cursor:col-resize!important}
body.resizing *{cursor:col-resize!important}
.task-bar.dragging{opacity:.85;z-index:10;box-shadow:0 4px 16px rgba(0,0,0,.25);transition:none}
.drag-date-label{position:fixed;background:#1f2937;color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;z-index:600;pointer-events:none;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.2);transform:translate(-50%,-100%);margin-top:-8px}

/* ===== DEPENDENCY BUBBLE ===== */
.dep-bubble{position:absolute;right:-3px;top:50%;transform:translateY(-50%);width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.7);border:1.5px solid rgba(255,255,255,.9);cursor:crosshair;z-index:4;opacity:0;transition:opacity .15s}
.task-bar:hover .dep-bubble{opacity:1}
.dep-bubble:hover{background:#fff;transform:translateY(-50%) scale(1.4)}

/* ===== DEPENDENCY ARROWS ===== */
.dep-svg-overlay{position:absolute;top:0;left:0;pointer-events:none;z-index:3;overflow:visible}
.dep-arrow{fill:none;stroke:#6b7280;stroke-width:1.5;pointer-events:stroke;cursor:pointer}
.dep-arrow:hover{stroke:var(--red);stroke-width:2.5}

/* ===== URL LIST ===== */
.url-list{display:flex;flex-direction:column;gap:6px}
.url-item{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg2);border-radius:6px;font-size:13px;border:1px solid var(--border)}
.url-item a{color:var(--blue);text-decoration:none;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.url-item a:hover{text-decoration:underline}
.url-item-title{font-weight:500;color:var(--text);margin-right:4px;white-space:nowrap}
.url-item .s-action{flex-shrink:0}
.url-add-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.url-add-inputs{display:flex;gap:6px}
.url-add-inputs input{flex:1;border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px}
.url-add-inputs input:focus{outline:none;border-color:var(--blue)}
.url-add-btn{align-self:flex-start}

/* ===== DETAIL PANEL ===== */
.panel-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.15);z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.panel-overlay.open{opacity:1;pointer-events:auto}
.detail-panel{position:fixed;top:0;right:0;width:440px;height:100%;background:var(--bg);z-index:201;box-shadow:-4px 0 24px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.detail-panel.open{transform:translateX(0)}
.dp-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.dp-breadcrumb{font-size:12px;color:var(--text3)}
.dp-title-row{display:flex;align-items:center;gap:10px;padding:16px 20px}
.dp-color-dot{width:28px;height:28px;border-radius:50%;flex-shrink:0}
.dp-title-input{flex:1;font-size:18px;font-weight:600;border:none;outline:none;background:transparent;color:var(--text)}
.dp-body{flex:1;overflow-y:auto;padding:0 20px 20px}
.dp-field{margin-bottom:16px}
.dp-label{font-size:12px;color:var(--text3);margin-bottom:4px;display:block}
.dp-input,.dp-select,.dp-textarea{width:100%;border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:13px;font-family:inherit;color:var(--text);background:var(--bg)}
.dp-input:focus,.dp-select:focus,.dp-textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.dp-textarea{min-height:80px;resize:vertical}
.dp-date-row{display:flex;gap:8px;align-items:center}
.dp-date-row span{color:var(--text3)}
.dp-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:8px}

/* ===== MODAL ===== */
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:300;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--bg);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:440px;max-width:92vw;max-height:90vh;overflow-y:auto}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);font-size:15px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:20px}
.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center}
.form-group{margin-bottom:16px}
.form-group:last-child{margin-bottom:0}
.form-group label{display:block;font-size:12px;color:var(--text2);margin-bottom:5px;font-weight:500;letter-spacing:.01em}
.form-group input,.form-group select,.form-group textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-size:13px;font-family:inherit;transition:border-color .15s,box-shadow .15s;box-sizing:border-box}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.form-group textarea{resize:vertical;min-height:60px}
.form-row{display:flex;gap:12px}
.form-row .form-group{flex:1;margin-bottom:0}
.form-section-label{font-size:12px;color:var(--text2);font-weight:500;margin-bottom:8px;display:flex;align-items:center;gap:6px;letter-spacing:.01em}
.form-section-label svg{opacity:.5}
.modal-links-list{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.modal-link-item{display:flex;align-items:center;gap:6px;padding:7px 10px;background:var(--bg2);border-radius:6px;font-size:12px;border:1px solid var(--border)}
.modal-link-item .link-title{font-weight:500;color:var(--text);white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis}
.modal-link-item .link-url{color:var(--blue);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.modal-link-item .s-action{flex-shrink:0;font-size:10px;width:20px;height:20px;display:flex;align-items:center;justify-content:center}
.modal-link-add{display:flex;gap:6px;align-items:center}
.modal-link-add input{flex:1;border:1px solid var(--border);border-radius:6px;padding:7px 10px;font-size:12px;font-family:inherit;transition:border-color .15s}
.modal-link-add input:focus{outline:none;border-color:var(--blue)}
.modal-link-add button{flex-shrink:0;padding:7px 12px;font-size:12px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--bg2);color:var(--text2);transition:all .15s;font-weight:500}
.modal-link-add button:hover{background:var(--blue-light);border-color:var(--blue);color:var(--blue)}
.modal-empty-links{font-size:12px;color:var(--text3);padding:8px 0 4px;font-style:italic}
.modal-meta{font-size:11px;color:var(--text3);margin-top:2px;padding:0}
.dep-banner{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:8px;margin-bottom:16px;font-size:12px;line-height:1.5}
.dep-banner svg{flex-shrink:0;margin-top:1px}
.dep-banner-content{display:flex;flex-direction:column;gap:2px;min-width:0}
.dep-banner-label{font-weight:600;font-size:12px}
.dep-banner-detail{font-size:11px;opacity:.85}
.dep-banner.is-dependent{background:#fef3c7;border:1.5px solid #f59e0b;color:#92400e}
.dep-banner.is-master{background:#bfdbfe;border:1.5px solid #3b82f6;color:#1e3a8a}
.dep-banner.is-both{background:#ddd6fe;border:1.5px solid #8b5cf6;color:#4c1d95}
.form-group input:disabled,.form-group input[readonly]{background:var(--bg2);color:var(--text3);cursor:not-allowed}
.form-group .field-hint{font-size:11px;color:var(--text3);margin-top:3px;line-height:1.3}
.color-picker{display:flex;gap:6px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .15s}
.color-swatch:hover{transform:scale(1.1)}
.color-swatch.selected{border-color:var(--text)}

/* ===== AI PANEL ===== */
.ai-panel{position:fixed;top:0;right:0;width:380px;height:100%;background:var(--bg);z-index:201;box-shadow:-4px 0 24px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.ai-panel.open{transform:translateX(0)}
.ai-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ai-header h3{font-size:15px;display:flex;align-items:center;gap:6px}
.ai-messages{flex:1;overflow-y:auto;padding:16px}
.ai-msg{margin-bottom:12px;padding:10px 14px;border-radius:10px;font-size:13px;line-height:1.5;max-width:90%}
.ai-msg.user{background:var(--blue);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
.ai-msg.assistant{background:var(--bg2);color:var(--text);border-bottom-left-radius:4px}
.ai-msg.system{background:#fef3c7;color:#92400e;font-size:12px;text-align:center;max-width:100%;border-radius:6px}
.ai-input-row{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px}
.ai-input{flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;font-family:inherit;resize:none;height:40px}
.ai-input:focus{outline:none;border-color:var(--blue)}
.ai-key-setup{padding:24px 20px;display:flex;flex-direction:column;align-items:stretch}
.ai-setup-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px}
.ai-setup-desc{font-size:12px;color:var(--text3);margin-bottom:16px;line-height:1.4}
.ai-provider-group{display:flex;flex-direction:column;gap:2px;margin-bottom:16px}
.ai-provider-option{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;border:1.5px solid transparent;transition:all .15s ease;font-size:13px}
.ai-provider-option:hover{background:var(--bg2)}
.ai-provider-option.selected{background:var(--blue-light);border-color:var(--blue)}
.ai-provider-option input[type="radio"]{accent-color:var(--blue);margin:0;width:16px;height:16px;flex-shrink:0}
.ai-provider-option .ai-provider-label{display:flex;flex-direction:column;gap:1px;min-width:0}
.ai-provider-option .ai-provider-name{font-weight:600;color:var(--text);font-size:13px}
.ai-provider-option .ai-provider-tag{font-size:11px;color:var(--text3);font-weight:400}
.ai-setup-fields{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.ai-setup-fields input{width:100%;border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-size:13px;font-family:inherit;box-sizing:border-box;transition:border-color .15s ease}
.ai-setup-fields input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.ai-setup-fields input::placeholder{color:var(--text3)}
.ai-setup-action{display:flex;flex-direction:column;align-items:stretch;gap:10px}
.ai-setup-action .btn{width:100%;justify-content:center;padding:10px;font-size:13px;font-weight:600}
.ai-setup-hint{font-size:11px;color:var(--text3);line-height:1.4;text-align:center}
.ai-setup-hint a{color:var(--blue);text-decoration:none}
.ai-setup-hint a:hover{text-decoration:underline}

/* ===== CONTEXT MENU ===== */
.ctx-menu{position:fixed;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:500;min-width:160px;padding:4px;display:none}
.ctx-menu.open{display:block}
.ctx-item{padding:8px 12px;font-size:13px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px}
.ctx-item:hover{background:var(--bg2)}
.ctx-item.danger{color:var(--red)}
.ctx-item.danger:hover{background:#fef2f2}

/* ===== SCROLLBAR ===== */
.timeline-body-wrap::-webkit-scrollbar{width:8px;height:8px}
.timeline-body-wrap::-webkit-scrollbar-track{background:var(--bg2)}
.timeline-body-wrap::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}
.timeline-body-wrap::-webkit-scrollbar-thumb:hover{background:#9ca3af}

/* ===== EMPTY STATE ===== */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px;margin-bottom:8px}

/* ===== TOOLTIP ===== */
.tooltip{position:fixed;background:#1f2937;color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;z-index:600;pointer-events:none;white-space:nowrap;transform:translateX(-50%);box-shadow:0 2px 8px rgba(0,0,0,.2)}
</style>
</head>
<body>

<div id="app">
  <!-- Top Bar -->
  <div class="topbar">
    <h1>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span id="projectName" class="project-name" onclick="editProjectName()" title="Click to rename">Project Plan</span>
    </h1>
    <div class="topbar-controls">
      <button class="btn btn-icon" onclick="navigate(-1)" title="Previous">&#9664;</button>
      <button class="btn today-btn" onclick="goToday()">Today</button>
      <button class="btn btn-icon" onclick="navigate(1)" title="Next">&#9654;</button>
      <select class="zoom-select" id="zoomSelect" onchange="setZoom(this.value)">
        <option value="days">Days</option>
        <option value="weeks" selected>Weeks</option>
        <option value="months">Months</option>
        <option value="year">Year</option>
      </select>
      <button class="btn btn-primary btn-icon" onclick="showAddMenu(event)" title="Add">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="btn btn-icon" onclick="toggleAI()" title="AI Assistant" id="aiBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v3a4 4 0 01-8 0v-3H7a3 3 0 01-3-3v-2a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg>
      </button>
      <button class="btn btn-icon" onclick="toggleDarkMode()" title="Toggle dark mode" id="darkModeBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0012 21a9 9 0 009-8.21z"/></svg>
      </button>
    </div>
  </div>

  <!-- Main Area -->
  <div class="main-area">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">Categories</div>
      <div class="sidebar-body" id="sidebarBody"></div>
      <div class="sidebar-resize" id="sidebarResize"></div>
    </div>
    <!-- Timeline -->
    <div class="timeline">
      <div class="timeline-header" id="timelineHeader"></div>
      <div class="timeline-body-wrap" id="timelineWrap">
        <div class="timeline-body" id="timelineBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- Panel Overlay -->
<div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
<div class="detail-panel" id="detailPanel"></div>

<!-- AI Panel -->
<div class="ai-panel" id="aiPanel"></div>

<!-- Modal -->
<div class="modal-bg" id="modalBg" onclick="event.target===this&&closeModal()">
  <div class="modal" id="modal"></div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu"></div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip" style="display:none"></div>

<script>
// ========== CONSTANTS ==========
const COLORS = ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316','#14b8a6','#6366f1','#e11d48','#84cc16'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const ZOOM_CFG = {
  days:   { dayWidth: 56,  totalDays: 70,  navStep: 7 },
  weeks:  { dayWidth: 26,  totalDays: 126, navStep: 14 },
  months: { dayWidth: 14,  totalDays: 210, navStep: 30 },
  year:   { dayWidth: 3,   totalDays: 730, navStep: 90 }
};

const STATUS_OPTIONS = [
  { value: 'confirmed', label: 'Confirmed', color: '#10b981' },
  { value: 'tentative', label: 'Tentative', color: '#f59e0b' },
  { value: 'draft', label: 'Draft', color: '#9ca3af' }
];

// ========== STATE ==========
let state = {
  categories: [],
  zoom: 'weeks',
  viewStart: null,
  selectedTask: null,
  aiKey: '',
  aiProvider: 'gemini',
  aiCustomEndpoint: '',
  aiCustomModel: '',
  aiMessages: [],
  projectName: 'Project Plan'
};

let dragState = null;
// createDragState removed â€” task creation only via sidebar buttons
let depDragState = null;

// ========== DOM REFS ==========
const $sidebarBody = document.getElementById('sidebarBody');
const $timelineHeader = document.getElementById('timelineHeader');
const $timelineBody = document.getElementById('timelineBody');
const $timelineWrap = document.getElementById('timelineWrap');
const $panelOverlay = document.getElementById('panelOverlay');
const $detailPanel = document.getElementById('detailPanel');
const $aiPanel = document.getElementById('aiPanel');
const $modalBg = document.getElementById('modalBg');
const $modal = document.getElementById('modal');
const $ctxMenu = document.getElementById('ctxMenu');
const $tooltip = document.getElementById('tooltip');
const $zoomSelect = document.getElementById('zoomSelect');

// ========== UTILITIES ==========
function uid() { return 'id_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36); }
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function toDate(s) {
  if (s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function toStr(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${dd}`;
}

function addDays(d, n) {
  const r = new Date(d);
  r.setDate(r.getDate() + n);
  return r;
}

function diffDays(a, b) {
  const msDay = 86400000;
  return Math.round((toDate(b) - toDate(a)) / msDay);
}

function getWeek(d) {
  const date = new Date(d);
  date.setHours(0, 0, 0, 0);
  date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
  const week1 = new Date(date.getFullYear(), 0, 4);
  return 1 + Math.round(((date - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
}

function formatDateShort(d) {
  return `${d.getDate()} ${MONTHS_SHORT[d.getMonth()]}`;
}

function formatDateLong(d) {
  return `${d.getDate()} ${MONTHS_SHORT[d.getMonth()]} ${d.getFullYear()}`;
}

function todayDate() {
  const t = new Date();
  return new Date(t.getFullYear(), t.getMonth(), t.getDate());
}

function lightenColor(hex, amount = 0.88) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  const isDark = document.documentElement.classList.contains('dark');
  const target = isDark ? 18 : 255;
  const amt = isDark ? 0.82 : amount;
  const lr = Math.round(r + (target - r) * amt);
  const lg = Math.round(g + (target - g) * amt);
  const lb = Math.round(b + (target - b) * amt);
  return `rgb(${lr},${lg},${lb})`;
}

function findCat(catId) { return state.categories.find(c => c.id === catId); }
function findTask(catId, taskId) {
  const cat = findCat(catId);
  return cat ? cat.tasks.find(t => t.id === taskId) : null;
}

// ========== PERSISTENCE ==========
function saveState() {
  const data = { categories: state.categories, aiKey: state.aiKey, aiProvider: state.aiProvider, aiCustomEndpoint: state.aiCustomEndpoint, aiCustomModel: state.aiCustomModel, projectName: state.projectName };
  localStorage.setItem('rm_state', JSON.stringify(data));
}

function loadState() {
  try {
    const raw = localStorage.getItem('rm_state');
    if (raw) {
      const data = JSON.parse(raw);
      if (data.categories) state.categories = data.categories;
      if (data.aiKey) state.aiKey = data.aiKey;
      if (data.aiProvider) state.aiProvider = data.aiProvider;
      if (data.aiCustomEndpoint) state.aiCustomEndpoint = data.aiCustomEndpoint;
      if (data.aiCustomModel) state.aiCustomModel = data.aiCustomModel;
      if (data.projectName) state.projectName = data.projectName;
      // Migration: ensure every task has dependencies, urls, lastUpdated, and group
      for (const cat of state.categories) {
        for (const task of cat.tasks) {
          if (!task.dependencies) task.dependencies = [];
          if (!task.urls) task.urls = [];
          if (!task.lastUpdated) task.lastUpdated = null;
          if (!task.group) task.group = task.name;
        }
      }
    }
    // Enforce all dependency date constraints on load
    for (const cat of state.categories) {
      for (const task of cat.tasks) {
        if (task.dependencies && task.dependencies.length > 0) {
          for (const predId of task.dependencies) {
            const pred = cat.tasks.find(t => t.id === predId);
            if (pred && toDate(task.startDate) <= toDate(pred.endDate)) {
              const minStart = toStr(addDays(toDate(pred.endDate), 1));
              const shift = diffDays(task.startDate, minStart);
              task.startDate = minStart;
              task.endDate = toStr(addDays(toDate(task.endDate), shift));
            }
          }
        }
      }
    }
  } catch (e) { console.warn('Failed to load state', e); }
}

// ========== SAMPLE DATA ==========
function loadSampleData() {
  const today = todayDate();
  state.categories = [
    {
      id: uid(), name: 'Website Redesign', color: '#3b82f6', collapsed: false,
      tasks: [
        { id: uid(), name: 'UX Research', startDate: toStr(addDays(today, -5)), endDate: toStr(addDays(today, 8)), status: 'confirmed', notes: 'User interviews and competitive analysis', urls: [{title:'Figma Board', url:'https://figma.com/example'}] },
        { id: uid(), name: 'Wireframing', startDate: toStr(addDays(today, 6)), endDate: toStr(addDays(today, 18)), status: 'confirmed', notes: '', urls: [] },
        { id: uid(), name: 'Visual Design', startDate: toStr(addDays(today, 15)), endDate: toStr(addDays(today, 30)), status: 'tentative', notes: 'Pending wireframe approval', urls: [] }
      ]
    },
    {
      id: uid(), name: 'Mobile App', color: '#10b981', collapsed: false,
      tasks: [
        { id: uid(), name: 'Sprint Planning', startDate: toStr(addDays(today, -2)), endDate: toStr(addDays(today, 1)), status: 'confirmed', notes: '', urls: [] },
        { id: uid(), name: 'Development Phase 1', startDate: toStr(addDays(today, 3)), endDate: toStr(addDays(today, 22)), status: 'confirmed', notes: 'Core features implementation', urls: [{title:'GitHub Repo', url:'https://github.com/example/app'}] },
        { id: uid(), name: 'QA Testing', startDate: toStr(addDays(today, 20)), endDate: toStr(addDays(today, 32)), status: 'draft', notes: '', urls: [] }
      ]
    },
    {
      id: uid(), name: 'Marketing Campaign', color: '#f59e0b', collapsed: false,
      tasks: [
        { id: uid(), name: 'Strategy', startDate: toStr(addDays(today, -8)), endDate: toStr(addDays(today, 2)), status: 'confirmed', notes: 'Define target audience and channels', urls: [] },
        { id: uid(), name: 'Content Creation', startDate: toStr(addDays(today, 1)), endDate: toStr(addDays(today, 16)), status: 'confirmed', notes: '', urls: [] },
        { id: uid(), name: 'Launch', startDate: toStr(addDays(today, 17)), endDate: toStr(addDays(today, 24)), status: 'tentative', notes: 'Dependent on content completion', urls: [] }
      ]
    },
    {
      id: uid(), name: 'Infrastructure', color: '#8b5cf6', collapsed: false,
      tasks: [
        { id: uid(), name: 'Cloud Migration', startDate: toStr(addDays(today, 0)), endDate: toStr(addDays(today, 14)), status: 'confirmed', notes: 'AWS to GCP migration', urls: [] },
        { id: uid(), name: 'CI/CD Pipeline', startDate: toStr(addDays(today, 10)), endDate: toStr(addDays(today, 20)), status: 'draft', notes: '', urls: [] }
      ]
    }
  ];
}

// ========== GROUPING ==========
const LANE_HEIGHT = 28;
const LANE_PADDING = 6;

function computeRowHeight(numLanes) {
  return numLanes * LANE_HEIGHT + LANE_PADDING;
}

function assignLanes(tasks) {
  const lanes = new Map();
  if (tasks.length <= 1) {
    if (tasks.length === 1) lanes.set(tasks[0].id, 0);
    return { lanes, numLanes: 1 };
  }

  // Helper: check if two tasks overlap in time
  function overlaps(a, b) {
    return toDate(a.startDate) <= toDate(b.endDate) && toDate(b.startDate) <= toDate(a.endDate);
  }

  // Helper: find the lowest free lane >= minLane with no temporal overlap
  function findFreeLane(task, minLane) {
    for (let lane = minLane; lane < 100; lane++) {
      let free = true;
      for (const [id, l] of lanes) {
        if (l !== lane) continue;
        const other = taskMap.get(id);
        if (other && overlaps(task, other)) { free = false; break; }
      }
      if (free) return lane;
    }
    return minLane;
  }

  const taskMap = new Map(tasks.map(t => [t.id, t]));

  // Topological sort: predecessors are placed before their dependents
  const visited = new Set();
  const order = [];
  function visit(t) {
    if (visited.has(t.id)) return;
    visited.add(t.id);
    for (const depId of (t.dependencies || [])) {
      if (taskMap.has(depId)) visit(taskMap.get(depId));
    }
    order.push(t);
  }
  // Seed the sort by start date so independent tasks pack chronologically
  const sorted = [...tasks].sort((a, b) => {
    const cmp = toDate(a.startDate) - toDate(b.startDate);
    return cmp !== 0 ? cmp : toDate(a.endDate) - toDate(b.endDate);
  });
  for (const t of sorted) visit(t);

  // Single pass in topological order:
  // - Dependent tasks: place immediately below predecessor (predLane + 1)
  // - Independent tasks: pack into lowest free lane from 0
  for (const task of order) {
    const deps = (task.dependencies || []).filter(id => lanes.has(id));
    if (deps.length > 0) {
      const predLane = Math.max(...deps.map(id => lanes.get(id)));
      lanes.set(task.id, findFreeLane(task, predLane + 1));
    } else {
      lanes.set(task.id, findFreeLane(task, 0));
    }
  }

  let numLanes = 0;
  for (const l of lanes.values()) numLanes = Math.max(numLanes, l + 1);
  return { lanes, numLanes: Math.max(1, numLanes) };
}

function buildGroups() {
  const result = [];
  for (const cat of state.categories) {
    if (cat.collapsed) {
      result.push({ cat, groups: [] });
      continue;
    }
    const groupMap = new Map();
    const groupOrder = [];
    for (const task of cat.tasks) {
      const gKey = task.group || task.name;
      if (!groupMap.has(gKey)) {
        groupMap.set(gKey, []);
        groupOrder.push(gKey);
      }
      groupMap.get(gKey).push(task);
    }
    const groups = [];
    for (const name of groupOrder) {
      const tasks = groupMap.get(name);
      const { lanes, numLanes } = assignLanes(tasks);
      const rowHeight = computeRowHeight(numLanes);
      groups.push({ groupName: name, catId: cat.id, tasks, lanes, numLanes, rowHeight });
    }
    result.push({ cat, groups });
  }
  return result;
}

// ========== RENDERING ==========
let cachedGroups = null;
function render() {
  cachedGroups = buildGroups();
  renderSidebar();
  renderTimeline();
}

function renderSidebar() {
  let html = '';
  const grouped = cachedGroups || buildGroups();
  let catIdx = 0;
  for (const { cat, groups } of grouped) {
    catIdx++;
    const collapsed = cat.collapsed;
    const catBg = lightenColor(cat.color, 0.88);
    html += `<div class="s-cat" data-cat="${cat.id}">
      <div class="s-cat-header" style="background:${catBg}" oncontextmenu="showCatCtx(event,'${cat.id}')" onclick="toggleCat('${cat.id}')">
        <div class="s-cat-grip" onmousedown="onCatGripMouseDown(event,'${cat.id}',${catIdx - 1})"><svg width="6" height="10" viewBox="0 0 6 10"><circle cx="1.5" cy="1.5" r="1" fill="currentColor"/><circle cx="4.5" cy="1.5" r="1" fill="currentColor"/><circle cx="1.5" cy="5" r="1" fill="currentColor"/><circle cx="4.5" cy="5" r="1" fill="currentColor"/><circle cx="1.5" cy="8.5" r="1" fill="currentColor"/><circle cx="4.5" cy="8.5" r="1" fill="currentColor"/></svg></div>
        <div class="s-cat-color" style="background:${cat.color}"></div>
        <div class="s-cat-toggle ${collapsed ? 'collapsed' : ''}">&#9660;</div>
        <div class="s-cat-name"><span class="s-num">${catIdx}</span>${esc(cat.name)}</div>
        <div class="s-cat-actions">
          <button class="s-action" onclick="event.stopPropagation();showEditCatModal('${cat.id}')" title="Edit">&#9998;</button>
          <button class="s-action" onclick="event.stopPropagation();deleteCat('${cat.id}')" title="Delete">&#10005;</button>
        </div>
      </div>`;
    if (!collapsed) {
      let groupIdx = 0;
      for (const group of groups) {
        groupIdx++;
        const firstTask = group.tasks[0];
        const sel = state.selectedTask && group.tasks.some(t => t.id === state.selectedTask.taskId) ? ' selected' : '';
        const countBadge = group.tasks.length > 1 ? ` <span style="color:var(--text3);font-weight:400;font-size:11px">(${group.tasks.length})</span>` : '';
        html += `<div class="s-task${sel}" style="height:${group.rowHeight}px" data-cat="${cat.id}" data-task="${firstTask.id}" data-group="${encodeURIComponent(group.groupName)}" data-gidx="${groupIdx - 1}" onclick="openPanel('${cat.id}','${firstTask.id}')" oncontextmenu="showTaskCtx(event,'${cat.id}','${firstTask.id}')">
          <div class="s-task-grip" onmousedown="onGripMouseDown(event,'${cat.id}','${encodeURIComponent(group.groupName)}',${groupIdx - 1})"><svg width="6" height="10" viewBox="0 0 6 10"><circle cx="1.5" cy="1.5" r="1" fill="currentColor"/><circle cx="4.5" cy="1.5" r="1" fill="currentColor"/><circle cx="1.5" cy="5" r="1" fill="currentColor"/><circle cx="4.5" cy="5" r="1" fill="currentColor"/><circle cx="1.5" cy="8.5" r="1" fill="currentColor"/><circle cx="4.5" cy="8.5" r="1" fill="currentColor"/></svg></div>
          <div class="s-task-dot" style="background:${cat.color}"></div>
          <div class="s-task-name"><span class="s-num">${catIdx}.${groupIdx}</span>${esc(group.groupName)}${countBadge}</div>
          <div class="s-task-actions">
            <button class="s-action" onclick="event.stopPropagation();showAddToGroupModal('${cat.id}','${encodeURIComponent(group.groupName)}')" title="Add task to this row">&#43;</button>
            <button class="s-action" onclick="event.stopPropagation();showEditTaskModal('${cat.id}','${firstTask.id}')" title="Edit">&#9998;</button>
            <button class="s-action" onclick="event.stopPropagation();deleteTask('${cat.id}','${firstTask.id}')" title="Delete">&#10005;</button>
          </div>
        </div>`;
      }
      html += `<div class="s-add-row" onclick="showAddTaskModal('${cat.id}')">+ Add Project</div>`;
    }
    html += `</div>`;
  }
  html += `<div class="s-add-cat" onclick="showAddCatModal()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Add category
  </div>`;
  $sidebarBody.innerHTML = html;
}

function renderTimeline() {
  const cfg = ZOOM_CFG[state.zoom];
  const dayW = cfg.dayWidth;
  const totalDays = cfg.totalDays;
  const start = state.viewStart;
  const totalWidth = totalDays * dayW;
  const today = todayDate();

  // ----- HEADER -----
  let row1 = '', row2 = '';
  if (state.zoom === 'year') {
    // Row 1: Year groups, Row 2: Month columns
    let i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const yr = d.getFullYear();
      let span = 0;
      while (i + span < totalDays && addDays(start, i + span).getFullYear() === yr) span++;
      row1 += `<div class="t-group" style="width:${span * dayW}px"><span class="t-group-label">${yr}</span></div>`;
      i += span;
    }
    i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const isToday = today.getMonth() === mo && today.getFullYear() === d.getFullYear();
      const moBgY = mo % 2 === 1 ? ';background:rgba(0,0,0,.06)' : '';
      row2 += `<div class="t-col${isToday ? ' today' : ''}" style="width:${span * dayW}px${moBgY}">${MONTHS_SHORT[mo]}</div>`;
      i += span;
    }
  } else if (state.zoom === 'months') {
    // Row 1: Month groups, Row 2: Day numbers
    let i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const moBg = mo % 2 === 1 ? ';background:rgba(0,0,0,.06)' : '';
      row1 += `<div class="t-group" style="width:${span * dayW}px${moBg}"><span class="t-group-label">${MONTHS_SHORT[mo]} ${d.getFullYear()}</span></div>`;
      i += span;
    }
    for (let j = 0; j < totalDays; j++) {
      const d = addDays(start, j);
      const isWe = d.getDay() === 0 || d.getDay() === 6;
      const isT = d.getTime() === today.getTime();
      row2 += `<div class="t-col${isWe ? ' weekend' : ''}${isT ? ' today' : ''}" style="width:${dayW}px">${d.getDate()}</div>`;
    }
  } else {
    // Days & Weeks: Row 1: Month group, Row 2: Day name + date
    let i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const label = state.zoom === 'days'
        ? `${MONTHS[mo]} ${d.getFullYear()}`
        : `${MONTHS_SHORT[mo]} ${d.getFullYear()}`;
      const moBg2 = mo % 2 === 1 ? ';background:rgba(0,0,0,.06)' : '';
      row1 += `<div class="t-group" style="width:${span * dayW}px${moBg2}"><span class="t-group-label">${label}</span></div>`;
      i += span;
    }
    for (let j = 0; j < totalDays; j++) {
      const d = addDays(start, j);
      const isWe = d.getDay() === 0 || d.getDay() === 6;
      const isT = d.getTime() === today.getTime();
      const label = state.zoom === 'days'
        ? `${DAYS_SHORT[d.getDay()]} ${d.getDate()}`
        : `${d.getDate()}`;
      row2 += `<div class="t-col${isWe ? ' weekend' : ''}${isT ? ' today' : ''}" style="width:${dayW}px">${label}</div>`;
    }
  }

  $timelineHeader.innerHTML =
    `<div class="t-header-row row1" style="width:${totalWidth}px">${row1}</div>
     <div class="t-header-row" style="width:${totalWidth}px">${row2}</div>`;

  // ----- BODY -----
  let gridHTML = '';
  // Alternating month bands
  {
    let mi = 0;
    while (mi < totalDays) {
      const d0 = addDays(start, mi);
      const mo = d0.getMonth();
      const yr = d0.getFullYear();
      let span = 0;
      while (mi + span < totalDays) {
        const d2 = addDays(start, mi + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== yr) break;
        span++;
      }
      if (mo % 2 === 1) {
        gridHTML += `<div class="t-month-band" style="left:${mi * dayW}px;width:${span * dayW}px;background:rgba(0,0,0,.05)"></div>`;
      }
      mi += span;
    }
  }
  // Weekend columns
  for (let j = 0; j < totalDays; j++) {
    const d = addDays(start, j);
    if (d.getDay() === 0 || d.getDay() === 6) {
      gridHTML += `<div class="t-weekend" style="left:${j * dayW}px;width:${dayW}px"></div>`;
    }
  }
  // Gridlines
  for (let j = 0; j <= totalDays; j++) {
    gridHTML += `<div class="t-gridline" style="left:${j * dayW}px"></div>`;
  }
  // Today line
  const todayOff = diffDays(toStr(start), toStr(today));
  if (todayOff >= 0 && todayOff < totalDays) {
    gridHTML += `<div class="t-today-line" style="left:${todayOff * dayW + dayW / 2}px"></div>`;
  }

  let rowsHTML = '';
  const taskPositions = new Map();
  let currentY = 0;
  const grouped = cachedGroups || buildGroups();

  for (const { cat, groups } of grouped) {
    const catLightBg = lightenColor(cat.color, 0.88);
    rowsHTML += `<div class="t-row cat-row" data-cat="${cat.id}" style="width:${totalWidth}px;background:${catLightBg}"></div>`;
    currentY += 32; // cat-row-h
    if (!cat.collapsed) {
      for (const group of groups) {
        const groupTop = currentY;
        rowsHTML += `<div class="t-row task-row" data-cat="${cat.id}" data-group="${encodeURIComponent(group.groupName)}" style="width:${totalWidth}px;height:${group.rowHeight}px">`;
        for (const task of group.tasks) {
          const tStart = diffDays(toStr(start), task.startDate);
          const tDur = diffDays(task.startDate, task.endDate) + 1;
          const barLeft = tStart * dayW;
          const barWidth = Math.max(tDur * dayW - 2, 20);
          const vis = (tStart + tDur > 0 && tStart < totalDays);
          const lane = group.lanes.get(task.id);
          const barTop = lane * LANE_HEIGHT + 4;

          taskPositions.set(task.id, {
            left: barLeft,
            right: barLeft + barWidth,
            centerY: groupTop + barTop + 10
          });

          if (vis) {
            rowsHTML += `<div class="task-bar" data-cat="${cat.id}" data-task="${task.id}"
              style="left:${barLeft}px;width:${barWidth}px;top:${barTop}px;height:20px;background:${cat.color}"
              onmousedown="onBarMouseDown(event,'${cat.id}','${task.id}')"
              onclick="event.stopPropagation();openPanel('${cat.id}','${task.id}')"
              onmouseenter="showBarTooltip(event,'${cat.id}','${task.id}')"
              onmouseleave="hideTooltip()">
              <div class="resize-handle left"></div>
              <span class="task-bar-label">${esc(task.name)}</span>
              <div class="resize-handle right"></div>
              <div class="dep-bubble" onmousedown="onDepBubbleMouseDown(event,'${cat.id}','${task.id}')"></div>
            </div>`;
          }
        }
        rowsHTML += `</div>`;
        currentY += group.rowHeight;
      }
      // Add-row placeholder (matches sidebar s-add-row height)
      rowsHTML += `<div class="t-row" data-cat="${cat.id}" data-add="1" style="width:${totalWidth}px;height:24px"></div>`;
      currentY += 24;
    }
  }

  // Build dependency SVG overlay
  let depSVG = `<svg class="dep-svg-overlay" width="${totalWidth}" height="${currentY}">
    <defs><marker id="dep-arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6b7280"/>
    </marker></defs>`;
  for (const cat of state.categories) {
    if (cat.collapsed) continue;
    for (const task of cat.tasks) {
      if (!task.dependencies || task.dependencies.length === 0) continue;
      const toPos = taskPositions.get(task.id);
      if (!toPos) continue;
      for (const predId of task.dependencies) {
        const fromPos = taskPositions.get(predId);
        if (!fromPos) continue;
        const x1 = fromPos.right, y1 = fromPos.centerY;
        const x2 = toPos.left, y2 = toPos.centerY;
        const gap = x2 - x1;
        let pathD;
        // Clean 90-degree routing: right stub, straight down, right into dependent left side
        if (gap > 0) {
          // Place vertical drop between the two bars (midpoint of the gap, clamped)
          const vertX = x1 + Math.max(1, Math.min(gap / 2, 14));
          pathD = `M${x1},${y1} L${vertX},${y1} L${vertX},${y2} L${x2},${y2}`;
        } else {
          // Bars overlapping: route below both bars
          const belowY = Math.max(y1, y2) + 18;
          const vertX = x1 + 10;
          pathD = `M${x1},${y1} L${vertX},${y1} L${vertX},${belowY} L${x2 - 10},${belowY} L${x2 - 10},${y2} L${x2},${y2}`;
        }
        depSVG += `<path class="dep-arrow" d="${pathD}"
          data-from="${predId}" data-to="${task.id}" data-cat="${cat.id}"
          oncontextmenu="showDepCtx(event,'${cat.id}','${predId}','${task.id}')"/>`;
      }
    }
  }
  depSVG += `</svg>`;

  $timelineBody.style.width = totalWidth + 'px';
  $timelineBody.innerHTML = `<div class="t-grid">${gridHTML}</div><div class="t-rows">${rowsHTML}${depSVG}</div>`;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ========== NAVIGATION ==========
function navigate(dir) {
  const step = ZOOM_CFG[state.zoom].navStep;
  state.viewStart = addDays(state.viewStart, step * dir);
  render();
}

function goToday() {
  const today = todayDate();
  const totalDays = ZOOM_CFG[state.zoom].totalDays;
  state.viewStart = addDays(today, -Math.floor(totalDays / 4));
  render();
  // Scroll to bring today into view
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const todayOff = diffDays(toStr(state.viewStart), toStr(today));
  $timelineWrap.scrollLeft = Math.max(0, todayOff * dayW - $timelineWrap.clientWidth / 3);
}

function setZoom(z) {
  state.zoom = z;
  $zoomSelect.value = z;
  goToday();
}

// ========== SCROLL SYNC ==========
function updateStickyLabels() {
  const scrollLeft = $timelineWrap.scrollLeft;
  const labels = $timelineHeader.querySelectorAll('.t-group-label');
  labels.forEach(label => {
    const group = label.parentElement;
    // Get group's position relative to header scroll
    const groupLeft = group.offsetLeft;
    const groupWidth = group.offsetWidth;
    const labelWidth = label.offsetWidth;
    // Calculate how far the label should shift to stay visible
    const offset = scrollLeft - groupLeft;
    if (offset > 0 && offset < groupWidth - labelWidth - 8) {
      label.style.transform = `translateX(${offset}px)`;
    } else {
      label.style.transform = '';
    }
  });
}
$timelineWrap.addEventListener('scroll', () => {
  $timelineHeader.scrollLeft = $timelineWrap.scrollLeft;
  $sidebarBody.scrollTop = $timelineWrap.scrollTop;
  updateStickyLabels();
});
$sidebarBody.addEventListener('scroll', () => {
  $timelineWrap.scrollTop = $sidebarBody.scrollTop;
});

// ========== SIDEBAR RESIZE ==========
const $sidebar = document.getElementById('sidebar');
const $sidebarResize = document.getElementById('sidebarResize');
let sidebarResizeState = null;
$sidebarResize.addEventListener('mousedown', (e) => {
  e.preventDefault();
  sidebarResizeState = { startX: e.clientX, startW: $sidebar.offsetWidth };
  $sidebarResize.classList.add('active');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});
document.addEventListener('mousemove', (e) => {
  if (!sidebarResizeState) return;
  const newW = Math.max(120, Math.min(500, sidebarResizeState.startW + (e.clientX - sidebarResizeState.startX)));
  $sidebar.style.width = newW + 'px';
});
document.addEventListener('mouseup', () => {
  if (sidebarResizeState) {
    sidebarResizeState = null;
    $sidebarResize.classList.remove('active');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  }
});

// ========== TIMELINE PAN ==========
let panState = null;
$timelineWrap.addEventListener('mousedown', (e) => {
  // Only start pan if clicking empty timeline area (not a bar, handle, or bubble)
  if (e.target.closest('.task-bar') || e.target.closest('.dep-bubble')) return;
  if (e.button !== 0) return;
  panState = { startX: e.clientX, startY: e.clientY, scrollLeft: $timelineWrap.scrollLeft, scrollTop: $timelineWrap.scrollTop, moved: false };
});
document.addEventListener('mousemove', (e) => {
  if (!panState) return;
  const dx = e.clientX - panState.startX;
  const dy = e.clientY - panState.startY;
  if (!panState.moved && Math.abs(dx) < 4 && Math.abs(dy) < 4) return;
  panState.moved = true;
  $timelineWrap.scrollLeft = panState.scrollLeft - dx;
  $timelineWrap.scrollTop = panState.scrollTop - dy;
});
document.addEventListener('mouseup', () => {
  panState = null;
});

// ========== CATEGORY CRUD ==========
function toggleCat(catId) {
  const cat = findCat(catId);
  if (cat) { cat.collapsed = !cat.collapsed; render(); saveState(); }
}

function showAddCatModal() {
  const html = `
    <div class="modal-header">Add Category<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Name</label><input id="mCatName" placeholder="Category name" autofocus></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map((c, i) => `<div class="color-swatch${i === 0 ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doAddCat()">Add</button>
    </div>`;
  openModal(html);
  setTimeout(() => document.getElementById('mCatName')?.focus(), 100);
}

function doAddCat() {
  const name = document.getElementById('mCatName').value.trim();
  if (!name) return;
  const color = document.querySelector('#mColorPicker .selected')?.dataset.color || COLORS[0];
  state.categories.push({ id: uid(), name, color, collapsed: false, tasks: [] });
  closeModal(); render(); saveState();
}

function showEditCatModal(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  const html = `
    <div class="modal-header">Edit Category<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Name</label><input id="mCatName" value="${esc(cat.name)}"></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map(c => `<div class="color-swatch${c === cat.color ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeModal();deleteCat('${catId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doEditCat('${catId}')">Save</button>
    </div>`;
  openModal(html);
}

function doEditCat(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  cat.name = document.getElementById('mCatName').value.trim() || cat.name;
  cat.color = document.querySelector('#mColorPicker .selected')?.dataset.color || cat.color;
  closeModal(); render(); saveState();
}

function deleteCat(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  showConfirmModal('Delete Category', `Are you sure you want to delete "${esc(cat.name)}" and all its tasks? This cannot be undone.`, () => {
    state.categories = state.categories.filter(c => c.id !== catId);
    if (state.selectedTask?.catId === catId) closePanel();
    render(); saveState();
  });
}

// ========== TASK CRUD ==========
let modalLinks = [];

function renderModalLinks() {
  const container = document.getElementById('mLinksContainer');
  if (!container) return;
  let html = '';
  if (modalLinks.length > 0) {
    html += '<div class="modal-links-list">';
    for (let i = 0; i < modalLinks.length; i++) {
      const link = modalLinks[i];
      html += `<div class="modal-link-item">
        <span class="link-title">${esc(link.title || 'Link')}</span>
        <span class="link-url">${esc(link.url)}</span>
        <button class="s-action" onclick="removeModalLink(${i})" title="Remove">&#10005;</button>
      </div>`;
    }
    html += '</div>';
  }
  html += `<div class="modal-link-add">
    <input id="mLinkTitle" placeholder="Title" style="flex:0.35">
    <input id="mLinkUrl" placeholder="https://..." style="flex:0.65" onkeydown="if(event.key==='Enter'){event.preventDefault();addModalLink()}">
    <button onclick="addModalLink()">+ Add</button>
  </div>`;
  container.innerHTML = html;
}

function addModalLink() {
  const titleEl = document.getElementById('mLinkTitle');
  const urlEl = document.getElementById('mLinkUrl');
  if (!urlEl) return;
  const url = urlEl.value.trim();
  if (!url) return;
  const title = titleEl?.value.trim() || 'Link';
  modalLinks.push({ title, url });
  renderModalLinks();
}

function removeModalLink(idx) {
  modalLinks.splice(idx, 1);
  renderModalLinks();
}

function buildTaskModalBody(opts = {}) {
  const { name, startDate, endDate, status, notes, isEdit, lastUpdated, predecessors, dependents } = opts;
  const today = toStr(todayDate());
  const startVal = startDate || today;
  const endVal = endDate || toStr(addDays(toDate(startVal), 6));

  // Dependency banners
  let depBannerHtml = '';
  const hasPreds = predecessors && predecessors.length > 0;
  const hasDeps = dependents && dependents.length > 0;
  if (hasPreds && hasDeps) {
    depBannerHtml = `<div class="dep-banner is-both">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 17L17 7M17 7H8M17 7V16"/></svg>
      <div class="dep-banner-content">
        <span class="dep-banner-label">Dependency Chain</span>
        <span class="dep-banner-detail">Depends on: ${predecessors.map(p => esc(p.name)).join(', ')}</span>
        <span class="dep-banner-detail">Blocks: ${dependents.map(d => esc(d.name)).join(', ')}</span>
      </div>
    </div>`;
  } else if (hasPreds) {
    const latestPred = predecessors.reduce((a, b) => toDate(a.endDate) > toDate(b.endDate) ? a : b);
    depBannerHtml = `<div class="dep-banner is-dependent">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
      <div class="dep-banner-content">
        <span class="dep-banner-label">Dependent Task</span>
        <span class="dep-banner-detail">Depends on: ${predecessors.map(p => esc(p.name)).join(', ')} &mdash; cannot start before ${formatDateShort(addDays(toDate(latestPred.endDate), 1))}</span>
      </div>
    </div>`;
  } else if (hasDeps) {
    depBannerHtml = `<div class="dep-banner is-master">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
      <div class="dep-banner-content">
        <span class="dep-banner-label">Master Task</span>
        <span class="dep-banner-detail">Blocks: ${dependents.map(d => esc(d.name)).join(', ')} &mdash; changing dates will cascade</span>
      </div>
    </div>`;
  }

  // Compute min start date for dependent tasks
  let minStartAttr = '';
  let startHint = '';
  if (hasPreds) {
    const latestPred = predecessors.reduce((a, b) => toDate(a.endDate) > toDate(b.endDate) ? a : b);
    const minDate = toStr(addDays(toDate(latestPred.endDate), 1));
    minStartAttr = ` min="${minDate}" onchange="clampModalStartDate('${minDate}')"`;
    startHint = `<div class="field-hint">Earliest: ${formatDateShort(toDate(minDate))}</div>`;
  }

  return `
    ${depBannerHtml}
    <div class="form-group">
      <label>Task Name</label>
      <input id="mTaskName" value="${esc(name || '')}" placeholder="Enter task name" ${!isEdit ? 'autofocus' : ''}>
    </div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="form-group">
        <label>Start Date</label>
        <input id="mStartDate" type="date" value="${startVal}"${minStartAttr}>
        ${startHint}
      </div>
      <div class="form-group">
        <label>End Date</label>
        <input id="mEndDate" type="date" value="${endVal}">
      </div>
    </div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="form-group" style="flex:1">
        <label>Status</label>
        <select id="mStatus">${STATUS_OPTIONS.map(s => `<option value="${s.value}"${s.value === (status || 'confirmed') ? ' selected' : ''}>${s.label}</option>`).join('')}</select>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="mNotes" rows="2" placeholder="Add notes...">${esc(notes || '')}</textarea>
    </div>
    <div class="form-group" style="margin-bottom:0">
      <label>Links</label>
      <div id="mLinksContainer"></div>
    </div>
    ${lastUpdated ? `<div class="modal-meta">Last updated: ${new Date(lastUpdated).toLocaleString()}</div>` : ''}`;
}

function showAddTaskModal(catId, prefillStart, prefillEnd) {
  modalLinks = [];
  const html = `
    <div class="modal-header">New Project<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      ${buildTaskModalBody({ startDate: prefillStart, endDate: prefillEnd })}
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doAddTask('${catId}')">Add Project</button>
    </div>`;
  openModal(html);
  renderModalLinks();
  setTimeout(() => document.getElementById('mTaskName')?.focus(), 100);
}

function doAddTask(catId, groupOverride) {
  const cat = findCat(catId);
  if (!cat) return;
  const name = document.getElementById('mTaskName').value.trim();
  if (!name) return;
  cat.tasks.push({
    id: uid(),
    name,
    group: groupOverride || name,
    startDate: document.getElementById('mStartDate').value,
    endDate: document.getElementById('mEndDate').value,
    status: document.getElementById('mStatus').value,
    notes: document.getElementById('mNotes').value,
    urls: [...modalLinks],
    dependencies: [],
    lastUpdated: new Date().toISOString()
  });
  modalLinks = [];
  closeModal(); render(); saveState();
}

function showAddToGroupModal(catId, encodedGroupName, prefillStart, prefillEnd) {
  modalLinks = [];
  const groupName = decodeURIComponent(encodedGroupName);
  const safeGroup = groupName.replace(/'/g, "\\'");
  const html = `
    <div class="modal-header">Add Task to "${esc(groupName)}"<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      ${buildTaskModalBody({ startDate: prefillStart, endDate: prefillEnd })}
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doAddTask('${catId}','${safeGroup}')">Add Task</button>
    </div>`;
  openModal(html);
  renderModalLinks();
  setTimeout(() => document.getElementById('mTaskName')?.focus(), 100);
}

function getTaskDepInfo(catId, taskId) {
  const cat = findCat(catId);
  const task = findTask(catId, taskId);
  if (!cat || !task) return { predecessors: [], dependents: [] };
  const predecessors = (task.dependencies || []).map(id => findTask(catId, id)).filter(Boolean);
  const dependents = cat.tasks.filter(t => t.dependencies && t.dependencies.includes(taskId));
  return { predecessors, dependents };
}

function clampModalStartDate(minDate) {
  const el = document.getElementById('mStartDate');
  if (!el) return;
  if (el.value < minDate) el.value = minDate;
}

function showEditTaskModal(catId, taskId) {
  const task = findTask(catId, taskId);
  if (!task) return;
  modalLinks = [...(task.urls || [])];
  const { predecessors, dependents } = getTaskDepInfo(catId, taskId);
  const html = `
    <div class="modal-header">Edit Task<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      ${buildTaskModalBody({ name: task.name, startDate: task.startDate, endDate: task.endDate, status: task.status, notes: task.notes, isEdit: true, lastUpdated: task.lastUpdated, predecessors, dependents })}
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeModal();deleteTask('${catId}','${taskId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doEditTask('${catId}','${taskId}')">Save</button>
    </div>`;
  openModal(html);
  renderModalLinks();
}

function doEditTask(catId, taskId) {
  const task = findTask(catId, taskId);
  if (!task) return;
  task.name = document.getElementById('mTaskName').value.trim() || task.name;
  let newStart = document.getElementById('mStartDate').value;
  let newEnd = document.getElementById('mEndDate').value;
  // Enforce: dependent task cannot start before predecessor ends
  const { predecessors } = getTaskDepInfo(catId, taskId);
  if (predecessors.length > 0) {
    const latestPredEnd = predecessors.reduce((a, b) => toDate(a.endDate) > toDate(b.endDate) ? a : b).endDate;
    const minStart = toStr(addDays(toDate(latestPredEnd), 1));
    if (newStart < minStart) {
      const shift = diffDays(newStart, minStart);
      newStart = minStart;
      newEnd = toStr(addDays(toDate(newEnd), shift));
    }
  }
  task.startDate = newStart;
  task.endDate = newEnd;
  task.status = document.getElementById('mStatus').value;
  task.notes = document.getElementById('mNotes').value;
  task.urls = [...modalLinks];
  task.lastUpdated = new Date().toISOString();
  modalLinks = [];
  enforceAllDependencies(catId, taskId);
  closeModal(); render(); saveState();
  if (state.selectedTask?.taskId === taskId) renderPanel();
}

function deleteTask(catId, taskId) {
  const cat = findCat(catId);
  if (!cat) return;
  const task = findTask(catId, taskId);
  if (!task) return;
  showConfirmModal('Delete Task', `Are you sure you want to delete "${esc(task.name)}"? This cannot be undone.`, () => {
    // Clean up dependency references
    for (const t of cat.tasks) {
      if (t.dependencies) {
        t.dependencies = t.dependencies.filter(id => id !== taskId);
      }
    }
    cat.tasks = cat.tasks.filter(t => t.id !== taskId);
    if (state.selectedTask?.taskId === taskId) closePanel();
    render(); saveState();
  });
}

// ========== DETAIL PANEL ==========
function openPanel(catId, taskId) {
  hideTooltip();
  state.selectedTask = { catId, taskId };
  renderPanel();
  $panelOverlay.classList.add('open');
  $detailPanel.classList.add('open');
  render();
}

function closePanel() {
  state.selectedTask = null;
  $panelOverlay.classList.remove('open');
  $detailPanel.classList.remove('open');
  render();
}

function renderPanel() {
  if (!state.selectedTask) return;
  const { catId, taskId } = state.selectedTask;
  const cat = findCat(catId);
  const task = findTask(catId, taskId);
  if (!cat || !task) { closePanel(); return; }

  const statusOpt = STATUS_OPTIONS.find(s => s.value === task.status) || STATUS_OPTIONS[0];

  $detailPanel.innerHTML = `
    <div class="dp-header">
      <span class="dp-breadcrumb">${esc(cat.name)} / ${esc(task.name)}</span>
      <button class="s-action" onclick="closePanel()">&#10005;</button>
    </div>
    <div class="dp-title-row">
      <div class="dp-color-dot" style="background:${cat.color}"></div>
      <input class="dp-title-input" value="${esc(task.name)}" onchange="panelUpdate('name',this.value)">
    </div>
    <div class="dp-body">
      <div class="dp-field">
        <label class="dp-label">Status</label>
        <select class="dp-select" onchange="panelUpdate('status',this.value)">
          ${STATUS_OPTIONS.map(s => `<option value="${s.value}"${s.value === task.status ? ' selected' : ''}>${s.label}</option>`).join('')}
        </select>
      </div>
      <div class="dp-field">
        <label class="dp-label">Dates</label>
        <div class="dp-date-row">
          <input class="dp-input" type="date" value="${task.startDate}" onchange="panelUpdate('startDate',this.value)" style="flex:1">
          <span>&rarr;</span>
          <input class="dp-input" type="date" value="${task.endDate}" onchange="panelUpdate('endDate',this.value)" style="flex:1">
        </div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">${diffDays(task.startDate, task.endDate) + 1} days</div>
      </div>
      <div class="dp-field">
        <label class="dp-label">Notes</label>
        <textarea class="dp-textarea" onchange="panelUpdate('notes',this.value)">${esc(task.notes)}</textarea>
      </div>
      ${task.lastUpdated ? `<div style="font-size:11px;color:var(--text3);padding:0 0 8px">Last updated: ${new Date(task.lastUpdated).toLocaleString()}</div>` : ''}
      <div class="dp-field">
        <label class="dp-label">Links</label>
        <div class="url-list" id="dpUrlList">
          ${(task.urls || []).map((u, i) => `<div class="url-item">
            <span class="url-item-title">${esc(u.title || 'Link')}</span>
            <a href="${esc(u.url)}" target="_blank" rel="noopener">${esc(u.url)}</a>
            <button class="s-action" onclick="removeUrl(${i})" title="Remove">&#10005;</button>
          </div>`).join('')}
        </div>
        <div class="url-add-row">
          <div class="url-add-inputs">
            <input id="dpUrlTitle" placeholder="Title" style="flex:0.4">
            <input id="dpUrlValue" placeholder="https://..." style="flex:0.6">
            <button class="btn btn-icon" onclick="addUrlFromPanel()" title="Add link" style="flex-shrink:0">+</button>
          </div>
        </div>
      </div>
      ${(() => {
        const predecessors = (task.dependencies || []).map(id => findTask(catId, id)).filter(Boolean);
        const dependents = cat.tasks.filter(t => t.dependencies && t.dependencies.includes(task.id));
        if (predecessors.length === 0 && dependents.length === 0) return '';
        let depHtml = '<div class="dp-field"><label class="dp-label">Dependencies</label>';
        if (predecessors.length > 0) {
          depHtml += '<div style="font-size:11px;color:var(--text3);margin-bottom:4px">Depends on:</div>';
          for (const p of predecessors) {
            depHtml += `<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:2px">
              <span style="color:var(--text2)">${esc(p.name)} (${formatDateShort(toDate(p.endDate))})</span>
              <button class="s-action" onclick="removeDep('${catId}','${task.id}','${p.id}')" title="Remove">&#10005;</button>
            </div>`;
          }
        }
        if (dependents.length > 0) {
          depHtml += '<div style="font-size:11px;color:var(--text3);margin-bottom:4px;margin-top:6px">Blocks:</div>';
          for (const d of dependents) {
            depHtml += `<div style="font-size:12px;color:var(--text2);margin-bottom:2px">${esc(d.name)} (${formatDateShort(toDate(d.startDate))})</div>`;
          }
        }
        depHtml += '</div>';
        return depHtml;
      })()}
    </div>
    <div class="dp-footer">
      <button class="btn btn-danger" onclick="closePanel();deleteTask('${catId}','${taskId}')">Delete</button>
      <button class="btn btn-primary" onclick="closePanel()">Done</button>
    </div>`;
}

function panelUpdate(key, value) {
  if (!state.selectedTask) return;
  const task = findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task) return;
  // Clamp start date for dependent tasks
  if (key === 'startDate' && task.dependencies && task.dependencies.length > 0) {
    const { predecessors } = getTaskDepInfo(state.selectedTask.catId, state.selectedTask.taskId);
    if (predecessors.length > 0) {
      const latestPredEnd = predecessors.reduce((a, b) => toDate(a.endDate) > toDate(b.endDate) ? a : b).endDate;
      const minStart = toStr(addDays(toDate(latestPredEnd), 1));
      if (value < minStart) value = minStart;
    }
  }
  task[key] = value;
  task.lastUpdated = new Date().toISOString();
  if (key === 'startDate' || key === 'endDate') {
    enforceAllDependencies(state.selectedTask.catId, state.selectedTask.taskId);
  }
  render(); saveState();
  renderPanel();
}

function addUrlFromPanel() {
  if (!state.selectedTask) return;
  const task = findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task) return;
  const title = document.getElementById('dpUrlTitle')?.value.trim() || 'Link';
  const url = document.getElementById('dpUrlValue')?.value.trim();
  if (!url) return;
  if (!task.urls) task.urls = [];
  task.urls.push({ title, url });
  render(); saveState();
  renderPanel();
}

function removeDep(catId, taskId, predId) {
  const task = findTask(catId, taskId);
  if (!task || !task.dependencies) return;
  task.dependencies = task.dependencies.filter(id => id !== predId);
  render(); saveState();
  renderPanel();
}

function removeUrl(idx) {
  if (!state.selectedTask) return;
  const task = findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task || !task.urls) return;
  task.urls.splice(idx, 1);
  render(); saveState();
  renderPanel();
}

// ========== MODAL ==========
function openModal(html) {
  hideTooltip();
  $modal.innerHTML = html;
  $modalBg.classList.add('open');
}
function closeModal() { $modalBg.classList.remove('open'); }

let _confirmCb = null;
function showConfirmModal(title, message, onConfirm) {
  _confirmCb = onConfirm;
  const html = `
    <div class="modal-header" style="color:var(--red)">${title}<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin:0">${message}</p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-danger" onclick="_confirmCb&&_confirmCb();closeModal()">Delete</button>
    </div>`;
  openModal(html);
}

function pickColor(el) {
  el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
}

// ========== PROJECT NAME ==========
const $projectName = document.getElementById('projectName');

function editProjectName() {
  const span = $projectName;
  const current = state.projectName;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = current;
  input.className = 'project-name-input';
  span.replaceWith(input);
  input.focus();
  input.select();

  function commit() {
    const val = input.value.trim() || current;
    state.projectName = val;
    const newSpan = document.createElement('span');
    newSpan.id = 'projectName';
    newSpan.className = 'project-name';
    newSpan.textContent = val;
    newSpan.title = 'Click to rename';
    newSpan.onclick = editProjectName;
    input.replaceWith(newSpan);
    document.title = `Resource Manager - ${val}`;
    saveState();
  }

  input.addEventListener('blur', commit);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') input.blur();
    if (e.key === 'Escape') { input.value = current; input.blur(); }
  });
}

function applyProjectName() {
  $projectName.textContent = state.projectName;
  document.title = `Resource Manager - ${state.projectName}`;
}

// ========== ADD MENU ==========
function showAddMenu(e) {
  e.stopPropagation();
  const items = [
    { label: '+ New Category', action: () => showAddCatModal() },
    ...state.categories.map(c => ({
      label: `+ Task in "${c.name}"`,
      action: () => showAddTaskModal(c.id)
    }))
  ];
  showCtxMenu(e.clientX, e.clientY, items);
}

// ========== CONTEXT MENU ==========
function showCtxMenu(x, y, items) {
  let html = '';
  for (const item of items) {
    html += `<div class="ctx-item${item.danger ? ' danger' : ''}" data-idx="${items.indexOf(item)}">${item.label}</div>`;
  }
  $ctxMenu.innerHTML = html;
  $ctxMenu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
  $ctxMenu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
  $ctxMenu.classList.add('open');
  $ctxMenu._items = items;
  $ctxMenu.querySelectorAll('.ctx-item').forEach(el => {
    el.addEventListener('click', () => {
      items[Number(el.dataset.idx)].action();
      closeCtxMenu();
    });
  });
}

function closeCtxMenu() { $ctxMenu.classList.remove('open'); }

function showCatCtx(e, catId) {
  e.preventDefault(); e.stopPropagation();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'Add Task', action: () => showAddTaskModal(catId) },
    { label: 'Edit Category', action: () => showEditCatModal(catId) },
    { label: 'Delete Category', danger: true, action: () => deleteCat(catId) }
  ]);
}

function showTaskCtx(e, catId, taskId) {
  e.preventDefault(); e.stopPropagation();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'Edit Task', action: () => showEditTaskModal(catId, taskId) },
    { label: 'Open Details', action: () => openPanel(catId, taskId) },
    { label: 'Delete Task', danger: true, action: () => deleteTask(catId, taskId) }
  ]);
}

document.addEventListener('click', () => closeCtxMenu());
document.addEventListener('contextmenu', (e) => {
  if (!e.target.closest('.s-cat-header') && !e.target.closest('.s-task')) closeCtxMenu();
});

// ========== SIDEBAR REORDER ==========
let reorderState = null;

function onGripMouseDown(e, catId, encodedGroupName, groupIdx) {
  e.stopPropagation();
  e.preventDefault();
  const row = e.target.closest('.s-task');
  if (!row) return;
  reorderState = {
    catId,
    groupName: decodeURIComponent(encodedGroupName),
    fromIdx: groupIdx,
    row,
    startY: e.clientY,
    started: false,
    indicator: null
  };
}

document.addEventListener('mousemove', (e) => {
  if (!reorderState) return;
  if (!reorderState.started) {
    if (Math.abs(e.clientY - reorderState.startY) < 4) return;
    reorderState.started = true;
    reorderState.row.classList.add('drag-ghost');
    document.body.style.cursor = 'grabbing';
  }
  // Find all .s-task rows in the same category
  const catEl = reorderState.row.closest('.s-cat');
  if (!catEl) return;
  const rows = [...catEl.querySelectorAll('.s-task')];
  // Remove old indicator
  if (reorderState.indicator) reorderState.indicator.remove();
  // Find insertion point
  let insertIdx = rows.length;
  for (let i = 0; i < rows.length; i++) {
    const rect = rows[i].getBoundingClientRect();
    if (e.clientY < rect.top + rect.height / 2) {
      insertIdx = i;
      break;
    }
  }
  reorderState.insertIdx = insertIdx;
  // Show indicator line
  const indicator = document.createElement('div');
  indicator.className = 's-reorder-line';
  if (insertIdx < rows.length) {
    rows[insertIdx].style.position = 'relative';
    indicator.style.top = '0px';
    rows[insertIdx].prepend(indicator);
  } else if (rows.length > 0) {
    rows[rows.length - 1].style.position = 'relative';
    indicator.style.bottom = '0px';
    indicator.style.top = 'auto';
    rows[rows.length - 1].append(indicator);
  }
  reorderState.indicator = indicator;
});

document.addEventListener('mouseup', (e) => {
  if (!reorderState) return;
  if (reorderState.indicator) reorderState.indicator.remove();
  reorderState.row.classList.remove('drag-ghost');
  document.body.style.cursor = '';
  if (reorderState.started && reorderState.insertIdx !== undefined) {
    const fromIdx = reorderState.fromIdx;
    let toIdx = reorderState.insertIdx;
    if (fromIdx !== toIdx && fromIdx !== toIdx - 1) {
      reorderGroup(reorderState.catId, reorderState.groupName, fromIdx, toIdx > fromIdx ? toIdx - 1 : toIdx);
    }
  }
  reorderState = null;
});

function reorderGroup(catId, groupName, fromGroupIdx, toGroupIdx) {
  const cat = findCat(catId);
  if (!cat) return;
  // Build ordered list of unique group keys (same as buildGroups logic)
  const groupOrder = [];
  const seen = new Set();
  for (const task of cat.tasks) {
    const gKey = task.group || task.name;
    if (!seen.has(gKey)) {
      seen.add(gKey);
      groupOrder.push(gKey);
    }
  }
  if (fromGroupIdx < 0 || fromGroupIdx >= groupOrder.length) return;
  if (toGroupIdx < 0 || toGroupIdx >= groupOrder.length) return;
  // Reorder the groupOrder array
  const [moved] = groupOrder.splice(fromGroupIdx, 1);
  groupOrder.splice(toGroupIdx, 0, moved);
  // Rebuild cat.tasks in new group order
  const tasksByGroup = new Map();
  for (const gKey of groupOrder) tasksByGroup.set(gKey, []);
  for (const task of cat.tasks) {
    const gKey = task.group || task.name;
    tasksByGroup.get(gKey).push(task);
  }
  cat.tasks = [];
  for (const gKey of groupOrder) {
    cat.tasks.push(...tasksByGroup.get(gKey));
  }
  render();
  saveState();
}

// ========== DRAG: REORDER CATEGORIES ==========
let catReorderState = null;

function onCatGripMouseDown(e, catId, catIdx) {
  e.stopPropagation();
  e.preventDefault();
  const catEl = e.target.closest('.s-cat');
  if (!catEl) return;
  catReorderState = {
    catId,
    fromIdx: catIdx,
    catEl,
    startY: e.clientY,
    started: false,
    indicator: null
  };
}

document.addEventListener('mousemove', (e) => {
  if (!catReorderState) return;
  if (!catReorderState.started) {
    if (Math.abs(e.clientY - catReorderState.startY) < 4) return;
    catReorderState.started = true;
    catReorderState.catEl.classList.add('cat-drag-ghost');
    document.body.style.cursor = 'grabbing';
  }
  const allCats = [...$sidebarBody.querySelectorAll('.s-cat')];
  if (catReorderState.indicator) catReorderState.indicator.remove();
  // Find insertion point
  let insertIdx = allCats.length;
  for (let i = 0; i < allCats.length; i++) {
    const rect = allCats[i].getBoundingClientRect();
    if (e.clientY < rect.top + rect.height / 2) {
      insertIdx = i;
      break;
    }
  }
  catReorderState.insertIdx = insertIdx;
  // Show indicator line
  const indicator = document.createElement('div');
  indicator.className = 's-cat-reorder-line';
  if (insertIdx < allCats.length) {
    allCats[insertIdx].style.position = 'relative';
    indicator.style.top = '0px';
    allCats[insertIdx].prepend(indicator);
  } else if (allCats.length > 0) {
    allCats[allCats.length - 1].style.position = 'relative';
    indicator.style.bottom = '0px';
    indicator.style.top = 'auto';
    allCats[allCats.length - 1].append(indicator);
  }
  catReorderState.indicator = indicator;
});

document.addEventListener('mouseup', () => {
  if (!catReorderState) return;
  if (catReorderState.indicator) catReorderState.indicator.remove();
  catReorderState.catEl.classList.remove('cat-drag-ghost');
  document.body.style.cursor = '';
  if (catReorderState.started && catReorderState.insertIdx !== undefined) {
    const fromIdx = catReorderState.fromIdx;
    let toIdx = catReorderState.insertIdx;
    if (fromIdx !== toIdx && fromIdx !== toIdx - 1) {
      const adjustedTo = toIdx > fromIdx ? toIdx - 1 : toIdx;
      const [moved] = state.categories.splice(fromIdx, 1);
      state.categories.splice(adjustedTo, 0, moved);
      render();
      saveState();
    }
  }
  catReorderState = null;
});

// ========== DRAG: HELPERS ==========
let $dragDateLabel = null;

function showDragLabel(x, y, text) {
  if (!$dragDateLabel) {
    $dragDateLabel = document.createElement('div');
    $dragDateLabel.className = 'drag-date-label';
    document.body.appendChild($dragDateLabel);
  }
  $dragDateLabel.textContent = text;
  $dragDateLabel.style.left = x + 'px';
  $dragDateLabel.style.top = y + 'px';
  $dragDateLabel.style.display = 'block';
}

function hideDragLabel() {
  if ($dragDateLabel) $dragDateLabel.style.display = 'none';
}

function calcBarPos(startDate, endDate) {
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const tStart = diffDays(toStr(state.viewStart), startDate);
  const tDur = diffDays(startDate, endDate) + 1;
  return { left: tStart * dayW, width: Math.max(tDur * dayW - 2, 20) };
}

// ========== DRAG: MOVE/RESIZE TASK BARS ==========
function onBarMouseDown(e, catId, taskId) {
  if (e.button !== 0) return;
  e.stopPropagation();
  e.preventDefault();
  const bar = e.target.closest('.task-bar');
  if (!bar) return;
  const task = findTask(catId, taskId);
  if (!task) return;

  const isLeft = e.target.classList.contains('left');
  const isRight = e.target.classList.contains('right');
  const mode = isLeft ? 'resize-start' : isRight ? 'resize-end' : 'move';

  dragState = {
    catId, taskId, mode,
    startX: e.clientX,
    startY: e.clientY,
    origStart: task.startDate,
    origEnd: task.endDate,
    dayWidth: ZOOM_CFG[state.zoom].dayWidth,
    bar,
    hasMoved: false,
    lastDayDelta: 0
  };
}

// (drag-to-create removed â€” use sidebar "+" buttons to add tasks)

document.addEventListener('mousemove', (e) => {
  // ---- Task bar move/resize ----
  if (dragState) {
    const dx = e.clientX - dragState.startX;

    // Detect if drag threshold crossed
    if (!dragState.hasMoved) {
      if (Math.abs(dx) > 3) {
        dragState.hasMoved = true;
        dragState.bar.classList.add('dragging');
        document.body.classList.add(dragState.mode === 'move' ? 'dragging' : 'resizing');
        hideTooltip();
      } else {
        return;
      }
    }

    const dayDelta = Math.round(dx / dragState.dayWidth);
    if (dayDelta === dragState.lastDayDelta) {
      // Only update label position, skip DOM changes
      const task = findTask(dragState.catId, dragState.taskId);
      if (task) {
        const dur = diffDays(task.startDate, task.endDate) + 1;
        showDragLabel(e.clientX, dragState.bar.getBoundingClientRect().top,
          `${formatDateShort(toDate(task.startDate))} \u2192 ${formatDateShort(toDate(task.endDate))}  (${dur}d)`);
      }
      return;
    }
    dragState.lastDayDelta = dayDelta;

    // Compute new dates
    let newStart, newEnd;
    if (dragState.mode === 'move') {
      newStart = toStr(addDays(toDate(dragState.origStart), dayDelta));
      newEnd = toStr(addDays(toDate(dragState.origEnd), dayDelta));
    } else if (dragState.mode === 'resize-start') {
      newStart = toStr(addDays(toDate(dragState.origStart), dayDelta));
      newEnd = dragState.origEnd;
      if (toDate(newStart) > toDate(newEnd)) newStart = newEnd;
    } else {
      newStart = dragState.origStart;
      newEnd = toStr(addDays(toDate(dragState.origEnd), dayDelta));
      if (toDate(newEnd) < toDate(newStart)) newEnd = newStart;
    }

    // Clamp: dependent task cannot start before predecessor ends
    const dragTask = findTask(dragState.catId, dragState.taskId);
    if (dragTask && dragTask.dependencies && dragTask.dependencies.length > 0) {
      const cat = findCat(dragState.catId);
      if (cat) {
        let latestPredEnd = null;
        for (const predId of dragTask.dependencies) {
          const pred = cat.tasks.find(t => t.id === predId);
          if (pred) {
            const pe = toDate(pred.endDate);
            if (!latestPredEnd || pe > latestPredEnd) latestPredEnd = pe;
          }
        }
        if (latestPredEnd) {
          const minStart = toStr(addDays(latestPredEnd, 1));
          if (newStart < minStart) {
            if (dragState.mode === 'move') {
              const shift = diffDays(newStart, minStart);
              newStart = minStart;
              newEnd = toStr(addDays(toDate(newEnd), shift));
            } else {
              newStart = minStart;
            }
          }
        }
      }
    }

    // Update bar position directly (no re-render)
    const pos = calcBarPos(newStart, newEnd);
    dragState.bar.style.left = pos.left + 'px';
    dragState.bar.style.width = pos.width + 'px';

    // Store computed dates on dragState for commit on mouseup
    dragState.newStart = newStart;
    dragState.newEnd = newEnd;

    // Show floating date label
    const dur = diffDays(newStart, newEnd) + 1;
    showDragLabel(e.clientX, dragState.bar.getBoundingClientRect().top,
      `${formatDateShort(toDate(newStart))} \u2192 ${formatDateShort(toDate(newEnd))}  (${dur}d)`);
  }

  // ---- Dependency bubble drag ----
  if (depDragState) {
    if (!depDragState.started) {
      depDragState.started = true;
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:500';
      svg.innerHTML = `<line x1="${depDragState.startX}" y1="${depDragState.startY}" x2="${e.clientX}" y2="${e.clientY}" stroke="#6b7280" stroke-width="2" stroke-dasharray="6,3"/>`;
      document.body.appendChild(svg);
      depDragState.svgLine = svg;
    }
    if (depDragState.svgLine) {
      const line = depDragState.svgLine.querySelector('line');
      line.setAttribute('x2', e.clientX);
      line.setAttribute('y2', e.clientY);
    }
  }
});

document.addEventListener('mouseup', (e) => {
  if (dragState) {
    const wasClick = !dragState.hasMoved;
    const catId = dragState.catId;
    const taskId = dragState.taskId;

    // Clean up visual state
    dragState.bar.classList.remove('dragging');
    document.body.classList.remove('dragging', 'resizing');
    hideDragLabel();

    if (wasClick) {
      dragState = null;
      openPanel(catId, taskId);
    } else {
      // Commit the date changes to state
      const task = findTask(catId, taskId);
      if (task && dragState.newStart && dragState.newEnd) {
        task.startDate = dragState.newStart;
        task.endDate = dragState.newEnd;
        enforceAllDependencies(catId, taskId);
      }
      dragState = null;
      render();
      saveState();
    }
  }
  if (depDragState) {
    if (depDragState.svgLine) depDragState.svgLine.remove();
    if (depDragState.started) {
      const el = document.elementFromPoint(e.clientX, e.clientY);
      const targetBar = el?.closest('.task-bar');
      if (targetBar) {
        const toTaskId = targetBar.dataset.task;
        const toCatId = targetBar.dataset.cat;
        if (toTaskId && toTaskId !== depDragState.fromTaskId && toCatId === depDragState.catId) {
          const fromTask = findTask(depDragState.catId, depDragState.fromTaskId);
          const toTask = findTask(toCatId, toTaskId);
          if (fromTask && toTask && (fromTask.group || fromTask.name) === (toTask.group || toTask.name)) {
            if (!wouldCreateCycle(depDragState.catId, depDragState.fromTaskId, toTaskId)) {
              if (!toTask.dependencies) toTask.dependencies = [];
              if (!toTask.dependencies.includes(depDragState.fromTaskId)) {
                toTask.dependencies.push(depDragState.fromTaskId);
                enforceDependency(depDragState.catId, depDragState.fromTaskId, toTaskId);
                render(); saveState();
              }
            }
          }
        }
      }
    }
    depDragState = null;
  }
});

// ========== DEPENDENCIES ==========
function enforceDependency(catId, predId, depId) {
  const pred = findTask(catId, predId);
  const dep = findTask(catId, depId);
  if (!pred || !dep) return;
  const minStart = toStr(addDays(toDate(pred.endDate), 1));
  if (toDate(dep.startDate) < toDate(minStart)) {
    const shift = diffDays(dep.startDate, minStart);
    dep.startDate = minStart;
    dep.endDate = toStr(addDays(toDate(dep.endDate), shift));
    cascadeDependencies(catId, dep.id);
  }
}

function cascadeDependencies(catId, movedTaskId) {
  const cat = findCat(catId);
  if (!cat) return;
  for (const task of cat.tasks) {
    if (task.dependencies && task.dependencies.includes(movedTaskId)) {
      enforceDependency(catId, movedTaskId, task.id);
    }
  }
}

function enforceAllDependencies(catId, taskId) {
  cascadeDependencies(catId, taskId);
}

function wouldCreateCycle(catId, fromId, toId) {
  const visited = new Set();
  function dfs(taskId) {
    if (taskId === toId) return true;
    if (visited.has(taskId)) return false;
    visited.add(taskId);
    const task = findTask(catId, taskId);
    if (!task || !task.dependencies) return false;
    for (const depId of task.dependencies) {
      if (dfs(depId)) return true;
    }
    return false;
  }
  return dfs(fromId);
}

function onDepBubbleMouseDown(e, catId, taskId) {
  e.stopPropagation();
  e.preventDefault();
  const bar = e.target.closest('.task-bar');
  if (!bar) return;
  const barRect = bar.getBoundingClientRect();
  depDragState = {
    catId,
    fromTaskId: taskId,
    startX: barRect.right,
    startY: barRect.top + barRect.height / 2,
    svgLine: null,
    started: false
  };
}

function showDepCtx(e, catId, fromId, toId) {
  e.preventDefault();
  e.stopPropagation();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'Remove dependency', danger: true, action: () => {
      const depTask = findTask(catId, toId);
      if (depTask && depTask.dependencies) {
        depTask.dependencies = depTask.dependencies.filter(id => id !== fromId);
        render(); saveState();
      }
    }}
  ]);
}

// ========== TOOLTIP ==========
function showBarTooltip(e, catId, taskId) {
  if ($panelOverlay.classList.contains('open') || $modalBg.classList.contains('open') || $aiPanel.classList.contains('open')) return;
  const task = findTask(catId, taskId);
  const cat = findCat(catId);
  if (!task || !cat) return;
  const dur = diffDays(task.startDate, task.endDate) + 1;
  $tooltip.textContent = `${task.name} | ${formatDateShort(toDate(task.startDate))} - ${formatDateShort(toDate(task.endDate))} (${dur}d)`;
  $tooltip.style.display = 'block';
  positionTooltip(e);
}

function positionTooltip(e) {
  $tooltip.style.left = e.clientX + 'px';
  $tooltip.style.top = (e.clientY - 36) + 'px';
}

function hideTooltip() { $tooltip.style.display = 'none'; }

document.addEventListener('mousemove', (e) => {
  if ($tooltip.style.display === 'block') positionTooltip(e);
});

// ========== KEYBOARD ==========
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closePanel();
    closeCtxMenu();
    closeAI();
  }
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowLeft') navigate(-1);
  if (e.key === 'ArrowRight') navigate(1);
  if (e.key === 't' || e.key === 'T') goToday();
});

// ========== DARK MODE ==========
function toggleDarkMode() {
  const isDark = document.documentElement.classList.toggle('dark');
  state.darkMode = isDark;
  updateDarkModeIcon(isDark);
  localStorage.setItem('rm_darkMode', isDark ? '1' : '0');
  render();
}

function updateDarkModeIcon(isDark) {
  const btn = document.getElementById('darkModeBtn');
  if (!btn) return;
  btn.innerHTML = isDark
    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
    : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0012 21a9 9 0 009-8.21z"/></svg>';
  btn.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
}

function initDarkMode() {
  const saved = localStorage.getItem('rm_darkMode');
  const isDark = saved === '1';
  state.darkMode = isDark;
  if (isDark) document.documentElement.classList.add('dark');
  updateDarkModeIcon(isDark);
}

// ========== AI PANEL ==========
function toggleAI() {
  if ($aiPanel.classList.contains('open')) closeAI();
  else openAI();
}

function openAI() {
  closePanel();
  renderAIPanel();
  $aiPanel.classList.add('open');
}

function closeAI() { $aiPanel.classList.remove('open'); }

function renderAIPanel() {
  let msgsHtml = '';
  if (!state.aiKey) {
    const gemSel = state.aiProvider === 'gemini' ? ' checked' : '';
    const custSel = state.aiProvider === 'custom' ? ' checked' : '';
    msgsHtml = `<div class="ai-key-setup">
      <div class="ai-setup-title">AI Assistant Setup</div>
      <div class="ai-setup-desc">Choose a provider and enter your API key to get started.</div>
      <div class="ai-provider-group">
        <label class="ai-provider-option${state.aiProvider === 'gemini' ? ' selected' : ''}">
          <input type="radio" name="aiProvider" value="gemini"${gemSel} onchange="state.aiProvider='gemini';renderAIPanel()">
          <div class="ai-provider-label"><span class="ai-provider-name">Google Gemini</span><span class="ai-provider-tag">Free tier available</span></div>
        </label>
        <label class="ai-provider-option${state.aiProvider === 'custom' ? ' selected' : ''}">
          <input type="radio" name="aiProvider" value="custom"${custSel} onchange="state.aiProvider='custom';renderAIPanel()">
          <div class="ai-provider-label"><span class="ai-provider-name">Custom LLM</span><span class="ai-provider-tag">OpenAI, Anthropic, Groq, Ollama, etc.</span></div>
        </label>
      </div>
      ${state.aiProvider === 'gemini' ? `
        <div class="ai-setup-fields">
          <input id="aiKeyInput" type="password" placeholder="Paste your Gemini API key">
        </div>
        <div class="ai-setup-action">
          <button class="btn btn-primary" onclick="saveAIKey()">Save Key</button>
          <span class="ai-setup-hint"><a href="https://aistudio.google.com/app/apikey" target="_blank">Get a free API key from Google AI Studio &rarr;</a></span>
        </div>
      ` : `
        <div class="ai-setup-fields">
          <input id="aiCustomEndpointInput" type="text" placeholder="API Endpoint URL" value="${esc(state.aiCustomEndpoint)}">
          <input id="aiCustomModelInput" type="text" placeholder="Model name (e.g. gpt-4o)" value="${esc(state.aiCustomModel)}">
          <input id="aiKeyInput" type="password" placeholder="API Key">
        </div>
        <div class="ai-setup-action">
          <button class="btn btn-primary" onclick="saveAIKey()">Save Key</button>
          <span class="ai-setup-hint">Works with any OpenAI-compatible API endpoint</span>
        </div>
      `}
    </div>`;
  } else {
    if (state.aiMessages.length === 0) {
      msgsHtml = `<div class="ai-msg system">AI Assistant ready. Ask questions about your projects, request schedule analysis, or get resource allocation suggestions.</div>`;
    }
    for (const msg of state.aiMessages) {
      msgsHtml += `<div class="ai-msg ${msg.role}">${escNl(msg.text)}</div>`;
    }
  }

  $aiPanel.innerHTML = `
    <div class="ai-header">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v3a4 4 0 01-8 0v-3H7a3 3 0 01-3-3v-2a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg> AI Assistant</h3>
      <div style="display:flex;gap:4px">
        ${state.aiKey ? `<button class="s-action" onclick="state.aiKey='';state.aiProvider='gemini';state.aiCustomEndpoint='';state.aiCustomModel='';state.aiMessages=[];saveState();renderAIPanel()" title="Reset API Key">&#9881;</button>` : ''}
        <button class="s-action" onclick="closeAI()">&#10005;</button>
      </div>
    </div>
    <div class="ai-messages" id="aiMessages">${msgsHtml}</div>
    ${state.aiKey ? `<div class="ai-input-row">
      <input class="ai-input" id="aiInput" placeholder="Ask about your projects..." onkeydown="if(event.key==='Enter')sendAI()">
      <button class="btn btn-primary btn-icon" onclick="sendAI()">&#10148;</button>
    </div>` : ''}`;

  // Scroll to bottom
  setTimeout(() => {
    const el = document.getElementById('aiMessages');
    if (el) el.scrollTop = el.scrollHeight;
  }, 50);
}

function escNl(s) {
  return esc(s).replace(/\n/g, '<br>');
}

function saveAIKey() {
  const key = document.getElementById('aiKeyInput')?.value.trim();
  if (!key) return;
  state.aiKey = key;
  if (state.aiProvider === 'custom') {
    state.aiCustomEndpoint = document.getElementById('aiCustomEndpointInput')?.value.trim() || '';
    state.aiCustomModel = document.getElementById('aiCustomModelInput')?.value.trim() || '';
    if (!state.aiCustomEndpoint) { alert('Please enter an API endpoint URL.'); return; }
  }
  saveState();
  renderAIPanel();
}

async function sendAI() {
  const input = document.getElementById('aiInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;

  // Validate API key is set
  if (!state.aiKey) {
    state.aiMessages.push({ role: 'user', text });
    state.aiMessages.push({ role: 'assistant', text: 'Please set up your API key in the AI Settings above before sending messages.' });
    saveState(); renderAIPanel();
    return;
  }
  if (state.aiProvider === 'custom' && !state.aiCustomEndpoint) {
    state.aiMessages.push({ role: 'user', text });
    state.aiMessages.push({ role: 'assistant', text: 'Please enter your custom LLM endpoint URL in the AI Settings above.' });
    saveState(); renderAIPanel();
    return;
  }

  input.value = '';
  state.aiMessages.push({ role: 'user', text });
  renderAIPanel();

  // Build context
  const projectCtx = state.categories.map(c => {
    const tasks = c.tasks.map(t => {
      const dur = diffDays(t.startDate, t.endDate) + 1;
      return `  - ${t.name}: ${t.startDate} to ${t.endDate} (${dur} days), Status: ${t.status}, Links: ${(t.urls||[]).length}`;
    }).join('\n');
    return `Category: ${c.name}\n${tasks || '  (no tasks)'}`;
  }).join('\n\n');

  const today = toStr(todayDate());
  const systemPrompt = `You are an AI assistant for a project resource manager application. Today's date is ${today}. Here is the current project data:\n\n${projectCtx}\n\nHelp the user with project scheduling, resource analysis, timeline calculations, budget summaries, and planning suggestions. Be concise and practical. Format numbers clearly. If asked for calculations, show your work briefly.`;

  try {
    let reply;
    if (state.aiProvider === 'custom' && state.aiCustomEndpoint) {
      // Custom LLM (OpenAI-compatible endpoint)
      const endpoint = state.aiCustomEndpoint.replace(/\/+$/, '');
      const url = endpoint.includes('/chat/completions') ? endpoint : endpoint + '/chat/completions';
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${state.aiKey}`
        },
        body: JSON.stringify({
          model: state.aiCustomModel || 'gpt-3.5-turbo',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: text }
          ],
          max_tokens: 2048
        })
      });
      if (!response.ok) {
        const errData = await response.json().catch(() => ({}));
        throw new Error(errData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      reply = data?.choices?.[0]?.message?.content || 'Sorry, I could not generate a response.';
    } else {
      // Google Gemini (free)
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${state.aiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              { role: 'user', parts: [{ text: systemPrompt + '\n\nUser question: ' + text }] }
            ]
          })
        }
      );
      const data = await response.json();
      reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
    }
    state.aiMessages.push({ role: 'assistant', text: reply });
  } catch (err) {
    state.aiMessages.push({ role: 'assistant', text: 'Error: ' + err.message + '. Please check your API key and settings.' });
  }

  saveState();
  renderAIPanel();
}

// ========== INIT ==========
function init() {
  loadState();
  initDarkMode();
  if (state.categories.length === 0) loadSampleData();

  applyProjectName();

  // Set initial view
  state.zoom = 'weeks';
  $zoomSelect.value = 'weeks';
  goToday();
}

// Handle enter in modal inputs
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && $modalBg.classList.contains('open')) {
    const btn = $modal.querySelector('.modal-footer .btn-primary');
    if (btn && e.target.tagName !== 'TEXTAREA') btn.click();
  }
});

init();
</script>
</body>
</html>
