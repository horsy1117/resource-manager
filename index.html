<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resource Manager - Project Plan</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --sidebar-w:250px;
  --topbar-h:56px;
  --header-h:48px;
  --row-h:34px;
  --cat-row-h:32px;
  --border:#e5e7eb;
  --bg:#ffffff;
  --bg2:#f9fafb;
  --bg-weekend:rgba(0,0,0,.07);
  --text:#1f2937;
  --text2:#6b7280;
  --text3:#9ca3af;
  --blue:#3b82f6;
  --blue-light:#dbeafe;
  --red:#ef4444;
  --green:#10b981;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --day-w:120px;
  --border-subtle:#f3f4f6;
  --bg3:#f3f4f6;
  --bg-hover:#f9fafb;
  --shadow-overlay:rgba(0,0,0,.3);
  --shadow-deep:0 20px 60px rgba(0,0,0,.15);
  --shadow-panel:-4px 0 24px rgba(0,0,0,.1);
  --surface-elevated:#ffffff;
  --surface-elevated-border:var(--border);
  --focus-ring:0 0 0 3px rgba(59,130,246,.1);
  --scrollbar-track:#f9fafb;
  --scrollbar-thumb:#d1d5db;
  --scrollbar-thumb-hover:#9ca3af;
  --bar-shadow:0 1px 3px rgba(0,0,0,.1);
  --bar-shadow-hover:0 2px 8px rgba(0,0,0,.2);
  --dep-arrow-color:#6b7280;
  --tooltip-bg:#1f2937;
  --tooltip-shadow:0 2px 8px rgba(0,0,0,.2);
  --btn-hover-border:#d1d5db;
  --btn-primary-hover:#2563eb;
  --btn-danger-hover-bg:#fef2f2;
  --cat-header-hover:brightness(0.97);
  --row-hover-bg:rgba(59,130,246,.02);
  --dep-dependent-bg:#fef3c7;
  --dep-dependent-border:#f59e0b;
  --dep-dependent-text:#92400e;
  --dep-master-bg:#bfdbfe;
  --dep-master-border:#3b82f6;
  --dep-master-text:#1e3a8a;
  --dep-both-bg:#ddd6fe;
  --dep-both-border:#8b5cf6;
  --dep-both-text:#4c1d95;
  --ai-msg-system-bg:#fef3c7;
  --ai-msg-system-border:transparent;
  --ai-msg-system-text:#92400e;
  --ai-provider-selected-border:var(--blue);
  --mark-bg:rgba(59,130,246,.15);
  --mark-color:var(--blue);
  --input-bg:var(--bg);
  --input-color:var(--text);
  --input-border:var(--border);
  --input-disabled-bg:var(--bg2);
  --color-scheme:light;
}
html.dark{
  --border:#253040;
  --border-subtle:#1b2535;
  --bg:#0f1419;
  --bg2:#161d27;
  --bg-weekend:rgba(255,255,255,.025);
  --text:#c9d1d9;
  --text2:#7d8590;
  --text3:#4d5768;
  --blue:#58a6ff;
  --blue-light:#131d2e;
  --red:#f07070;
  --green:#3fb68b;
  --shadow:0 2px 8px rgba(0,0,0,.5);
  --bg3:#111820;
  --bg-hover:#1e2a3a;
  --shadow-overlay:rgba(0,0,0,.55);
  --shadow-deep:0 20px 60px rgba(0,0,0,.5);
  --shadow-panel:-4px 0 24px rgba(0,0,0,.4);
  --surface-elevated:#1a2230;
  --surface-elevated-border:#253040;
  --focus-ring:0 0 0 3px rgba(88,166,255,.12);
  --scrollbar-track:#111820;
  --scrollbar-thumb:#2a3545;
  --scrollbar-thumb-hover:#35445a;
  --bar-shadow:0 1px 3px rgba(0,0,0,.3);
  --bar-shadow-hover:0 2px 10px rgba(0,0,0,.4);
  --dep-arrow-color:#4d5768;
  --tooltip-bg:#253040;
  --tooltip-shadow:0 2px 8px rgba(0,0,0,.4);
  --btn-hover-border:#354050;
  --btn-primary-hover:#4088e0;
  --btn-danger-hover-bg:rgba(240,112,112,.1);
  --cat-header-hover:brightness(1.08);
  --row-hover-bg:rgba(88,166,255,.04);
  --dep-dependent-bg:rgba(245,158,11,.08);
  --dep-dependent-border:rgba(245,158,11,.3);
  --dep-dependent-text:#fbbf24;
  --dep-master-bg:rgba(88,166,255,.08);
  --dep-master-border:rgba(88,166,255,.3);
  --dep-master-text:#79b8ff;
  --dep-both-bg:rgba(139,92,246,.08);
  --dep-both-border:rgba(139,92,246,.3);
  --dep-both-text:#b4a0f0;
  --ai-msg-system-bg:rgba(245,158,11,.08);
  --ai-msg-system-border:rgba(245,158,11,.2);
  --ai-msg-system-text:#fbbf24;
  --ai-provider-selected-border:rgba(88,166,255,.4);
  --mark-bg:rgba(88,166,255,.15);
  --mark-color:#58a6ff;
  --input-bg:var(--bg2);
  --input-color:var(--text);
  --input-border:var(--border);
  --input-disabled-bg:#111820;
  --color-scheme:dark;
}

html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;color:var(--text);background:var(--bg)}
input,textarea,select{background:var(--input-bg);color:var(--input-color);border-color:var(--input-border)}
input[type="date"]{color-scheme:var(--color-scheme)}

/* ===== TOPBAR ===== */
.topbar{height:var(--topbar-h);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:var(--bg);z-index:100;position:relative}
.topbar h1{font-size:16px;font-weight:600;display:flex;flex-direction:column;align-items:flex-start;gap:0}
.topbar-title-row{display:flex;align-items:center;gap:6px}
.org-name{font-size:11px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;border-radius:3px;padding:0 3px;transition:background .15s;line-height:1.4}
.org-name:hover{background:var(--bg2);color:var(--text2)}
.org-name-input{font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;border:1px solid var(--blue);border-radius:3px;padding:0 3px;outline:none;background:var(--bg);color:var(--text);font-family:inherit;line-height:1.4}
.project-name{cursor:pointer;border-radius:4px;padding:0 4px;transition:background .15s}
.project-name:hover{background:var(--bg2)}
.project-name-input{font-size:16px;font-weight:600;border:1px solid var(--blue);border-radius:4px;padding:0 4px;outline:none;background:var(--bg);color:var(--text);font-family:inherit}
.portfolio-title-wrap{display:flex;align-items:center;gap:2px;cursor:pointer;border-radius:4px;padding:0 4px;transition:background .15s}
.portfolio-title-wrap:hover{background:var(--bg2)}
.portfolio-chevron{width:14px;height:14px;color:var(--text2);flex-shrink:0;transition:transform .15s}
.portfolio-title-wrap:hover .portfolio-chevron{color:var(--text)}
.portfolio-dropdown{position:absolute;top:100%;left:0;min-width:220px;background:var(--surface-elevated);border:1px solid var(--surface-elevated-border);border-radius:8px;box-shadow:var(--shadow);z-index:1000;padding:4px 0;max-height:320px;overflow-y:auto}
.portfolio-item{padding:6px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text);transition:background .1s}
.portfolio-item:hover{background:var(--bg2)}
.portfolio-item.active{font-weight:600;color:var(--blue)}
.portfolio-item .check-icon{width:14px;flex-shrink:0;color:var(--blue)}
.portfolio-divider{height:1px;background:var(--border);margin:4px 0}
.portfolio-action{padding:6px 12px;cursor:pointer;font-size:13px;color:var(--blue);transition:background .1s}
.portfolio-action:hover{background:var(--bg2)}
.topbar-controls{display:flex;align-items:center;gap:6px}
.btn{border:1px solid var(--border);background:var(--bg);border-radius:5px;padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text);display:inline-flex;align-items:center;gap:4px;transition:all .15s}
.btn:hover{background:var(--bg2);border-color:var(--btn-hover-border)}
.btn-primary{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn-primary:hover{background:var(--btn-primary-hover)}
.btn-icon{padding:4px 6px;min-width:28px;justify-content:center}
.btn-danger{color:var(--red);border-color:var(--red)}
.btn-danger:hover{background:var(--btn-danger-hover-bg)}
.zoom-select{border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;background:var(--bg);cursor:pointer;color:var(--text)}
.today-btn{font-weight:500}

/* ===== MAIN LAYOUT ===== */
.main-area{display:flex;flex:1;overflow:hidden;height:calc(100vh - var(--topbar-h))}
.sidebar{width:var(--sidebar-w);min-width:120px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg);z-index:10;position:relative}
.sidebar-resize{position:absolute;top:0;right:-3px;width:6px;height:100%;cursor:col-resize;z-index:20;background:transparent}
.sidebar-resize:hover,.sidebar-resize.active{background:var(--blue);opacity:.3}
.sidebar-header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;align-items:flex-end;padding:0 10px 6px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;background:var(--bg)}
.sidebar-body{flex:1;overflow-y:auto;overflow-x:hidden}
.sidebar-body::-webkit-scrollbar{width:0}

/* ===== SIDEBAR ROWS ===== */
.s-cat{}
.s-cat.cat-drag-ghost{opacity:.4}
.s-cat-reorder-line{position:absolute;left:0;right:0;height:3px;background:var(--blue);z-index:20;pointer-events:none;border-radius:1px}
.s-cat-header{height:var(--cat-row-h);display:flex;align-items:center;padding:0 8px 0 0;cursor:pointer;position:relative;background:var(--bg);border-bottom:1px solid var(--border)}
.s-cat-header:hover{filter:var(--cat-header-hover)}
.s-cat-grip{width:20px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:grab;opacity:0;transition:opacity .15s;color:var(--text3)}
.s-cat-header:hover .s-cat-grip{opacity:.5}
.s-cat-grip:hover{opacity:1!important}
.s-cat-grip svg{pointer-events:none}
.s-cat-color{width:4px;height:100%;flex-shrink:0;border-radius:0 2px 2px 0}
.s-cat-toggle{width:28px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text3);font-size:10px;transition:transform .2s}
.s-cat-toggle.collapsed{transform:rotate(-90deg)}
.s-cat-name{flex:1;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.s-num{color:var(--text3);font-weight:500;margin-right:5px;font-size:11px}
.s-cat-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s}
.s-cat-header:hover .s-cat-actions{opacity:1}
.s-action{width:24px;height:24px;border:none;background:transparent;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:12px}
.s-action:hover{background:var(--border);color:var(--text)}

.s-task{min-height:var(--row-h);display:flex;align-items:center;padding:0 6px 0 8px;border-bottom:1px solid var(--border-subtle);position:relative;cursor:default}
.s-task:hover{background:var(--bg2)}
.s-task.row-focused{background:rgba(59,130,246,.07);box-shadow:inset 2px 0 0 #3b82f6}
.s-task.row-focused:hover{background:rgba(59,130,246,.11)}
.s-task-grip{width:16px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:grab;opacity:0;transition:opacity .15s;color:var(--text3);font-size:10px;letter-spacing:1px}
.s-task:hover .s-task-grip{opacity:.6}
.s-task-grip:hover{opacity:1!important}
.s-task-grip svg{pointer-events:none}
.s-reorder-line{position:absolute;left:28px;right:8px;height:2px;background:var(--blue);z-index:20;pointer-events:none;border-radius:1px}
.s-task.drag-ghost{opacity:.4}
.s-task.selected{background:var(--blue-light)}
.s-task-dot{width:7px;height:7px;border-radius:50%;margin-right:6px;flex-shrink:0}
.s-task-name{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:3px}
.s-task-name-link{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;border-radius:2px;padding:1px 2px;margin:-1px -2px}
.s-task-name-link:hover{text-decoration:underline;text-underline-offset:2px}
.s-task-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s}
.s-task:hover .s-task-actions{opacity:1}

.s-add-row{height:24px;display:flex;align-items:center;padding:0 6px 0 28px;cursor:pointer;color:var(--text3);font-size:11px;gap:4px;border-bottom:1px solid var(--border-subtle)}
.s-add-row:hover{background:var(--bg2);color:var(--blue)}

.s-add-cat{height:32px;display:flex;align-items:center;padding:0 12px;cursor:pointer;color:var(--text3);font-size:12px;gap:6px;border-bottom:1px solid var(--border)}
.s-add-cat:hover{background:var(--bg2);color:var(--blue)}

/* ===== TIMELINE ===== */
.timeline{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
.timeline-header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;background:var(--bg);flex-shrink:0;position:relative}
.t-header-row{display:flex;height:50%}
.t-header-row.row1{border-bottom:1px solid var(--border-subtle)}
.t-group{display:flex;align-items:center;font-size:12px;color:var(--text2);font-weight:500;border-right:1px solid var(--border-subtle);white-space:nowrap;overflow:hidden;position:relative}
.t-group-label{position:relative;padding:0 4px;z-index:1}
.t-col{display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text3);border-right:1px solid var(--border-subtle);white-space:nowrap;flex-shrink:0;position:relative}
.t-col.today{color:var(--blue);font-weight:700}
.t-col.today::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:22px;height:22px;background:var(--blue);border-radius:50%;z-index:-1;opacity:.1}
.t-col.weekend{background:var(--bg-weekend)}

.timeline-body-wrap{flex:1;overflow:auto;position:relative}
.timeline-body{position:relative;min-height:100%}
.t-grid{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0}
.t-month-band{position:absolute;top:0;bottom:0;pointer-events:none}
.t-weekend{position:absolute;top:0;bottom:0;background:var(--bg-weekend)}
.t-today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--blue);z-index:5;opacity:.6}
.t-gridline{position:absolute;top:0;bottom:0;width:1px;background:var(--border);opacity:.5}

.t-rows{position:relative;z-index:1}
.t-row{height:var(--row-h);position:relative;border-bottom:1px solid var(--border-subtle)}
.t-row.cat-row{height:var(--cat-row-h);background:var(--bg2);border-bottom:1px solid var(--border)}
.t-row.task-row{cursor:default}
.t-row.task-row:hover{background:var(--row-hover-bg)}
.t-row.task-row.row-focused{background:rgba(59,130,246,.05)}
.t-row.task-row.row-focused:hover{background:rgba(59,130,246,.08)}

/* ===== GHOST BAR (drag-to-create) ===== */
.ghost-bar{position:absolute;height:20px;top:4px;border-radius:6px;opacity:.35;pointer-events:none;z-index:5}
.t-row.task-row.create-hover{cursor:crosshair}

/* ===== TASK BARS ===== */
.task-bar{position:absolute;top:6px;height:calc(var(--row-h) - 14px);border-radius:6px;display:flex;align-items:center;padding:0 8px;font-size:12px;font-weight:500;color:#fff;cursor:grab;z-index:2;transition:box-shadow .15s,filter .15s;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;user-select:none;min-width:24px;box-shadow:var(--bar-shadow)}
.task-bar:hover{box-shadow:var(--bar-shadow-hover);filter:brightness(1.05);z-index:3}
.task-bar .resize-handle{position:absolute;top:0;width:10px;height:100%;cursor:col-resize;z-index:1}
.task-bar .resize-handle.left{left:-2px}
.task-bar .resize-handle.right{right:-2px}
.task-bar-label{position:relative;z-index:0;pointer-events:none;text-shadow:0 1px 2px rgba(0,0,0,.2)}
.task-bar .status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;pointer-events:none;box-shadow:0 0 0 1.5px rgba(255,255,255,.5);margin-right:2px}
.task-bar-dates{position:absolute;top:-16px;left:0;font-size:10px;color:var(--text3);white-space:nowrap;pointer-events:none;font-weight:400}
body.dragging{cursor:grabbing!important}
body.dragging *{cursor:grabbing!important}
body.resizing{cursor:col-resize!important}
body.resizing *{cursor:col-resize!important}
.task-bar.dragging{opacity:.85;z-index:10;box-shadow:0 4px 16px rgba(0,0,0,.25);transition:none}
.drag-date-label{position:fixed;background:var(--tooltip-bg);color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;z-index:600;pointer-events:none;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.2);transform:translate(-50%,-100%);margin-top:-8px}

/* ===== MILESTONE DIAMOND ===== */
.milestone-diamond{position:absolute;z-index:2;cursor:grab;user-select:none}
.milestone-diamond .diamond-shape{width:16px;height:16px;transform:rotate(45deg);border-radius:2px;box-shadow:var(--bar-shadow);transition:box-shadow .15s,filter .15s}
.milestone-diamond:hover .diamond-shape{box-shadow:var(--bar-shadow-hover);filter:brightness(1.05)}
.milestone-diamond:hover .dep-bubble{opacity:1}
.milestone-diamond .dep-bubble{position:absolute;right:-10px;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;background:var(--dep-arrow-color);border:2px solid #fff;cursor:crosshair;opacity:0;transition:opacity .15s;z-index:5}
.milestone-diamond .milestone-label{position:absolute;left:22px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;pointer-events:none}
.milestone-diamond.dragging{opacity:.85;z-index:10}

/* ===== DEPENDENCY BUBBLE ===== */
.dep-bubble{position:absolute;right:-3px;top:50%;transform:translateY(-50%);width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.7);border:1.5px solid rgba(255,255,255,.9);cursor:crosshair;z-index:4;opacity:0;transition:opacity .15s}
.task-bar:hover .dep-bubble{opacity:1}
.dep-bubble:hover{background:#fff;transform:translateY(-50%) scale(1.4)}

/* ===== DEPENDENCY ARROWS ===== */
.dep-svg-overlay{position:absolute;top:0;left:0;pointer-events:none;z-index:3;overflow:visible}
.dep-arrow{fill:none;stroke:var(--dep-arrow-color);stroke-width:1.5;pointer-events:stroke;cursor:pointer}
.dep-arrow:hover{stroke:var(--red);stroke-width:2.5}

/* ===== URL LIST ===== */
.url-list{display:flex;flex-direction:column;gap:6px}
.url-item{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg2);border-radius:6px;font-size:13px;border:1px solid var(--border)}
.url-item a{color:var(--blue);text-decoration:none;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.url-item a:hover{text-decoration:underline}
.url-item-title{font-weight:500;color:var(--text);margin-right:4px;white-space:nowrap}
.url-item .s-action{flex-shrink:0}
.url-add-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.url-add-inputs{display:flex;gap:6px}
.url-add-inputs input{flex:1;border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px}
.url-add-inputs input:focus{outline:none;border-color:var(--blue)}
.url-add-btn{align-self:flex-start}

/* ===== DETAIL PANEL ===== */
.panel-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.15);z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.panel-overlay.open{opacity:1;pointer-events:auto}
.detail-panel{position:fixed;top:0;right:0;width:440px;height:100%;background:var(--bg);z-index:201;box-shadow:var(--shadow-panel);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.detail-panel.open{transform:translateX(0)}
.dp-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.dp-breadcrumb{font-size:12px;color:var(--text3)}
.dp-title-row{display:flex;align-items:center;gap:10px;padding:16px 20px}
.dp-color-dot{width:28px;height:28px;border-radius:50%;flex-shrink:0}
.dp-title-input{flex:1;font-size:18px;font-weight:600;border:none;outline:none;background:transparent;color:var(--text)}
.dp-body{flex:1;overflow-y:auto;padding:0 20px 20px}
.dp-field{margin-bottom:16px}
.dp-label{font-size:12px;color:var(--text3);margin-bottom:4px;display:block}
.dp-input,.dp-select,.dp-textarea{width:100%;border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:13px;font-family:inherit;color:var(--text);background:var(--bg)}
.dp-input:focus,.dp-select:focus,.dp-textarea:focus{outline:none;border-color:var(--blue);box-shadow:var(--focus-ring)}
.dp-textarea{min-height:80px;resize:vertical}
.dp-date-row{display:flex;gap:8px;align-items:center}
.dp-date-row span{color:var(--text3)}
.dp-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:8px}

/* ===== MODAL ===== */
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--shadow-overlay);z-index:300;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--surface-elevated);border:1px solid var(--surface-elevated-border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:440px;max-width:92vw;max-height:90vh;overflow-y:auto}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);font-size:15px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:20px}
.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center}
.form-group{margin-bottom:16px}
.form-group:last-child{margin-bottom:0}
.form-group label{display:block;font-size:12px;color:var(--text2);margin-bottom:5px;font-weight:500;letter-spacing:.01em}
.form-group input,.form-group select,.form-group textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-size:13px;font-family:inherit;transition:border-color .15s,box-shadow .15s;box-sizing:border-box}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--blue);box-shadow:var(--focus-ring)}
.form-group textarea{resize:vertical;min-height:60px}
.form-row{display:flex;gap:12px}
.form-row .form-group{flex:1;margin-bottom:0}
.status-select-wrap{display:flex;align-items:center;gap:8px}
.status-select-wrap select{flex:1}
.status-select-wrap .status-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.form-section-label{font-size:12px;color:var(--text2);font-weight:500;margin-bottom:8px;display:flex;align-items:center;gap:6px;letter-spacing:.01em}
.form-section-label svg{opacity:.5}
.modal-links-list{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.modal-link-item{display:flex;align-items:center;gap:6px;padding:7px 10px;background:var(--bg2);border-radius:6px;font-size:12px;border:1px solid var(--border)}
.modal-link-item .link-title{font-weight:500;color:var(--text);white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis}
.modal-link-item .link-url{color:var(--blue);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.modal-link-item .s-action{flex-shrink:0;font-size:10px;width:20px;height:20px;display:flex;align-items:center;justify-content:center}
.modal-link-add{display:flex;gap:6px;align-items:center}
.modal-link-add input{flex:1;border:1px solid var(--border);border-radius:6px;padding:7px 10px;font-size:12px;font-family:inherit;transition:border-color .15s}
.modal-link-add input:focus{outline:none;border-color:var(--blue)}
.modal-link-add button{flex-shrink:0;padding:7px 12px;font-size:12px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--bg2);color:var(--text2);transition:all .15s;font-weight:500}
.modal-link-add button:hover{background:var(--blue-light);border-color:var(--blue);color:var(--blue)}
.modal-empty-links{font-size:12px;color:var(--text3);padding:8px 0 4px;font-style:italic}
.modal-meta{font-size:11px;color:var(--text3);margin-top:2px;padding:0}
.dep-banner{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:8px;margin-bottom:16px;font-size:12px;line-height:1.5}
.dep-banner svg{flex-shrink:0;margin-top:1px}
.dep-banner-content{display:flex;flex-direction:column;gap:2px;min-width:0}
.dep-banner-label{font-weight:600;font-size:12px}
.dep-banner-detail{font-size:11px;opacity:.85}
.dep-banner.is-dependent{background:var(--dep-dependent-bg);border:1.5px solid var(--dep-dependent-border);color:var(--dep-dependent-text)}
.dep-banner.is-master{background:var(--dep-master-bg);border:1.5px solid var(--dep-master-border);color:var(--dep-master-text)}
.dep-banner.is-both{background:var(--dep-both-bg);border:1.5px solid var(--dep-both-border);color:var(--dep-both-text)}
.form-group input:disabled,.form-group input[readonly]{background:var(--input-disabled-bg);color:var(--text3);cursor:not-allowed}
.form-group .field-hint{font-size:11px;color:var(--text3);margin-top:3px;line-height:1.3}
.color-picker{display:flex;gap:6px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .15s}
.color-swatch:hover{transform:scale(1.1)}
.color-swatch.selected{border-color:var(--text)}

/* ===== AI PANEL ===== */
.ai-panel{position:fixed;top:0;right:0;width:380px;height:100%;background:var(--bg);z-index:201;box-shadow:var(--shadow-panel);border-left:1px solid var(--border);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.ai-panel.open{transform:translateX(0)}
.ai-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ai-header h3{font-size:15px;display:flex;align-items:center;gap:6px}
.ai-messages{flex:1;overflow-y:auto;padding:16px}
.ai-msg{margin-bottom:12px;padding:10px 14px;border-radius:10px;font-size:13px;line-height:1.5;max-width:90%}
.ai-msg.user{background:var(--blue);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
.ai-msg.assistant{background:var(--bg2);color:var(--text);border-bottom-left-radius:4px}
.ai-msg.system{background:var(--ai-msg-system-bg);color:var(--ai-msg-system-text);border:1px solid var(--ai-msg-system-border);font-size:12px;text-align:center;max-width:100%;border-radius:6px}
.ai-input-row{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px}
.ai-input{flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;font-family:inherit;resize:none;height:40px}
.ai-input:focus{outline:none;border-color:var(--blue)}
.ai-key-setup{padding:24px 20px;display:flex;flex-direction:column;align-items:stretch}
.ai-setup-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px}
.ai-setup-desc{font-size:12px;color:var(--text3);margin-bottom:16px;line-height:1.4}
.ai-provider-group{display:flex;flex-direction:column;gap:2px;margin-bottom:16px}
.ai-provider-option{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;border:1.5px solid transparent;transition:all .15s ease;font-size:13px}
.ai-provider-option:hover{background:var(--bg2)}
.ai-provider-option.selected{background:var(--blue-light);border-color:var(--ai-provider-selected-border)}
.ai-provider-option input[type="radio"]{accent-color:var(--blue);margin:0;width:16px;height:16px;flex-shrink:0}
.ai-provider-option .ai-provider-label{display:flex;flex-direction:column;gap:1px;min-width:0}
.ai-provider-option .ai-provider-name{font-weight:600;color:var(--text);font-size:13px}
.ai-provider-option .ai-provider-tag{font-size:11px;color:var(--text3);font-weight:400}
.ai-setup-fields{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.ai-setup-fields input{width:100%;border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-size:13px;font-family:inherit;box-sizing:border-box;transition:border-color .15s ease}
.ai-setup-fields input:focus{outline:none;border-color:var(--blue);box-shadow:var(--focus-ring)}
.ai-setup-fields input::placeholder{color:var(--text3)}
.ai-setup-action{display:flex;flex-direction:column;align-items:stretch;gap:10px}
.ai-setup-action .btn{width:100%;justify-content:center;padding:10px;font-size:13px;font-weight:600}
.ai-setup-hint{font-size:11px;color:var(--text3);line-height:1.4;text-align:center}
.ai-setup-hint a{color:var(--blue);text-decoration:none}
.ai-setup-hint a:hover{text-decoration:underline}

/* ===== CONTEXT MENU ===== */
.ctx-menu{position:fixed;background:var(--surface-elevated);border:1px solid var(--surface-elevated-border);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:500;min-width:160px;padding:4px;display:none}
.ctx-menu.open{display:block}
.ctx-item{padding:8px 12px;font-size:13px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px}
.ctx-item:hover{background:var(--bg2)}
.ctx-item.danger{color:var(--red)}
.ctx-item.danger:hover{background:var(--btn-danger-hover-bg)}

/* ===== SCROLLBAR ===== */
.timeline-body-wrap::-webkit-scrollbar{width:8px;height:8px}
.timeline-body-wrap::-webkit-scrollbar-track{background:var(--scrollbar-track)}
.timeline-body-wrap::-webkit-scrollbar-thumb{background:var(--scrollbar-thumb);border-radius:4px}
.timeline-body-wrap::-webkit-scrollbar-thumb:hover{background:var(--scrollbar-thumb-hover)}

/* ===== EMPTY STATE ===== */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px;margin-bottom:8px}

/* ===== TOOLTIP ===== */
.tooltip{position:fixed;background:var(--tooltip-bg);color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;z-index:600;pointer-events:none;white-space:nowrap;transform:translateX(-50%);box-shadow:var(--tooltip-shadow)}

/* ===== COMMAND PALETTE ===== */
.cmd-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--shadow-overlay);z-index:400;display:flex;align-items:flex-start;justify-content:center;padding-top:18vh;opacity:0;pointer-events:none;transition:opacity .15s ease}
.cmd-bg.open{opacity:1;pointer-events:auto}
.cmd-palette{background:var(--surface-elevated);border:1px solid var(--surface-elevated-border);border-radius:12px;box-shadow:var(--shadow),var(--shadow-deep);width:480px;max-width:92vw;overflow:hidden;transform:translateY(-8px) scale(.98);transition:transform .15s ease,opacity .15s ease;opacity:0}
.cmd-bg.open .cmd-palette{transform:translateY(0) scale(1);opacity:1}
.cmd-input-wrap{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:10px}
.cmd-input-wrap svg{color:var(--text3);flex-shrink:0}
.cmd-input{flex:1;border:none;outline:none;font-size:15px;font-family:inherit;color:var(--text);background:transparent}
.cmd-input::placeholder{color:var(--text3)}
.cmd-results{max-height:320px;overflow-y:auto;padding:6px}
.cmd-results::-webkit-scrollbar{width:4px}
.cmd-results::-webkit-scrollbar-thumb{background:var(--text3);border-radius:2px}
.cmd-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:background .1s}
.cmd-item:hover,.cmd-item.active{background:var(--bg-hover)}
.cmd-item-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cmd-item-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:1px}
.cmd-item-name{font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cmd-item-name mark{background:var(--mark-bg);color:var(--mark-color);border-radius:2px;padding:0 1px}
.cmd-item-meta{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cmd-item-type{font-size:10px;color:var(--text3);background:var(--bg-hover);padding:2px 6px;border-radius:4px;flex-shrink:0;text-transform:uppercase;letter-spacing:.3px;font-weight:500}
.cmd-empty{padding:24px 16px;text-align:center;color:var(--text3);font-size:13px}
.cmd-hint{padding:8px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text3);display:flex;align-items:center;gap:12px}
.cmd-hint kbd{background:var(--bg2);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:10px;font-family:inherit}
.fs-btn{position:relative}.fs-dot{position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;background:#9ca3af;border:1.5px solid var(--bg)}.fs-dot.on{background:#10b981}.fs-dot.pending{background:#f59e0b}
.fs-reconnect{display:none;align-items:center;justify-content:center;gap:10px;padding:7px 16px;background:#fef3c7;border-bottom:1px solid #fcd34d;font-size:12px;color:#92400e}
html.dark .fs-reconnect{background:#451a03;border-color:#92400e;color:#fcd34d}
.fs-reconnect-btn{padding:3px 10px;border-radius:4px;border:1px solid #f59e0b;background:#f59e0b;color:#fff;font-size:12px;font-weight:600;cursor:pointer}
.fs-reconnect-btn:hover{background:#d97706}
.fs-reconnect-link{background:none;border:none;color:inherit;font-size:12px;cursor:pointer;text-decoration:underline;padding:0;opacity:.75}
.fs-reconnect-link:hover{opacity:1}
.fs-setup{display:none;align-items:center;justify-content:center;gap:10px;padding:9px 16px;background:#eff6ff;border-bottom:1px solid #bfdbfe;font-size:12px;color:#1e40af}
html.dark .fs-setup{background:#1e3a5f;border-color:#1d4ed8;color:#bfdbfe}
.fs-setup-btn{padding:3px 12px;border-radius:4px;border:1px solid #3b82f6;background:#3b82f6;color:#fff;font-size:12px;font-weight:600;cursor:pointer}
.fs-setup-btn:hover{background:#2563eb}
.fs-toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:7px 16px;border-radius:20px;font-size:12px;font-weight:500;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}
</style>
</head>
<body>

<div id="app">
  <!-- Top Bar -->
  <div class="topbar">
    <h1 style="position:relative">
      <span id="orgName" class="org-name" onclick="Portfolio.editOrgName()" title="Click to rename organization">Organization</span>
      <div class="topbar-title-row">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        <div class="portfolio-title-wrap" onclick="Portfolio.togglePortfolioDropdown(event)" title="Switch portfolio">
          <span id="projectName" class="project-name" style="padding:0">Project Plan</span>
          <svg class="portfolio-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div id="portfolioDropdown" class="portfolio-dropdown" style="display:none"></div>
      </div>
    </h1>
    <div class="topbar-controls">
      <button class="btn btn-icon" onclick="App.navigate(-1)" title="Previous">&#9664;</button>
      <button class="btn today-btn" onclick="App.goToday()">Today</button>
      <button class="btn btn-icon" onclick="App.navigate(1)" title="Next">&#9654;</button>
      <select class="zoom-select" id="zoomSelect" onchange="App.setZoom(this.value)">
        <option value="days">Days</option>
        <option value="weeks" selected>Weeks</option>
        <option value="months">Months</option>
        <option value="year">Year</option>
      </select>
      <button class="btn btn-primary btn-icon" onclick="Sidebar.showAddMenu(event)" title="Add">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="btn btn-icon" onclick="CSV.exportCSV()" title="Export CSV">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </button>
      <button class="btn btn-icon" onclick="document.getElementById('csvFileInput').click()" title="Import CSV">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </button>
      <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="CSV.importCSV(this)">
      <button class="btn btn-icon" onclick="AI.toggleAI()" title="AI Assistant" id="aiBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v3a4 4 0 01-8 0v-3H7a3 3 0 01-3-3v-2a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg>
      </button>
      <button class="btn btn-icon" onclick="Cmd.openCmdPalette()" title="Search (Ctrl+K)" id="searchBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </button>
      <button class="btn btn-icon fs-btn" onclick="FileStorage.selectFolder()" title="Connect folder (saves to data.json)" id="fsBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class="fs-dot" id="fsDot"></span></button>
      <button class="btn btn-icon" onclick="App.toggleDarkMode()" title="Toggle dark mode" id="darkModeBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0012 21a9 9 0 009-8.21z"/></svg>
      </button>
    </div>
  </div>

  <!-- File reconnect banner (returning user — pending permission) -->
  <div class="fs-reconnect" id="fsReconnect">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
    <span>Previous data file found.</span>
    <button class="fs-reconnect-btn" onclick="FileStorage.reconnect()">Load from file</button>
    <button class="fs-reconnect-link" onclick="FileStorage.selectNewFolder()">New project</button>
  </div>
  <!-- File setup banner (new folder — no handle saved) -->
  <div class="fs-setup" id="fsSetup">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
    <span>Select a folder to create your data file and get started.</span>
    <button class="fs-setup-btn" onclick="FileStorage.selectFolder()">Get Started</button>
  </div>

  <!-- Main Area -->
  <div class="main-area">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">Programs</div>
      <div class="sidebar-body" id="sidebarBody"></div>
      <div class="sidebar-resize" id="sidebarResize"></div>
    </div>
    <!-- Timeline -->
    <div class="timeline">
      <div class="timeline-header" id="timelineHeader"></div>
      <div class="timeline-body-wrap" id="timelineWrap">
        <div class="timeline-body" id="timelineBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- Panel Overlay -->
<div class="panel-overlay" id="panelOverlay" onclick="Tasks.closePanel()"></div>
<div class="detail-panel" id="detailPanel"></div>

<!-- AI Panel -->
<div class="ai-panel" id="aiPanel"></div>

<!-- Modal -->
<div class="modal-bg" id="modalBg" onclick="event.target===this&&UI.closeModal()">
  <div class="modal" id="modal"></div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu"></div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip" style="display:none"></div>

<!-- Command Palette -->
<div class="cmd-bg" id="cmdBg" onclick="event.target===this&&Cmd.closeCmdPalette()">
  <div class="cmd-palette" id="cmdPalette">
    <div class="cmd-input-wrap">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="cmd-input" id="cmdInput" placeholder="Search projects and programs..." autocomplete="off">
    </div>
    <div class="cmd-results" id="cmdResults"></div>
    <div class="cmd-hint">
      <span><kbd>&uarr;</kbd><kbd>&darr;</kbd> navigate</span>
      <span><kbd>Enter</kbd> open</span>
      <span><kbd>Esc</kbd> close</span>
    </div>
  </div>
</div>

<script>
// ========== CONSTANTS ==========
const COLORS = ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316','#14b8a6','#6366f1','#e11d48','#84cc16'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const ZOOM_CFG = {
  days:   { dayWidth: 56,  totalDays: 70,  navStep: 7 },
  weeks:  { dayWidth: 26,  totalDays: 126, navStep: 14 },
  months: { dayWidth: 14,  totalDays: 210, navStep: 30 },
  year:   { dayWidth: 3,   totalDays: 730, navStep: 90 }
};

const STATUS_OPTIONS = [
  { value: 'draft', label: 'Draft', color: '#ef4444' },
  { value: 'planning', label: 'In Planning', color: '#f59e0b' },
  { value: 'confirmed', label: 'Confirmed', color: '#10b981' }
];

// ========== NAMESPACES ==========
const Utils = {}, UI = {}, Portfolio = {}, Projects = {}, Tasks = {}, Deps = {}, Drag = {}, Sidebar = {}, Timeline = {}, AI = {}, Cmd = {}, CSV = {}, App = {}, FileStorage = {};

// ========== STATE ==========
let state = {
  categories: [],
  zoom: 'weeks',
  viewStart: null,
  selectedTask: null,
  aiKey: '',
  aiProvider: 'gemini',
  aiCustomEndpoint: '',
  aiCustomModel: '',
  aiMessages: [],
  projectName: 'Project Plan',
  activePortfolioId: null,
  orgName: 'Organization'
};

Drag.dragState = null;
Drag.depDragState = null;
Drag.panState = null;
Drag.createDragState = null;
Drag.sidebarResizeState = null;
Drag.reorderState = null;
Drag.catReorderState = null;
Drag.$dragDateLabel = null;

// ========== DOM REFS ==========
const $sidebarBody = document.getElementById('sidebarBody');
const $timelineHeader = document.getElementById('timelineHeader');
const $timelineBody = document.getElementById('timelineBody');
const $timelineWrap = document.getElementById('timelineWrap');
const $panelOverlay = document.getElementById('panelOverlay');
const $detailPanel = document.getElementById('detailPanel');
const $aiPanel = document.getElementById('aiPanel');
const $modalBg = document.getElementById('modalBg');
const $modal = document.getElementById('modal');
const $ctxMenu = document.getElementById('ctxMenu');
const $tooltip = document.getElementById('tooltip');
const $zoomSelect = document.getElementById('zoomSelect');
const $cmdBg = document.getElementById('cmdBg');
const $cmdInput = document.getElementById('cmdInput');
const $cmdResults = document.getElementById('cmdResults');
const $portfolioDropdown = document.getElementById('portfolioDropdown');

// ========== UTILITIES ==========
Utils.uid = function() { return 'id_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36); };
Utils.clamp = function(v, min, max) { return Math.max(min, Math.min(max, v)); };

Utils.toDate = function(s) {
  if (s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
};

Utils.toStr = function(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${dd}`;
};

Utils.addDays = function(d, n) {
  const r = new Date(d);
  r.setDate(r.getDate() + n);
  return r;
};

Utils.diffDays = function(a, b) {
  const msDay = 86400000;
  return Math.round((Utils.toDate(b) - Utils.toDate(a)) / msDay);
};

Utils.getWeek = function(d) {
  const date = new Date(d);
  date.setHours(0, 0, 0, 0);
  date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
  const week1 = new Date(date.getFullYear(), 0, 4);
  return 1 + Math.round(((date - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
};

Utils.formatDateShort = function(d) {
  return `${d.getDate()} ${MONTHS_SHORT[d.getMonth()]}`;
};

Utils.formatDateLong = function(d) {
  return `${d.getDate()} ${MONTHS_SHORT[d.getMonth()]} ${d.getFullYear()}`;
};

Utils.todayDate = function() {
  const t = new Date();
  return new Date(t.getFullYear(), t.getMonth(), t.getDate());
};

Utils.lightenColor = function(hex, amount = 0.88) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  const isDark = document.documentElement.classList.contains('dark');
  const target = isDark ? 18 : 255;
  const amt = isDark ? 0.82 : amount;
  const lr = Math.round(r + (target - r) * amt);
  const lg = Math.round(g + (target - g) * amt);
  const lb = Math.round(b + (target - b) * amt);
  return `rgb(${lr},${lg},${lb})`;
};

Utils.findCat = function(catId) { return state.categories.find(c => c.id === catId); };
Utils.findTask = function(catId, taskId) {
  const cat = Utils.findCat(catId);
  return cat ? cat.tasks.find(t => t.id === taskId) : null;
};

Projects.findProject = function(catId, projectId) {
  const cat = Utils.findCat(catId);
  if (!cat || !cat.projects) return null;
  return cat.projects.find(p => p.id === projectId) || null;
};

Projects.showAddProjectModal = function(catId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  const html = `
    <div class="modal-header">New Project<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Project Name</label><input id="mProjectName" placeholder="Enter project name" autofocus></div>
      <div class="form-group"><label>Notes</label><textarea id="mProjectNotes" rows="2" placeholder="Add notes..."></textarea></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map((c, i) => `<div class="color-swatch${c === cat.color ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="UI.pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Projects.doAddProject('${catId}')">Add Project</button>
    </div>`;
  UI.openModal(html);
  setTimeout(() => document.getElementById('mProjectName')?.focus(), 100);
};

Projects.doAddProject = function(catId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  const name = document.getElementById('mProjectName').value.trim();
  if (!name) return;
  const notes = document.getElementById('mProjectNotes').value;
  const color = document.querySelector('#mColorPicker .selected')?.dataset.color || cat.color;
  if (!cat.projects) cat.projects = [];
  cat.projects.push({ id: Utils.uid(), name, notes, color });
  UI.closeModal(); App.render(); App.saveState();
};

Projects.showEditProjectModal = function(catId, projectId) {
  const cat = Utils.findCat(catId);
  const proj = Projects.findProject(catId, projectId);
  if (!cat || !proj) return;
  const taskCount = cat.tasks.filter(t => t.projectId === projectId).length;
  const html = `
    <div class="modal-header">Edit Project<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Project Name</label><input id="mProjectName" value="${Utils.esc(proj.name)}"></div>
      <div class="form-group"><label>Notes</label><textarea id="mProjectNotes" rows="2" placeholder="Add notes...">${Utils.esc(proj.notes || '')}</textarea></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map(c => `<div class="color-swatch${c === proj.color ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="UI.pickColor(this)"></div>`).join('')}
      </div></div>
      ${taskCount > 0 ? `<div style="font-size:12px;color:var(--text3);margin-top:4px">${taskCount} task${taskCount !== 1 ? 's' : ''} in this project</div>` : '<div style="font-size:12px;color:var(--text3);margin-top:4px">No tasks yet</div>'}
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="UI.closeModal();Projects.deleteProject('${catId}','${projectId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Projects.doEditProject('${catId}','${projectId}')">Save</button>
    </div>`;
  UI.openModal(html);
};

Projects.doEditProject = function(catId, projectId) {
  const proj = Projects.findProject(catId, projectId);
  if (!proj) return;
  proj.name = document.getElementById('mProjectName').value.trim() || proj.name;
  proj.notes = document.getElementById('mProjectNotes').value;
  proj.color = document.querySelector('#mColorPicker .selected')?.dataset.color || proj.color;
  UI.closeModal(); App.render(); App.saveState();
};

Projects.deleteProject = function(catId, projectId) {
  const cat = Utils.findCat(catId);
  const proj = Projects.findProject(catId, projectId);
  if (!cat || !proj) return;
  const taskCount = cat.tasks.filter(t => t.projectId === projectId).length;
  const msg = taskCount > 0
    ? `Delete project "${Utils.esc(proj.name)}" and its ${taskCount} task${taskCount !== 1 ? 's' : ''}? This cannot be undone.`
    : `Delete project "${Utils.esc(proj.name)}"? This cannot be undone.`;
  UI.showConfirmModal('Delete Project', msg, () => {
    cat.projects = (cat.projects || []).filter(p => p.id !== projectId);
    // Remove all tasks in this project and clean up dependency refs
    const removedIds = new Set(cat.tasks.filter(t => t.projectId === projectId).map(t => t.id));
    cat.tasks = cat.tasks.filter(t => t.projectId !== projectId);
    for (const t of cat.tasks) {
      if (t.dependencies) t.dependencies = t.dependencies.filter(id => !removedIds.has(id));
    }
    if (state.selectedTask && removedIds.has(state.selectedTask.taskId)) Tasks.closePanel();
    App.render(); App.saveState();
  });
};

Utils.statusColor = function(v) { const s = STATUS_OPTIONS.find(o => o.value === v); return s ? s.color : '#9ca3af'; };

Utils.esc = function(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
};

Utils.escNl = function(s) {
  return Utils.esc(s).replace(/\n/g, '<br>');
};

Utils.computeRowHeight = function(numLanes) {
  return numLanes * LANE_HEIGHT + LANE_PADDING;
};

// ========== FILE STORAGE (File System Access API) ==========
FileStorage._dirHandle = null;
FileStorage._pendingHandle = null;
FileStorage._lastSavedAt = null;
FileStorage._pollTimer = null;
FileStorage._toastTimer = null;
FileStorage.isSupported = function() { return 'showDirectoryPicker' in window; };
FileStorage._openIDB = function() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('rm_fs_v1', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('handles');
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = () => reject(req.error);
  });
};
FileStorage._getHandle = async function() {
  try {
    const db = await FileStorage._openIDB();
    return await new Promise(resolve => {
      const tx = db.transaction('handles', 'readonly');
      const get = tx.objectStore('handles').get('dir');
      get.onsuccess = () => resolve(get.result || null);
      get.onerror = () => resolve(null);
    });
  } catch { return null; }
};
FileStorage._saveHandle = async function(handle) {
  try {
    const db = await FileStorage._openIDB();
    await new Promise((resolve, reject) => {
      const tx = db.transaction('handles', 'readwrite');
      tx.objectStore('handles').put(handle, 'dir');
      tx.oncomplete = resolve; tx.onerror = () => reject(tx.error);
    });
  } catch (e) { console.warn('FileStorage: failed to save handle', e); }
};
FileStorage._clearLocalPortfolioData = function() {
  Object.keys(localStorage).filter(k => k.startsWith('rm_') && k !== 'rm_darkMode').forEach(k => localStorage.removeItem(k));
};
FileStorage._dataFileExists = async function() {
  try { await FileStorage._dirHandle.getFileHandle('data.json', { create: false }); return true; } catch { return false; }
};
FileStorage._updateStatus = function() {
  const dot = document.getElementById('fsDot');
  const btn = document.getElementById('fsBtn');
  const reconnect = document.getElementById('fsReconnect');
  const setup = document.getElementById('fsSetup');
  if (dot) {
    dot.classList.remove('on', 'pending');
    if (FileStorage._dirHandle) dot.classList.add('on');
    else if (FileStorage._pendingHandle) dot.classList.add('pending');
  }
  if (btn) btn.title = FileStorage._dirHandle ? 'Connected — saving to data.json' : FileStorage._pendingHandle ? 'Click to reconnect to your data file' : 'Connect folder (saves to data.json)';
  if (reconnect) reconnect.style.display = (FileStorage._pendingHandle && !FileStorage._dirHandle) ? 'flex' : 'none';
  if (setup) setup.style.display = (!FileStorage._dirHandle && !FileStorage._pendingHandle && FileStorage.isSupported()) ? 'flex' : 'none';
};
FileStorage.showToast = function(msg) {
  const el = document.getElementById('fsToast');
  if (!el) return;
  el.textContent = msg;
  el.style.opacity = '1';
  clearTimeout(FileStorage._toastTimer);
  FileStorage._toastTimer = setTimeout(() => { el.style.opacity = '0'; }, 3000);
};
FileStorage.init = async function() {
  if (!FileStorage.isSupported()) return false;
  const saved = await FileStorage._getHandle();
  if (!saved) return false;
  // requestPermission() requires a user gesture — only use queryPermission here
  const perm = await saved.queryPermission({ mode: 'readwrite' });
  if (perm === 'granted') {
    FileStorage._dirHandle = saved; FileStorage._updateStatus(); return true;
  }
  // Permission needs re-granting — park handle and show reconnect banner
  FileStorage._pendingHandle = saved; FileStorage._updateStatus(); return false;
};
FileStorage.reconnect = async function() {
  if (!FileStorage._pendingHandle) return;
  try {
    const perm = await FileStorage._pendingHandle.requestPermission({ mode: 'readwrite' });
    if (perm === 'granted') {
      FileStorage._dirHandle = FileStorage._pendingHandle;
      FileStorage._pendingHandle = null;
      FileStorage._updateStatus();
      if (await FileStorage._dataFileExists()) {
        await FileStorage.importToLocalStorage();
        Portfolio.loadState();
        Portfolio.applyProjectName();
        Portfolio.applyOrgName();
        App.render();
        FileStorage.showToast('✓ Data file loaded');
      } else {
        await FileStorage.writeAll();
        FileStorage.showToast('✓ New data file created');
      }
      FileStorage.startPolling();
    }
  } catch (e) { console.warn('FileStorage: reconnect failed', e); }
};
FileStorage.selectFolder = async function() {
  if (!FileStorage.isSupported()) { alert('File storage requires Chrome or Edge. Your data is currently saved in browser localStorage.'); return; }
  if (FileStorage._pendingHandle) { FileStorage.reconnect(); return; }
  try {
    const handle = await window.showDirectoryPicker({ mode: 'readwrite', id: 'rm-data-folder', startIn: undefined });
    FileStorage._dirHandle = handle;
    FileStorage._pendingHandle = null;
    await FileStorage._saveHandle(handle);
    FileStorage._updateStatus();
    if (await FileStorage._dataFileExists()) {
      await FileStorage.importToLocalStorage();
      Portfolio.loadState();
      Portfolio.applyProjectName();
      Portfolio.applyOrgName();
      App.render();
      FileStorage.showToast('✓ Data file loaded');
    } else {
      await FileStorage.writeAll();
      FileStorage.showToast('✓ New data file created');
    }
    FileStorage.startPolling();
  } catch (e) { if (e.name !== 'AbortError') console.warn('FileStorage: folder select failed', e); }
};
FileStorage.selectNewFolder = async function() {
  FileStorage._pendingHandle = null;
  await FileStorage.selectFolder();
};
FileStorage._write = async function(data) {
  if (!FileStorage._dirHandle) return;
  try {
    const fh = await FileStorage._dirHandle.getFileHandle('data.json', { create: true });
    const writable = await fh.createWritable();
    await writable.write(JSON.stringify(data));
    await writable.close();
  } catch (e) { console.warn('FileStorage: write failed', e); }
};
FileStorage.writeAll = async function() {
  if (!FileStorage._dirHandle) return;
  const reg = Portfolio.getPortfolioRegistry();
  const portData = {};
  for (const p of reg) { try { const r = localStorage.getItem('rm_portfolio_' + p.id); if (r) portData[p.id] = JSON.parse(r); } catch {} }
  const savedAt = new Date().toISOString();
  FileStorage._lastSavedAt = savedAt;
  await FileStorage._write({ portfolios: reg, portfolioData: portData, global: Portfolio.getGlobalSettings(), activeId: state.activePortfolioId, darkMode: localStorage.getItem('rm_darkMode') || '0', _savedAt: savedAt });
};
FileStorage.importToLocalStorage = async function() {
  try {
    const fh = await FileStorage._dirHandle.getFileHandle('data.json', { create: false });
    const file = await fh.getFile();
    const data = JSON.parse(await file.text());
    FileStorage._lastSavedAt = data._savedAt || null;
    if (data.portfolios) localStorage.setItem('rm_portfolios', JSON.stringify(data.portfolios));
    if (data.global) localStorage.setItem('rm_global', JSON.stringify(data.global));
    if (data.activeId) localStorage.setItem('rm_active', data.activeId);
    if (data.darkMode != null) localStorage.setItem('rm_darkMode', data.darkMode);
    if (data.portfolioData) { for (const [id, pd] of Object.entries(data.portfolioData)) { if (pd) localStorage.setItem('rm_portfolio_' + id, JSON.stringify(pd)); } }
  } catch { /* file doesn't exist yet — first run */ }
};
FileStorage._applyData = function(data) {
  const global = data.global || {};
  state.aiKey = global.aiKey || '';
  state.aiProvider = global.aiProvider || 'gemini';
  state.aiCustomEndpoint = global.aiCustomEndpoint || '';
  state.aiCustomModel = global.aiCustomModel || '';
  state.orgName = global.orgName || 'Organization';
  const activeId = data.activeId || state.activePortfolioId;
  if (activeId && data.portfolioData && data.portfolioData[activeId]) {
    const pd = data.portfolioData[activeId];
    state.categories = pd.categories || [];
    state.projectName = pd.projectName || 'Project Plan';
    state.aiMessages = pd.aiMessages || [];
    state.activePortfolioId = activeId;
    Portfolio.migrateTaskData();
  }
  if (data.portfolios) localStorage.setItem('rm_portfolios', JSON.stringify(data.portfolios));
  if (data.global) localStorage.setItem('rm_global', JSON.stringify(data.global));
  if (data.portfolioData) { for (const [id, pd] of Object.entries(data.portfolioData)) { if (pd) localStorage.setItem('rm_portfolio_' + id, JSON.stringify(pd)); } }
  Portfolio.applyProjectName();
  Portfolio.applyOrgName();
  App.render();
};
FileStorage.startPolling = function() {
  if (FileStorage._pollTimer) return;
  FileStorage._pollTimer = setInterval(FileStorage.poll, 15000);
};
FileStorage.poll = async function() {
  if (!FileStorage._dirHandle) return;
  if ($modalBg.classList.contains('open')) return;
  try {
    const fh = await FileStorage._dirHandle.getFileHandle('data.json', { create: false });
    const file = await fh.getFile();
    const data = JSON.parse(await file.text());
    const fileSavedAt = data._savedAt || null;
    if (fileSavedAt && fileSavedAt !== FileStorage._lastSavedAt) {
      FileStorage._lastSavedAt = fileSavedAt;
      FileStorage._applyData(data);
      FileStorage.showToast('↻  Updated by another user');
    }
  } catch { /* file temporarily unavailable — skip this cycle */ }
};

// ========== PERSISTENCE (Multi-Portfolio) ==========
Portfolio.getPortfolioRegistry = function() {
  try { return JSON.parse(localStorage.getItem('rm_portfolios') || '[]'); }
  catch { return []; }
};
Portfolio.savePortfolioRegistry = function(reg) { localStorage.setItem('rm_portfolios', JSON.stringify(reg)); };

Portfolio.getGlobalSettings = function() {
  try { return JSON.parse(localStorage.getItem('rm_global') || '{}'); }
  catch { return {}; }
};
Portfolio.saveGlobalSettings = function() {
  localStorage.setItem('rm_global', JSON.stringify({
    aiKey: state.aiKey, aiProvider: state.aiProvider,
    aiCustomEndpoint: state.aiCustomEndpoint, aiCustomModel: state.aiCustomModel,
    orgName: state.orgName
  }));
};

Portfolio.migrateFromLegacy = function() {
  try {
    const raw = localStorage.getItem('rm_state');
    if (!raw) return;
    const data = JSON.parse(raw);
    const id = Utils.uid();
    const name = data.projectName || 'Project Plan';
    const now = new Date().toISOString();
    // Create portfolio registry
    Portfolio.savePortfolioRegistry([{ id, name, createdAt: now, updatedAt: now }]);
    // Save portfolio data
    localStorage.setItem('rm_portfolio_' + id, JSON.stringify({
      categories: data.categories || [], projectName: name, aiMessages: []
    }));
    // Save global settings
    localStorage.setItem('rm_global', JSON.stringify({
      aiKey: data.aiKey || '', aiProvider: data.aiProvider || 'gemini',
      aiCustomEndpoint: data.aiCustomEndpoint || '', aiCustomModel: data.aiCustomModel || ''
    }));
    localStorage.setItem('rm_active', id);
    localStorage.removeItem('rm_state');
  } catch (e) { console.warn('Migration failed', e); }
};

Portfolio.migrateTaskData = function() {
  for (const cat of state.categories) {
    for (const task of cat.tasks) {
      if (!task.dependencies) task.dependencies = [];
      if (!task.urls) task.urls = [];
      if (!task.lastUpdated) task.lastUpdated = null;
      if (!task.group) task.group = task.name;
      if (task.status === 'tentative') task.status = 'planning';
      if (!task.type) task.type = 'task';
    }
  }
  // Enforce dependency date constraints
  for (const cat of state.categories) {
    for (const task of cat.tasks) {
      if (task.dependencies && task.dependencies.length > 0) {
        for (const predId of task.dependencies) {
          const pred = cat.tasks.find(t => t.id === predId);
          if (pred && Utils.toDate(task.startDate) <= Utils.toDate(pred.endDate)) {
            const minStart = Utils.toStr(Utils.addDays(Utils.toDate(pred.endDate), 1));
            const shift = Utils.diffDays(task.startDate, minStart);
            task.startDate = minStart;
            task.endDate = Utils.toStr(Utils.addDays(Utils.toDate(task.endDate), shift));
          }
        }
      }
    }
  }
  // Migrate from group-based to project-based model
  for (const cat of state.categories) {
    if (!cat.projects) {
      const projectMap = new Map();
      const projectOrder = [];
      for (const task of cat.tasks) {
        const gKey = task.group || task.name;
        if (!projectMap.has(gKey)) {
          const proj = { id: Utils.uid(), name: gKey, notes: '', color: cat.color };
          projectMap.set(gKey, proj);
          projectOrder.push(proj);
        }
        task.projectId = projectMap.get(gKey).id;
        delete task.group;
      }
      cat.projects = projectOrder;
    }
    // Ensure all tasks have projectId (safety)
    for (const task of cat.tasks) {
      if (task.group && !task.projectId) {
        // Leftover group field — find or create project
        const gKey = task.group;
        let proj = (cat.projects || []).find(p => p.name === gKey);
        if (!proj) {
          proj = { id: Utils.uid(), name: gKey, notes: '', color: cat.color };
          if (!cat.projects) cat.projects = [];
          cat.projects.push(proj);
        }
        task.projectId = proj.id;
        delete task.group;
      }
    }
  }
};

Portfolio.loadPortfolio = function(id) {
  try {
    const raw = localStorage.getItem('rm_portfolio_' + id);
    if (raw) {
      const data = JSON.parse(raw);
      state.categories = data.categories || [];
      state.projectName = data.projectName || 'Project Plan';
      state.aiMessages = data.aiMessages || [];
    } else {
      state.categories = [];
      state.projectName = 'Project Plan';
      state.aiMessages = [];
    }
    state.activePortfolioId = id;
    localStorage.setItem('rm_active', id);
    Portfolio.migrateTaskData();
  } catch (e) { console.warn('Failed to load portfolio', e); }
};

App.saveState = function() {
  if (!state.activePortfolioId) return;
  const data = { categories: state.categories, projectName: state.projectName, aiMessages: state.aiMessages };
  localStorage.setItem('rm_portfolio_' + state.activePortfolioId, JSON.stringify(data));
  const reg = Portfolio.getPortfolioRegistry();
  const entry = reg.find(p => p.id === state.activePortfolioId);
  if (entry) { entry.updatedAt = new Date().toISOString(); entry.name = state.projectName; Portfolio.savePortfolioRegistry(reg); }
  Portfolio.saveGlobalSettings();
  FileStorage.writeAll();
};

Portfolio.loadState = function() {
  try {
    // Migrate legacy single-portfolio data
    if (!localStorage.getItem('rm_portfolios') && localStorage.getItem('rm_state')) {
      Portfolio.migrateFromLegacy();
    }
    // Load global settings
    const global = Portfolio.getGlobalSettings();
    state.aiKey = global.aiKey || '';
    state.aiProvider = global.aiProvider || 'gemini';
    state.aiCustomEndpoint = global.aiCustomEndpoint || '';
    state.aiCustomModel = global.aiCustomModel || '';
    state.orgName = global.orgName || 'Organization';
    // Determine active portfolio
    const reg = Portfolio.getPortfolioRegistry();
    let activeId = localStorage.getItem('rm_active');
    if (!activeId || !reg.find(p => p.id === activeId)) {
      activeId = reg.length > 0 ? reg[0].id : null;
    }
    if (activeId) {
      Portfolio.loadPortfolio(activeId);
    } else {
      Portfolio.createPortfolio('Project Plan', true);
    }
  } catch (e) { console.warn('Failed to load state', e); }
};

Portfolio.switchPortfolio = function(id) {
  if (id === state.activePortfolioId) return;
  App.saveState();
  Portfolio.loadPortfolio(id);
  state.selectedTask = null;
  Tasks.closePanel();
  Portfolio.closePortfolioDropdown();
  Portfolio.applyProjectName();
  state.zoom = 'weeks';
  $zoomSelect.value = 'weeks';
  App.goToday();
};

Portfolio.createPortfolio = function(name, loadImmediately) {
  const id = Utils.uid();
  const now = new Date().toISOString();
  const reg = Portfolio.getPortfolioRegistry();
  reg.push({ id, name, createdAt: now, updatedAt: now });
  Portfolio.savePortfolioRegistry(reg);
  localStorage.setItem('rm_portfolio_' + id, JSON.stringify({
    categories: [], projectName: name, aiMessages: []
  }));
  if (loadImmediately) {
    Portfolio.loadPortfolio(id);
  }
  return id;
};

Portfolio.deletePortfolio = function(id) {
  const reg = Portfolio.getPortfolioRegistry();
  if (reg.length <= 1) return;
  const idx = reg.findIndex(p => p.id === id);
  if (idx === -1) return;
  reg.splice(idx, 1);
  Portfolio.savePortfolioRegistry(reg);
  localStorage.removeItem('rm_portfolio_' + id);
  if (state.activePortfolioId === id) {
    Portfolio.switchPortfolio(reg[0].id);
  }
};

Portfolio.renamePortfolio = function(id, newName) {
  const reg = Portfolio.getPortfolioRegistry();
  const entry = reg.find(p => p.id === id);
  if (entry) { entry.name = newName; entry.updatedAt = new Date().toISOString(); Portfolio.savePortfolioRegistry(reg); }
  if (state.activePortfolioId === id) {
    state.projectName = newName;
    Portfolio.applyProjectName();
    App.saveState();
  }
};

Portfolio.duplicatePortfolio = function(id) {
  const raw = localStorage.getItem('rm_portfolio_' + id);
  if (!raw) return;
  const data = JSON.parse(raw);
  const reg = Portfolio.getPortfolioRegistry();
  const source = reg.find(p => p.id === id);
  const newName = (source ? source.name : 'Portfolio') + ' (Copy)';
  const newId = Utils.uid();
  const now = new Date().toISOString();
  // Deep clone categories with new IDs
  const clonedData = JSON.parse(raw);
  clonedData.projectName = newName;
  reg.push({ id: newId, name: newName, createdAt: now, updatedAt: now });
  Portfolio.savePortfolioRegistry(reg);
  localStorage.setItem('rm_portfolio_' + newId, JSON.stringify(clonedData));
  Portfolio.switchPortfolio(newId);
};

// ========== SAMPLE DATA ==========
App.loadSampleData = function() {
  const today = Utils.todayDate();
  const p1 = Utils.uid(), p2 = Utils.uid(), p3 = Utils.uid();
  const p4 = Utils.uid(), p5 = Utils.uid(), p6 = Utils.uid();
  const p7 = Utils.uid(), p8 = Utils.uid(), p9 = Utils.uid();
  state.categories = [
    {
      id: Utils.uid(), name: 'Website Redesign', color: '#3b82f6', collapsed: false,
      projects: [
        { id: p1, name: 'Research & Discovery', notes: '', color: '#3b82f6' },
        { id: p2, name: 'Design & Branding', notes: '', color: '#3b82f6' },
      ],
      tasks: [
        { id: Utils.uid(), name: 'User Interviews', type: 'task', projectId: p1, startDate: Utils.toStr(Utils.addDays(today, -5)), endDate: Utils.toStr(Utils.addDays(today, 8)), status: 'confirmed', notes: 'User interviews and competitive analysis', urls: [{title:'Figma Board', url:'https://figma.com/example'}], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'Wireframing', type: 'task', projectId: p1, startDate: Utils.toStr(Utils.addDays(today, 6)), endDate: Utils.toStr(Utils.addDays(today, 18)), status: 'confirmed', notes: '', urls: [], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'Mockups', type: 'task', projectId: p2, startDate: Utils.toStr(Utils.addDays(today, 15)), endDate: Utils.toStr(Utils.addDays(today, 30)), status: 'planning', notes: 'Pending wireframe approval', urls: [], dependencies: [], lastUpdated: null }
      ]
    },
    {
      id: Utils.uid(), name: 'Mobile App', color: '#10b981', collapsed: false,
      projects: [
        { id: p4, name: 'Planning & Coordination', notes: '', color: '#10b981' },
        { id: p5, name: 'Core Development', notes: '', color: '#10b981' },
      ],
      tasks: [
        { id: Utils.uid(), name: 'Sprint Kickoff', type: 'task', projectId: p4, startDate: Utils.toStr(Utils.addDays(today, -2)), endDate: Utils.toStr(Utils.addDays(today, 1)), status: 'confirmed', notes: '', urls: [], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'Core Features', type: 'task', projectId: p5, startDate: Utils.toStr(Utils.addDays(today, 3)), endDate: Utils.toStr(Utils.addDays(today, 22)), status: 'confirmed', notes: 'Core features implementation', urls: [{title:'GitHub Repo', url:'https://github.com/example/app'}], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'QA Testing', type: 'task', projectId: p5, startDate: Utils.toStr(Utils.addDays(today, 20)), endDate: Utils.toStr(Utils.addDays(today, 32)), status: 'draft', notes: '', urls: [], dependencies: [], lastUpdated: null }
      ]
    },
    {
      id: Utils.uid(), name: 'Marketing Campaign', color: '#f59e0b', collapsed: false,
      projects: [
        { id: p7, name: 'Campaign Strategy', notes: '', color: '#f59e0b' },
        { id: p8, name: 'Content Production', notes: '', color: '#f59e0b' },
      ],
      tasks: [
        { id: Utils.uid(), name: 'Target Audience', type: 'task', projectId: p7, startDate: Utils.toStr(Utils.addDays(today, -8)), endDate: Utils.toStr(Utils.addDays(today, 2)), status: 'confirmed', notes: 'Define target audience and channels', urls: [], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'Blog Posts', type: 'task', projectId: p8, startDate: Utils.toStr(Utils.addDays(today, 1)), endDate: Utils.toStr(Utils.addDays(today, 16)), status: 'confirmed', notes: '', urls: [], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'Launch', type: 'milestone', projectId: p8, startDate: Utils.toStr(Utils.addDays(today, 17)), endDate: Utils.toStr(Utils.addDays(today, 17)), status: 'planning', notes: 'Dependent on content completion', urls: [], dependencies: [], lastUpdated: null }
      ]
    },
    {
      id: Utils.uid(), name: 'Infrastructure', color: '#8b5cf6', collapsed: false,
      projects: [
        { id: p9, name: 'Cloud Infrastructure', notes: '', color: '#8b5cf6' },
      ],
      tasks: [
        { id: Utils.uid(), name: 'AWS to GCP', type: 'task', projectId: p9, startDate: Utils.toStr(Utils.addDays(today, 0)), endDate: Utils.toStr(Utils.addDays(today, 14)), status: 'confirmed', notes: 'AWS to GCP migration', urls: [], dependencies: [], lastUpdated: null },
        { id: Utils.uid(), name: 'CI/CD Pipeline', type: 'task', projectId: p9, startDate: Utils.toStr(Utils.addDays(today, 10)), endDate: Utils.toStr(Utils.addDays(today, 20)), status: 'draft', notes: '', urls: [], dependencies: [], lastUpdated: null }
      ]
    }
  ];
};

// ========== GROUPING ==========
const LANE_HEIGHT = 28;
const LANE_PADDING = 6;

Timeline.assignLanes = function(tasks) {
  const lanes = new Map();
  if (tasks.length <= 1) {
    if (tasks.length === 1) lanes.set(tasks[0].id, 0);
    return { lanes, numLanes: 1 };
  }

  // Helper: get visual end date (milestones extend right to account for label)
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const milestoneLabelDays = Math.ceil(120 / dayW); // ~120px label width in days
  function visualEnd(t) {
    if (t.type === 'milestone') return Utils.toStr(Utils.addDays(Utils.toDate(t.endDate), milestoneLabelDays));
    return t.endDate;
  }
  // Helper: check if two tasks overlap visually
  function overlaps(a, b) {
    return Utils.toDate(a.startDate) <= Utils.toDate(visualEnd(b)) && Utils.toDate(b.startDate) <= Utils.toDate(visualEnd(a));
  }

  // Helper: find the lowest free lane >= minLane with no temporal overlap
  function findFreeLane(task, minLane) {
    for (let lane = minLane; lane < 100; lane++) {
      let free = true;
      for (const [id, l] of lanes) {
        if (l !== lane) continue;
        const other = taskMap.get(id);
        if (other && overlaps(task, other)) { free = false; break; }
      }
      if (free) return lane;
    }
    return minLane;
  }

  const taskMap = new Map(tasks.map(t => [t.id, t]));

  // Topological sort: predecessors are placed before their dependents
  const visited = new Set();
  const order = [];
  function visit(t) {
    if (visited.has(t.id)) return;
    visited.add(t.id);
    for (const depId of (t.dependencies || [])) {
      if (taskMap.has(depId)) visit(taskMap.get(depId));
    }
    order.push(t);
  }
  // Seed the sort by start date so independent tasks pack chronologically
  const sorted = [...tasks].sort((a, b) => {
    const cmp = Utils.toDate(a.startDate) - Utils.toDate(b.startDate);
    return cmp !== 0 ? cmp : Utils.toDate(a.endDate) - Utils.toDate(b.endDate);
  });
  for (const t of sorted) visit(t);

  // Single pass in topological order:
  // - Dependent tasks: place immediately below predecessor (predLane + 1)
  // - Independent tasks: pack into lowest free lane from 0
  for (const task of order) {
    const deps = (task.dependencies || []).filter(id => lanes.has(id));
    if (deps.length > 0) {
      const predLane = Math.max(...deps.map(id => lanes.get(id)));
      lanes.set(task.id, findFreeLane(task, predLane + 1));
    } else {
      lanes.set(task.id, findFreeLane(task, 0));
    }
  }

  let numLanes = 0;
  for (const l of lanes.values()) numLanes = Math.max(numLanes, l + 1);
  return { lanes, numLanes: Math.max(1, numLanes) };
};

Timeline.buildGroups = function() {
  const result = [];
  for (const cat of state.categories) {
    if (cat.collapsed) {
      result.push({ cat, groups: [] });
      continue;
    }
    const groups = [];
    for (const proj of (cat.projects || [])) {
      const tasks = cat.tasks.filter(t => t.projectId === proj.id);
      const { lanes, numLanes } = Timeline.assignLanes(tasks);
      const rowHeight = tasks.length > 0 ? Utils.computeRowHeight(numLanes) : 28;
      groups.push({ project: proj, groupName: proj.name, catId: cat.id, tasks, lanes, numLanes, rowHeight });
    }
    result.push({ cat, groups });
  }
  return result;
};

// ========== RENDERING ==========
let cachedGroups = null;
App.render = function() {
  cachedGroups = Timeline.buildGroups();
  Sidebar.renderSidebar();
  Timeline.renderTimeline();
};

Sidebar.focusRow = function(el) {
  $sidebarBody.querySelectorAll('.s-task.row-focused').forEach(r => r.classList.remove('row-focused'));
  $timelineBody.querySelectorAll('.t-row.row-focused').forEach(r => r.classList.remove('row-focused'));
  el.classList.add('row-focused');
  const projId = el.dataset.project;
  if (projId) {
    const tRow = $timelineBody.querySelector(`.t-row[data-project="${projId}"]`);
    if (tRow) tRow.classList.add('row-focused');
  }
};

Sidebar.renderSidebar = function() {
  let html = '';
  const grouped = cachedGroups || Timeline.buildGroups();
  let catIdx = 0;
  for (const { cat, groups } of grouped) {
    catIdx++;
    const collapsed = cat.collapsed;
    const catBg = Utils.lightenColor(cat.color, 0.88);
    html += `<div class="s-cat" data-cat="${cat.id}">
      <div class="s-cat-header" style="background:${catBg}" oncontextmenu="Sidebar.showCatCtx(event,'${cat.id}')" onclick="Sidebar.toggleCat('${cat.id}')">
        <div class="s-cat-grip" onmousedown="Drag.onCatGripMouseDown(event,'${cat.id}',${catIdx - 1})"><svg width="6" height="10" viewBox="0 0 6 10"><circle cx="1.5" cy="1.5" r="1" fill="currentColor"/><circle cx="4.5" cy="1.5" r="1" fill="currentColor"/><circle cx="1.5" cy="5" r="1" fill="currentColor"/><circle cx="4.5" cy="5" r="1" fill="currentColor"/><circle cx="1.5" cy="8.5" r="1" fill="currentColor"/><circle cx="4.5" cy="8.5" r="1" fill="currentColor"/></svg></div>
        <div class="s-cat-color" style="background:${cat.color}"></div>
        <div class="s-cat-toggle ${collapsed ? 'collapsed' : ''}">&#9660;</div>
        <div class="s-cat-name"><span class="s-num">${catIdx}</span>${Utils.esc(cat.name)}</div>
        <div class="s-cat-actions">
          <button class="s-action" onclick="event.stopPropagation();Sidebar.showEditCatModal('${cat.id}')" title="Edit">&#9998;</button>
          <button class="s-action" onclick="event.stopPropagation();Sidebar.deleteCat('${cat.id}')" title="Delete">&#10005;</button>
        </div>
      </div>`;
    if (!collapsed) {
      let groupIdx = 0;
      for (const group of groups) {
        groupIdx++;
        const proj = group.project;
        const sel = state.selectedTask && group.tasks.some(t => t.id === state.selectedTask.taskId) ? ' selected' : '';
        const countBadge = group.tasks.length > 0 ? ` <span class="s-count" style="color:var(--text3);font-weight:400;font-size:11px">(${group.tasks.length})</span>` : '';
        html += `<div class="s-task${sel}" style="height:${group.rowHeight}px" data-cat="${cat.id}" data-project="${proj.id}" data-pidx="${groupIdx - 1}" onclick="Sidebar.focusRow(this)" oncontextmenu="Sidebar.showProjectCtx(event,'${cat.id}','${proj.id}')">
          <div class="s-task-grip" onmousedown="Drag.onGripMouseDown(event,'${cat.id}','${proj.id}',${groupIdx - 1})"><svg width="6" height="10" viewBox="0 0 6 10"><circle cx="1.5" cy="1.5" r="1" fill="currentColor"/><circle cx="4.5" cy="1.5" r="1" fill="currentColor"/><circle cx="1.5" cy="5" r="1" fill="currentColor"/><circle cx="4.5" cy="5" r="1" fill="currentColor"/><circle cx="1.5" cy="8.5" r="1" fill="currentColor"/><circle cx="4.5" cy="8.5" r="1" fill="currentColor"/></svg></div>
          <div class="s-task-dot" style="background:${proj.color}"></div>
          <div class="s-task-name"><span class="s-num">${catIdx}.${groupIdx}</span><span class="s-task-name-link" onclick="event.stopPropagation();Projects.showEditProjectModal('${cat.id}','${proj.id}')" title="Edit project">${Utils.esc(proj.name)}</span>${countBadge}</div>
          <div class="s-task-actions">
            <button class="s-action" onclick="event.stopPropagation();Tasks.showAddTaskModal('${cat.id}','${proj.id}')" title="Add task or milestone to this project">&#43;</button>
            <button class="s-action" onclick="event.stopPropagation();Projects.showEditProjectModal('${cat.id}','${proj.id}')" title="Edit project">&#9998;</button>
            <button class="s-action" onclick="event.stopPropagation();Projects.deleteProject('${cat.id}','${proj.id}')" title="Delete project">&#10005;</button>
          </div>
        </div>`;
      }
      html += `<div class="s-add-row" onclick="Projects.showAddProjectModal('${cat.id}')">+ Add Project</div>`;
    }
    html += `</div>`;
  }
  html += `<div class="s-add-cat" onclick="Sidebar.showAddCatModal()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Add program
  </div>`;
  $sidebarBody.innerHTML = html;
};

Timeline.renderTimeline = function() {
  const cfg = ZOOM_CFG[state.zoom];
  const dayW = cfg.dayWidth;
  const totalDays = cfg.totalDays;
  const start = state.viewStart;
  const totalWidth = totalDays * dayW;
  const today = Utils.todayDate();

  // ----- HEADER -----
  let row1 = '', row2 = '';
  if (state.zoom === 'year') {
    // Row 1: Year groups, Row 2: Month columns
    let i = 0;
    while (i < totalDays) {
      const d = Utils.addDays(start, i);
      const yr = d.getFullYear();
      let span = 0;
      while (i + span < totalDays && Utils.addDays(start, i + span).getFullYear() === yr) span++;
      row1 += `<div class="t-group" style="width:${span * dayW}px"><span class="t-group-label">${yr}</span></div>`;
      i += span;
    }
    i = 0;
    while (i < totalDays) {
      const d = Utils.addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = Utils.addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const isToday = today.getMonth() === mo && today.getFullYear() === d.getFullYear();
      const moBgY = mo % 2 === 1 ? ';background:rgba(0,0,0,.06)' : '';
      row2 += `<div class="t-col${isToday ? ' today' : ''}" style="width:${span * dayW}px${moBgY}">${MONTHS_SHORT[mo]}</div>`;
      i += span;
    }
  } else if (state.zoom === 'months') {
    // Row 1: Month groups, Row 2: Day numbers
    let i = 0;
    while (i < totalDays) {
      const d = Utils.addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = Utils.addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const moBg = mo % 2 === 1 ? ';background:rgba(0,0,0,.06)' : '';
      row1 += `<div class="t-group" style="width:${span * dayW}px${moBg}"><span class="t-group-label">${MONTHS_SHORT[mo]} ${d.getFullYear()}</span></div>`;
      i += span;
    }
    for (let j = 0; j < totalDays; j++) {
      const d = Utils.addDays(start, j);
      const isWe = d.getDay() === 0 || d.getDay() === 6;
      const isT = d.getTime() === today.getTime();
      row2 += `<div class="t-col${isWe ? ' weekend' : ''}${isT ? ' today' : ''}" style="width:${dayW}px">${d.getDate()}</div>`;
    }
  } else {
    // Days & Weeks: Row 1: Month group, Row 2: Day name + date
    let i = 0;
    while (i < totalDays) {
      const d = Utils.addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = Utils.addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const label = state.zoom === 'days'
        ? `${MONTHS[mo]} ${d.getFullYear()}`
        : `${MONTHS_SHORT[mo]} ${d.getFullYear()}`;
      const moBg2 = mo % 2 === 1 ? ';background:rgba(0,0,0,.06)' : '';
      row1 += `<div class="t-group" style="width:${span * dayW}px${moBg2}"><span class="t-group-label">${label}</span></div>`;
      i += span;
    }
    for (let j = 0; j < totalDays; j++) {
      const d = Utils.addDays(start, j);
      const isWe = d.getDay() === 0 || d.getDay() === 6;
      const isT = d.getTime() === today.getTime();
      const label = state.zoom === 'days'
        ? `${DAYS_SHORT[d.getDay()]} ${d.getDate()}`
        : `${d.getDate()}`;
      row2 += `<div class="t-col${isWe ? ' weekend' : ''}${isT ? ' today' : ''}" style="width:${dayW}px">${label}</div>`;
    }
  }

  $timelineHeader.innerHTML =
    `<div class="t-header-row row1" style="width:${totalWidth}px">${row1}</div>
     <div class="t-header-row" style="width:${totalWidth}px">${row2}</div>`;

  // ----- BODY -----
  let gridHTML = '';
  // Alternating month bands
  {
    let mi = 0;
    while (mi < totalDays) {
      const d0 = Utils.addDays(start, mi);
      const mo = d0.getMonth();
      const yr = d0.getFullYear();
      let span = 0;
      while (mi + span < totalDays) {
        const d2 = Utils.addDays(start, mi + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== yr) break;
        span++;
      }
      if (mo % 2 === 1) {
        gridHTML += `<div class="t-month-band" style="left:${mi * dayW}px;width:${span * dayW}px;background:rgba(0,0,0,.05)"></div>`;
      }
      mi += span;
    }
  }
  // Weekend columns
  for (let j = 0; j < totalDays; j++) {
    const d = Utils.addDays(start, j);
    if (d.getDay() === 0 || d.getDay() === 6) {
      gridHTML += `<div class="t-weekend" style="left:${j * dayW}px;width:${dayW}px"></div>`;
    }
  }
  // Gridlines
  for (let j = 0; j <= totalDays; j++) {
    gridHTML += `<div class="t-gridline" style="left:${j * dayW}px"></div>`;
  }
  // Today line
  const todayOff = Utils.diffDays(Utils.toStr(start), Utils.toStr(today));
  if (todayOff >= 0 && todayOff < totalDays) {
    gridHTML += `<div class="t-today-line" style="left:${todayOff * dayW + dayW / 2}px"></div>`;
  }

  let rowsHTML = '';
  const taskPositions = new Map();
  let currentY = 0;
  const grouped = cachedGroups || Timeline.buildGroups();

  for (const { cat, groups } of grouped) {
    const catLightBg = Utils.lightenColor(cat.color, 0.88);
    rowsHTML += `<div class="t-row cat-row" data-cat="${cat.id}" style="width:${totalWidth}px;background:${catLightBg}"></div>`;
    currentY += 32; // cat-row-h
    if (!cat.collapsed) {
      for (const group of groups) {
        const groupTop = currentY;
        rowsHTML += `<div class="t-row task-row" data-cat="${cat.id}" data-project="${group.project.id}" style="width:${totalWidth}px;height:${group.rowHeight}px">`;
        for (const task of group.tasks) {
          const tStart = Utils.diffDays(Utils.toStr(start), task.startDate);
          const tDur = Utils.diffDays(task.startDate, task.endDate) + 1;
          const barLeft = tStart * dayW;
          const barWidth = Math.max(tDur * dayW - 2, 20);
          const vis = (tStart + tDur > 0 && tStart < totalDays);
          const lane = group.lanes.get(task.id);
          const barTop = lane * LANE_HEIGHT + 4;

          if (task.type === 'milestone') {
            taskPositions.set(task.id, {
              left: barLeft + 8,
              right: barLeft + 8,
              centerY: groupTop + barTop + 10
            });
          } else {
            taskPositions.set(task.id, {
              left: barLeft,
              right: barLeft + barWidth,
              centerY: groupTop + barTop + 10
            });
          }

          if (vis) {
            if (task.type === 'milestone') {
              const diamondTop = lane * LANE_HEIGHT + 4;
              rowsHTML += `<div class="milestone-diamond" data-cat="${cat.id}" data-task="${task.id}"
                style="left:${barLeft}px;top:${diamondTop}px"
                onmousedown="Drag.onBarMouseDown(event,'${cat.id}','${task.id}')"
                onclick="event.stopPropagation();Tasks.openPanel('${cat.id}','${task.id}')"
                onmouseenter="UI.showBarTooltip(event,'${cat.id}','${task.id}')"
                onmouseleave="UI.hideTooltip()">
                <div class="diamond-shape" style="background:${group.project.color}"></div>
                <span class="milestone-label">${Utils.esc(task.name)}</span>
                <div class="dep-bubble" onmousedown="Deps.onDepBubbleMouseDown(event,'${cat.id}','${task.id}')"></div>
              </div>`;
            } else {
              rowsHTML += `<div class="task-bar" data-cat="${cat.id}" data-task="${task.id}"
                style="left:${barLeft}px;width:${barWidth}px;top:${barTop}px;height:20px;background:${group.project.color}"
                onmousedown="Drag.onBarMouseDown(event,'${cat.id}','${task.id}')"
                onclick="event.stopPropagation();Tasks.openPanel('${cat.id}','${task.id}')"
                onmouseenter="UI.showBarTooltip(event,'${cat.id}','${task.id}')"
                onmouseleave="UI.hideTooltip()">
                <div class="resize-handle left"></div>
                <span class="status-dot" style="background:${Utils.statusColor(task.status)}"></span>
                <span class="task-bar-label">${Utils.esc(task.name)}</span>
                <div class="resize-handle right"></div>
                <div class="dep-bubble" onmousedown="Deps.onDepBubbleMouseDown(event,'${cat.id}','${task.id}')"></div>
              </div>`;
            }
          }
        }
        rowsHTML += `</div>`;
        currentY += group.rowHeight;
      }
      // Add-row placeholder (matches sidebar s-add-row height)
      rowsHTML += `<div class="t-row" data-cat="${cat.id}" data-add="1" style="width:${totalWidth}px;height:24px"></div>`;
      currentY += 24;
    }
  }

  // Build dependency SVG overlay
  let depSVG = `<svg class="dep-svg-overlay" width="${totalWidth}" height="${currentY}">
    <defs><marker id="dep-arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6b7280"/>
    </marker></defs>`;
  for (const cat of state.categories) {
    if (cat.collapsed) continue;
    for (const task of cat.tasks) {
      if (!task.dependencies || task.dependencies.length === 0) continue;
      const toPos = taskPositions.get(task.id);
      if (!toPos) continue;
      for (const predId of task.dependencies) {
        const fromPos = taskPositions.get(predId);
        if (!fromPos) continue;
        const x1 = fromPos.right, y1 = fromPos.centerY;
        const x2 = toPos.left, y2 = toPos.centerY;
        const gap = x2 - x1;
        let pathD;
        // Clean 90-degree routing: right stub, straight down, right into dependent left side
        if (gap > 0) {
          // Place vertical drop between the two bars (midpoint of the gap, clamped)
          const vertX = x1 + Math.max(1, Math.min(gap / 2, 14));
          pathD = `M${x1},${y1} L${vertX},${y1} L${vertX},${y2} L${x2},${y2}`;
        } else {
          // Bars overlapping: route below both bars
          const belowY = Math.max(y1, y2) + 18;
          const vertX = x1 + 10;
          pathD = `M${x1},${y1} L${vertX},${y1} L${vertX},${belowY} L${x2 - 10},${belowY} L${x2 - 10},${y2} L${x2},${y2}`;
        }
        depSVG += `<path class="dep-arrow" d="${pathD}"
          data-from="${predId}" data-to="${task.id}" data-cat="${cat.id}"
          oncontextmenu="Deps.showDepCtx(event,'${cat.id}','${predId}','${task.id}')"/>`;

      }
    }
  }
  depSVG += `</svg>`;

  $timelineBody.style.width = totalWidth + 'px';
  $timelineBody.innerHTML = `<div class="t-grid">${gridHTML}</div><div class="t-rows">${rowsHTML}${depSVG}</div>`;
};

// ========== NAVIGATION ==========
App.navigate = function(dir) {
  const step = ZOOM_CFG[state.zoom].navStep;
  state.viewStart = Utils.addDays(state.viewStart, step * dir);
  App.render();
};

App.goToday = function() {
  const today = Utils.todayDate();
  const totalDays = ZOOM_CFG[state.zoom].totalDays;
  state.viewStart = Utils.addDays(today, -Math.floor(totalDays / 4));
  App.render();
  // Scroll to bring today into view
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const todayOff = Utils.diffDays(Utils.toStr(state.viewStart), Utils.toStr(today));
  $timelineWrap.scrollLeft = Math.max(0, todayOff * dayW - $timelineWrap.clientWidth / 3);
};

App.setZoom = function(z) {
  state.zoom = z;
  $zoomSelect.value = z;
  App.goToday();
};

// ========== SCROLL SYNC ==========
Timeline.updateStickyLabels = function() {
  const scrollLeft = $timelineWrap.scrollLeft;
  const labels = $timelineHeader.querySelectorAll('.t-group-label');
  labels.forEach(label => {
    const group = label.parentElement;
    // Get group's position relative to header scroll
    const groupLeft = group.offsetLeft;
    const groupWidth = group.offsetWidth;
    const labelWidth = label.offsetWidth;
    // Calculate how far the label should shift to stay visible
    const offset = scrollLeft - groupLeft;
    if (offset > 0 && offset < groupWidth - labelWidth - 8) {
      label.style.transform = `translateX(${offset}px)`;
    } else {
      label.style.transform = '';
    }
  });
};
$timelineWrap.addEventListener('scroll', () => {
  $timelineHeader.scrollLeft = $timelineWrap.scrollLeft;
  $sidebarBody.scrollTop = $timelineWrap.scrollTop;
  Timeline.updateStickyLabels();
});
$sidebarBody.addEventListener('scroll', () => {
  $timelineWrap.scrollTop = $sidebarBody.scrollTop;
});

// ========== SIDEBAR RESIZE ==========
const $sidebar = document.getElementById('sidebar');
const $sidebarResize = document.getElementById('sidebarResize');
$sidebarResize.addEventListener('mousedown', (e) => {
  e.preventDefault();
  Drag.sidebarResizeState = { startX: e.clientX, startW: $sidebar.offsetWidth };
  $sidebarResize.classList.add('active');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});

// ========== TIMELINE PAN + DRAG-TO-CREATE ==========

$timelineWrap.addEventListener('mousedown', (e) => {
  if (e.target.closest('.task-bar') || e.target.closest('.milestone-diamond') || e.target.closest('.dep-bubble')) return;
  if (e.button !== 0) return;

  // Strategy B: drag on a task row = create task, drag elsewhere = pan
  const taskRow = e.target.closest('.t-row.task-row');
  if (taskRow && !e.target.closest('.task-bar') && !e.target.closest('.milestone-diamond')) {
    const catId = taskRow.dataset.cat;
    const cat = Utils.findCat(catId);
    if (!cat) return;
    const px = Drag.timelinePixelX(e);
    const projectId = taskRow.dataset.project;
    Drag.createDragState = {
      catId, projectId, startX: e.clientX, pixelX: px, taskRow,
      ghostBar: null, moved: false, color: cat.color
    };
  } else {
    Drag.panState = { startX: e.clientX, startY: e.clientY, scrollLeft: $timelineWrap.scrollLeft, scrollTop: $timelineWrap.scrollTop, moved: false };
  }
});


// Double-click on empty task row → add task at that date
$timelineWrap.addEventListener('dblclick', (e) => {
  const taskRow = e.target.closest('.t-row.task-row');
  if (!taskRow || e.target.closest('.task-bar') || e.target.closest('.milestone-diamond')) return;
  const catId = taskRow.dataset.cat;
  const projectId = taskRow.dataset.project;
  const px = Drag.timelinePixelX(e);
  const clickDate = Drag.pixelToDate(px);
  if (projectId) {
    Tasks.showAddTaskModal(catId, projectId, clickDate, clickDate);
  } else {
    Tasks.showAddTaskModal(catId, clickDate);
  }
});

// Right-click on empty task row → context menu with "Add Task here"
$timelineWrap.addEventListener('contextmenu', (e) => {
  const taskRow = e.target.closest('.t-row.task-row');
  if (!taskRow || e.target.closest('.task-bar') || e.target.closest('.milestone-diamond')) return;
  e.preventDefault();
  e.stopPropagation();
  const catId = taskRow.dataset.cat;
  const projectId = taskRow.dataset.project;
  const cat = Utils.findCat(catId);
  if (!cat) return;
  const px = Drag.timelinePixelX(e);
  const clickDate = Drag.pixelToDate(px);
  const addAction = projectId
    ? () => Tasks.showAddTaskModal(catId, projectId, clickDate, clickDate)
    : () => Tasks.showAddTaskModal(catId, clickDate);
  UI.showCtxMenu(e.clientX, e.clientY, [
    { label: 'Add Task here', action: addAction }
  ]);
});

// ========== CATEGORY CRUD ==========
Sidebar.toggleCat = function(catId) {
  const cat = Utils.findCat(catId);
  if (cat) { cat.collapsed = !cat.collapsed; App.render(); App.saveState(); }
};

Sidebar.showAddCatModal = function() {
  const html = `
    <div class="modal-header">Add Program<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Name</label><input id="mCatName" placeholder="Program name" autofocus></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map((c, i) => `<div class="color-swatch${i === 0 ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="UI.pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Sidebar.doAddCat()">Add</button>
    </div>`;
  UI.openModal(html);
  setTimeout(() => document.getElementById('mCatName')?.focus(), 100);
};

Sidebar.doAddCat = function() {
  const name = document.getElementById('mCatName').value.trim();
  if (!name) return;
  const color = document.querySelector('#mColorPicker .selected')?.dataset.color || COLORS[0];
  state.categories.push({ id: Utils.uid(), name, color, collapsed: false, projects: [], tasks: [] });
  UI.closeModal(); App.render(); App.saveState();
};

Sidebar.showEditCatModal = function(catId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  const html = `
    <div class="modal-header">Edit Program<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Name</label><input id="mCatName" value="${Utils.esc(cat.name)}"></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map(c => `<div class="color-swatch${c === cat.color ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="UI.pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="UI.closeModal();Sidebar.deleteCat('${catId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Sidebar.doEditCat('${catId}')">Save</button>
    </div>`;
  UI.openModal(html);
};

Sidebar.doEditCat = function(catId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  cat.name = document.getElementById('mCatName').value.trim() || cat.name;
  cat.color = document.querySelector('#mColorPicker .selected')?.dataset.color || cat.color;
  UI.closeModal(); App.render(); App.saveState();
};

Sidebar.deleteCat = function(catId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  UI.showConfirmModal('Delete Program', `Are you sure you want to delete "${Utils.esc(cat.name)}" and all its projects? This cannot be undone.`, () => {
    state.categories = state.categories.filter(c => c.id !== catId);
    if (state.selectedTask?.catId === catId) Tasks.closePanel();
    App.render(); App.saveState();
  });
};

// ========== TASK CRUD ==========
let modalLinks = [];

Tasks.renderModalLinks = function() {
  const container = document.getElementById('mLinksContainer');
  if (!container) return;
  let html = '';
  if (modalLinks.length > 0) {
    html += '<div class="modal-links-list">';
    for (let i = 0; i < modalLinks.length; i++) {
      const link = modalLinks[i];
      html += `<div class="modal-link-item">
        <span class="link-title">${Utils.esc(link.title || 'Link')}</span>
        <span class="link-url">${Utils.esc(link.url)}</span>
        <button class="s-action" onclick="Tasks.removeModalLink(${i})" title="Remove">&#10005;</button>
      </div>`;
    }
    html += '</div>';
  }
  html += `<div class="modal-link-add">
    <input id="mLinkTitle" placeholder="Title" style="flex:0.35">
    <input id="mLinkUrl" placeholder="https://..." style="flex:0.65" onkeydown="if(event.key==='Enter'){event.preventDefault();Tasks.addModalLink()}">
    <button onclick="Tasks.addModalLink()">+ Add</button>
  </div>`;
  container.innerHTML = html;
}

Tasks.addModalLink = function() {
  const titleEl = document.getElementById('mLinkTitle');
  const urlEl = document.getElementById('mLinkUrl');
  if (!urlEl) return;
  const url = urlEl.value.trim();
  if (!url) return;
  const title = titleEl?.value.trim() || 'Link';
  modalLinks.push({ title, url });
  Tasks.renderModalLinks();
};

Tasks.removeModalLink = function(idx) {
  modalLinks.splice(idx, 1);
  Tasks.renderModalLinks();
};

Tasks.buildTaskModalBody = function(opts = {}) {
  const { name, startDate, endDate, status, notes, isEdit, lastUpdated, predecessors, dependents, type } = opts;
  const today = Utils.toStr(Utils.todayDate());
  const startVal = startDate || today;
  const endVal = endDate || Utils.toStr(Utils.addDays(Utils.toDate(startVal), 6));

  // Dependency banners
  let depBannerHtml = '';
  const hasPreds = predecessors && predecessors.length > 0;
  const hasDeps = dependents && dependents.length > 0;
  if (hasPreds && hasDeps) {
    depBannerHtml = `<div class="dep-banner is-both">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 17L17 7M17 7H8M17 7V16"/></svg>
      <div class="dep-banner-content">
        <span class="dep-banner-label">Dependency Chain</span>
        <span class="dep-banner-detail">Depends on: ${predecessors.map(p => Utils.esc(p.name)).join(', ')}</span>
        <span class="dep-banner-detail">Blocks: ${dependents.map(d => Utils.esc(d.name)).join(', ')}</span>
      </div>
    </div>`;
  } else if (hasPreds) {
    const latestPred = predecessors.reduce((a, b) => Utils.toDate(a.endDate) > Utils.toDate(b.endDate) ? a : b);
    depBannerHtml = `<div class="dep-banner is-dependent">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
      <div class="dep-banner-content">
        <span class="dep-banner-label">Dependent Task</span>
        <span class="dep-banner-detail">Depends on: ${predecessors.map(p => Utils.esc(p.name)).join(', ')} &mdash; cannot start before ${Utils.formatDateShort(Utils.addDays(Utils.toDate(latestPred.endDate), 1))}</span>
      </div>
    </div>`;
  } else if (hasDeps) {
    depBannerHtml = `<div class="dep-banner is-master">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
      <div class="dep-banner-content">
        <span class="dep-banner-label">Master Task</span>
        <span class="dep-banner-detail">Blocks: ${dependents.map(d => Utils.esc(d.name)).join(', ')} &mdash; changing dates will cascade</span>
      </div>
    </div>`;
  }

  // Compute min start date for dependent tasks
  let minStartAttr = '';
  let startHint = '';
  if (hasPreds) {
    const latestPred = predecessors.reduce((a, b) => Utils.toDate(a.endDate) > Utils.toDate(b.endDate) ? a : b);
    const minDate = Utils.toStr(Utils.addDays(Utils.toDate(latestPred.endDate), 1));
    minStartAttr = ` min="${minDate}" onchange="Tasks.clampModalStartDate('${minDate}')"`;
    startHint = `<div class="field-hint">Earliest: ${Utils.formatDateShort(Utils.toDate(minDate))}</div>`;
  }

  return `
    ${depBannerHtml}
    <div class="form-group">
      <label>Task Name</label>
      <input id="mTaskName" value="${Utils.esc(name || '')}" placeholder="Enter task name" ${!isEdit ? 'autofocus' : ''}>
    </div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="form-group" style="flex:1">
        <label>Type</label>
        <select id="mType" onchange="Tasks.onTypeChange(this.value)">
          <option value="task"${(!type || type === 'task') ? ' selected' : ''}>Task</option>
          <option value="milestone"${type === 'milestone' ? ' selected' : ''}>Milestone</option>
        </select>
      </div>
    </div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="form-group">
        <label>Start Date</label>
        <input id="mStartDate" type="date" value="${startVal}"${minStartAttr}>
        ${startHint}
      </div>
      <div class="form-group" id="mEndDateGroup"${type === 'milestone' ? ' style="display:none"' : ''}>
        <label>End Date</label>
        <input id="mEndDate" type="date" value="${type === 'milestone' ? startVal : endVal}">
      </div>
    </div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="form-group" style="flex:1">
        <label>Status</label>
        <div class="status-select-wrap">
          <span class="status-dot" id="mStatusDot" style="background:${Utils.statusColor(status || 'draft')}"></span>
          <select id="mStatus" style="color:${Utils.statusColor(status || 'draft')};font-weight:600" onchange="this.style.color=Utils.statusColor(this.value);document.getElementById('mStatusDot').style.background=Utils.statusColor(this.value)">${STATUS_OPTIONS.map(s => `<option value="${s.value}" style="color:${s.color}"${s.value === (status || 'draft') ? ' selected' : ''}>${s.label}</option>`).join('')}</select>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="mNotes" rows="2" placeholder="Add notes...">${Utils.esc(notes || '')}</textarea>
    </div>
    <div class="form-group" style="margin-bottom:0">
      <label>Links</label>
      <div id="mLinksContainer"></div>
    </div>
    ${lastUpdated ? `<div class="modal-meta">Last updated: ${new Date(lastUpdated).toLocaleString()}</div>` : ''}`;
};

Tasks.onTypeChange = function(val) {
  const endGroup = document.getElementById('mEndDateGroup');
  if (!endGroup) return;
  if (val === 'milestone') {
    endGroup.style.display = 'none';
    document.getElementById('mEndDate').value = document.getElementById('mStartDate').value;
  } else {
    endGroup.style.display = '';
  }
};

Tasks.showAddTaskModal = function(catId, projectIdOrStart, prefillEnd, prefillStart2) {
  modalLinks = [];
  // Determine if second arg is projectId or prefillStart date
  let projectId = null, prefillStart = null;
  if (projectIdOrStart && projectIdOrStart.startsWith && projectIdOrStart.startsWith('id_')) {
    projectId = projectIdOrStart;
    prefillStart = prefillStart2 || null;
  } else {
    prefillStart = projectIdOrStart;
  }
  const proj = projectId ? Projects.findProject(catId, projectId) : null;
  const headerText = proj ? `Add Task to "${Utils.esc(proj.name)}"` : 'New Task';
  const html = `
    <div class="modal-header">${headerText}<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      ${Tasks.buildTaskModalBody({ startDate: prefillStart, endDate: prefillEnd })}
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Tasks.doAddTask('${catId}'${projectId ? ",'" + projectId + "'" : ''})">Add Task</button>
    </div>`;
  UI.openModal(html);
  Tasks.renderModalLinks();
  setTimeout(() => document.getElementById('mTaskName')?.focus(), 100);
};

Tasks.doAddTask = function(catId, projectId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  const name = document.getElementById('mTaskName').value.trim();
  if (!name) return;
  const type = document.getElementById('mType')?.value || 'task';
  const startDate = document.getElementById('mStartDate').value;
  const endDate = type === 'milestone' ? startDate : document.getElementById('mEndDate').value;
  // If no projectId, create a new project with the task name
  if (!projectId) {
    const proj = { id: Utils.uid(), name, notes: '', color: cat.color };
    if (!cat.projects) cat.projects = [];
    cat.projects.push(proj);
    projectId = proj.id;
  }
  cat.tasks.push({
    id: Utils.uid(),
    name,
    type,
    projectId,
    startDate,
    endDate,
    status: document.getElementById('mStatus').value,
    notes: document.getElementById('mNotes').value,
    urls: [...modalLinks],
    dependencies: [],
    lastUpdated: new Date().toISOString()
  });
  modalLinks = [];
  UI.closeModal(); App.render(); App.saveState();
};

Tasks.getTaskDepInfo = function(catId, taskId) {
  const cat = Utils.findCat(catId);
  const task = Utils.findTask(catId, taskId);
  if (!cat || !task) return { predecessors: [], dependents: [] };
  const predecessors = (task.dependencies || []).map(id => Utils.findTask(catId, id)).filter(Boolean);
  const dependents = cat.tasks.filter(t => t.dependencies && t.dependencies.includes(taskId));
  return { predecessors, dependents };
};

Tasks.clampModalStartDate = function(minDate) {
  const el = document.getElementById('mStartDate');
  if (!el) return;
  if (el.value < minDate) el.value = minDate;
};

Tasks.showEditTaskModal = function(catId, taskId) {
  const task = Utils.findTask(catId, taskId);
  if (!task) return;
  modalLinks = [...(task.urls || [])];
  const { predecessors, dependents } = Tasks.getTaskDepInfo(catId, taskId);
  const html = `
    <div class="modal-header">Edit Task<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      ${Tasks.buildTaskModalBody({ name: task.name, startDate: task.startDate, endDate: task.endDate, status: task.status, notes: task.notes, isEdit: true, lastUpdated: task.lastUpdated, predecessors, dependents, type: task.type })}
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="UI.closeModal();Tasks.deleteTask('${catId}','${taskId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="Tasks.doEditTask('${catId}','${taskId}')">Save</button>
    </div>`;
  UI.openModal(html);
  Tasks.renderModalLinks();
};

Tasks.doEditTask = function(catId, taskId) {
  const task = Utils.findTask(catId, taskId);
  if (!task) return;
  task.name = document.getElementById('mTaskName').value.trim() || task.name;
  const newType = document.getElementById('mType')?.value || task.type || 'task';
  task.type = newType;
  let newStart = document.getElementById('mStartDate').value;
  let newEnd = document.getElementById('mEndDate').value;
  if (task.type === 'milestone') newEnd = newStart;
  // Enforce: dependent task cannot start before predecessor ends
  const { predecessors } = Tasks.getTaskDepInfo(catId, taskId);
  if (predecessors.length > 0) {
    const latestPredEnd = predecessors.reduce((a, b) => Utils.toDate(a.endDate) > Utils.toDate(b.endDate) ? a : b).endDate;
    const minStart = Utils.toStr(Utils.addDays(Utils.toDate(latestPredEnd), 1));
    if (newStart < minStart) {
      const shift = Utils.diffDays(newStart, minStart);
      newStart = minStart;
      newEnd = Utils.toStr(Utils.addDays(Utils.toDate(newEnd), shift));
    }
  }
  if (task.type === 'milestone') newEnd = newStart;
  task.startDate = newStart;
  task.endDate = newEnd;
  task.status = document.getElementById('mStatus').value;
  task.notes = document.getElementById('mNotes').value;
  task.urls = [...modalLinks];
  task.lastUpdated = new Date().toISOString();
  modalLinks = [];
  Deps.enforceAllDependencies(catId, taskId);
  UI.closeModal(); App.render(); App.saveState();
  if (state.selectedTask?.taskId === taskId) Tasks.renderPanel();
};

Tasks.deleteTask = function(catId, taskId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  const task = Utils.findTask(catId, taskId);
  if (!task) return;
  UI.showConfirmModal('Delete Task', `Are you sure you want to delete "${Utils.esc(task.name)}"? This cannot be undone.`, () => {
    // Clean up dependency references
    for (const t of cat.tasks) {
      if (t.dependencies) {
        t.dependencies = t.dependencies.filter(id => id !== taskId);
      }
    }
    cat.tasks = cat.tasks.filter(t => t.id !== taskId);
    if (state.selectedTask?.taskId === taskId) Tasks.closePanel();
    App.render(); App.saveState();
  });
};

// ========== DETAIL PANEL ==========
Tasks.openPanel = function(catId, taskId) {
  UI.hideTooltip();
  state.selectedTask = { catId, taskId };
  Tasks.renderPanel();
  $panelOverlay.classList.add('open');
  $detailPanel.classList.add('open');
  App.render();
};

Tasks.closePanel = function() {
  state.selectedTask = null;
  $panelOverlay.classList.remove('open');
  $detailPanel.classList.remove('open');
  App.render();
};

Tasks.renderPanel = function() {
  if (!state.selectedTask) return;
  const { catId, taskId } = state.selectedTask;
  const cat = Utils.findCat(catId);
  const task = Utils.findTask(catId, taskId);
  if (!cat || !task) { Tasks.closePanel(); return; }

  const statusOpt = STATUS_OPTIONS.find(s => s.value === task.status) || STATUS_OPTIONS[0];

  $detailPanel.innerHTML = `
    <div class="dp-header">
      <span class="dp-breadcrumb">${Utils.esc(cat.name)}${(() => { const proj = (cat.projects || []).find(p => p.id === task.projectId); return proj ? ' / ' + Utils.esc(proj.name) : ''; })()} / ${Utils.esc(task.name)}</span>
      <button class="s-action" onclick="Tasks.closePanel()">&#10005;</button>
    </div>
    <div class="dp-title-row">
      <div class="dp-color-dot" style="background:${(() => { const proj = (cat.projects || []).find(p => p.id === task.projectId); return proj ? proj.color : cat.color; })()}"></div>
      <input class="dp-title-input" value="${Utils.esc(task.name)}" onchange="Tasks.panelUpdate('name',this.value)">
    </div>
    <div class="dp-body">
      <div class="dp-field">
        <label class="dp-label">Status</label>
        <div class="status-select-wrap">
          <span class="status-dot" id="dpStatusDot" style="background:${Utils.statusColor(task.status)}"></span>
          <select class="dp-select" style="color:${Utils.statusColor(task.status)};font-weight:600" onchange="this.style.color=Utils.statusColor(this.value);document.getElementById('dpStatusDot').style.background=Utils.statusColor(this.value);Tasks.panelUpdate('status',this.value)">
            ${STATUS_OPTIONS.map(s => `<option value="${s.value}" style="color:${s.color}"${s.value === task.status ? ' selected' : ''}>${s.label}</option>`).join('')}
          </select>
        </div>
      </div>
      ${task.type === 'milestone' ? `
      <div class="dp-field">
        <label class="dp-label">Date</label>
        <div class="dp-date-row">
          <input class="dp-input" type="date" value="${task.startDate}" onchange="Tasks.panelUpdate('startDate',this.value);Tasks.panelUpdate('endDate',this.value)" style="flex:1">
        </div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Milestone</div>
      </div>
      ` : `
      <div class="dp-field">
        <label class="dp-label">Dates</label>
        <div class="dp-date-row">
          <input class="dp-input" type="date" value="${task.startDate}" onchange="Tasks.panelUpdate('startDate',this.value)" style="flex:1">
          <span>&rarr;</span>
          <input class="dp-input" type="date" value="${task.endDate}" onchange="Tasks.panelUpdate('endDate',this.value)" style="flex:1">
        </div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">${Utils.diffDays(task.startDate, task.endDate) + 1} days</div>
      </div>
      `}
      <div class="dp-field">
        <label class="dp-label">Notes</label>
        <textarea class="dp-textarea" onchange="Tasks.panelUpdate('notes',this.value)">${Utils.esc(task.notes)}</textarea>
      </div>
      ${task.lastUpdated ? `<div style="font-size:11px;color:var(--text3);padding:0 0 8px">Last updated: ${new Date(task.lastUpdated).toLocaleString()}</div>` : ''}
      <div class="dp-field">
        <label class="dp-label">Links</label>
        <div class="url-list" id="dpUrlList">
          ${(task.urls || []).map((u, i) => `<div class="url-item">
            <span class="url-item-title">${Utils.esc(u.title || 'Link')}</span>
            <a href="${Utils.esc(u.url)}" target="_blank" rel="noopener">${Utils.esc(u.url)}</a>
            <button class="s-action" onclick="Tasks.removeUrl(${i})" title="Remove">&#10005;</button>
          </div>`).join('')}
        </div>
        <div class="url-add-row">
          <div class="url-add-inputs">
            <input id="dpUrlTitle" placeholder="Title" style="flex:0.4">
            <input id="dpUrlValue" placeholder="https://..." style="flex:0.6">
            <button class="btn btn-icon" onclick="Tasks.addUrlFromPanel()" title="Add link" style="flex-shrink:0">+</button>
          </div>
        </div>
      </div>
      ${(() => {
        const predecessors = (task.dependencies || []).map(id => Utils.findTask(catId, id)).filter(Boolean);
        const dependents = cat.tasks.filter(t => t.dependencies && t.dependencies.includes(task.id));
        if (predecessors.length === 0 && dependents.length === 0) return '';
        let depHtml = '<div class="dp-field"><label class="dp-label">Dependencies</label>';
        if (predecessors.length > 0) {
          depHtml += '<div style="font-size:11px;color:var(--text3);margin-bottom:4px">Depends on:</div>';
          for (const p of predecessors) {
            depHtml += `<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:2px">
              <span style="color:var(--text2)">${Utils.esc(p.name)} (${Utils.formatDateShort(Utils.toDate(p.endDate))})</span>
              <button class="s-action" onclick="Tasks.removeDep('${catId}','${task.id}','${p.id}')" title="Remove">&#10005;</button>
            </div>`;
          }
        }
        if (dependents.length > 0) {
          depHtml += '<div style="font-size:11px;color:var(--text3);margin-bottom:4px;margin-top:6px">Blocks:</div>';
          for (const d of dependents) {
            depHtml += `<div style="font-size:12px;color:var(--text2);margin-bottom:2px">${Utils.esc(d.name)} (${Utils.formatDateShort(Utils.toDate(d.startDate))})</div>`;
          }
        }
        depHtml += '</div>';
        return depHtml;
      })()}
    </div>
    <div class="dp-footer">
      <button class="btn btn-danger" onclick="Tasks.closePanel();Tasks.deleteTask('${catId}','${taskId}')">Delete</button>
      <button class="btn btn-primary" onclick="Tasks.closePanel()">Done</button>
    </div>`;
};

Tasks.panelUpdate = function(key, value) {
  if (!state.selectedTask) return;
  const task = Utils.findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task) return;
  // Clamp start date for dependent tasks
  if (key === 'startDate' && task.dependencies && task.dependencies.length > 0) {
    const { predecessors } = Tasks.getTaskDepInfo(state.selectedTask.catId, state.selectedTask.taskId);
    if (predecessors.length > 0) {
      const latestPredEnd = predecessors.reduce((a, b) => Utils.toDate(a.endDate) > Utils.toDate(b.endDate) ? a : b).endDate;
      const minStart = Utils.toStr(Utils.addDays(Utils.toDate(latestPredEnd), 1));
      if (value < minStart) value = minStart;
    }
  }
  task[key] = value;
  if (task.type === 'milestone' && (key === 'startDate' || key === 'endDate')) {
    task.startDate = task.endDate = value;
  }
  task.lastUpdated = new Date().toISOString();
  if (key === 'startDate' || key === 'endDate') {
    Deps.enforceAllDependencies(state.selectedTask.catId, state.selectedTask.taskId);
  }
  App.render(); App.saveState();
  Tasks.renderPanel();
};

Tasks.addUrlFromPanel = function() {
  if (!state.selectedTask) return;
  const task = Utils.findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task) return;
  const title = document.getElementById('dpUrlTitle')?.value.trim() || 'Link';
  const url = document.getElementById('dpUrlValue')?.value.trim();
  if (!url) return;
  if (!task.urls) task.urls = [];
  task.urls.push({ title, url });
  App.render(); App.saveState();
  Tasks.renderPanel();
};

Tasks.removeDep = function(catId, taskId, predId) {
  const task = Utils.findTask(catId, taskId);
  if (!task || !task.dependencies) return;
  task.dependencies = task.dependencies.filter(id => id !== predId);
  App.render(); App.saveState();
  Tasks.renderPanel();
};

Tasks.removeUrl = function(idx) {
  if (!state.selectedTask) return;
  const task = Utils.findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task || !task.urls) return;
  task.urls.splice(idx, 1);
  App.render(); App.saveState();
  Tasks.renderPanel();
};

// ========== MODAL ==========
UI.openModal = function(html) {
  UI.hideTooltip();
  $modal.innerHTML = html;
  $modalBg.classList.add('open');
};
UI.closeModal = function() { $modalBg.classList.remove('open'); };

let _confirmCb = null;
UI.showConfirmModal = function(title, message, onConfirm) {
  _confirmCb = onConfirm;
  const html = `
    <div class="modal-header" style="color:var(--red)">${title}<button class="s-action" onclick="UI.closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin:0">${message}</p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="UI.closeModal()">Cancel</button>
      <button class="btn btn-danger" onclick="_confirmCb&&_confirmCb();UI.closeModal()">Delete</button>
    </div>`;
  UI.openModal(html);
};

UI.pickColor = function(el) {
  el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
};

// ========== PROJECT NAME ==========
const $projectName = document.getElementById('projectName');

Portfolio.editProjectName = function() {
  Portfolio.closePortfolioDropdown();
  const wrap = document.querySelector('.portfolio-title-wrap');
  const current = state.projectName;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = current;
  input.className = 'project-name-input';
  wrap.style.display = 'none';
  wrap.parentNode.insertBefore(input, wrap.nextSibling);
  input.focus();
  input.select();

  function commit() {
    const val = input.value.trim() || current;
    state.projectName = val;
    input.remove();
    wrap.style.display = '';
    Portfolio.applyProjectName();
    App.saveState();
  }

  input.addEventListener('blur', commit);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') input.blur();
    if (e.key === 'Escape') { input.value = current; input.blur(); }
  });
};

Portfolio.applyProjectName = function() {
  const span = document.getElementById('projectName');
  if (span) span.textContent = state.projectName;
  document.title = `Resource Manager - ${state.projectName}`;
};

Portfolio.applyOrgName = function() {
  const el = document.getElementById('orgName');
  if (el) el.textContent = state.orgName;
};

Portfolio.editOrgName = function() {
  const el = document.getElementById('orgName');
  if (!el) return;
  const current = state.orgName;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = current;
  input.className = 'org-name-input';
  el.replaceWith(input);
  input.focus();
  input.select();

  function commit() {
    const val = input.value.trim() || current;
    state.orgName = val;
    const newEl = document.createElement('span');
    newEl.id = 'orgName';
    newEl.className = 'org-name';
    newEl.textContent = val;
    newEl.title = 'Click to rename organization';
    newEl.onclick = Portfolio.editOrgName;
    input.replaceWith(newEl);
    Portfolio.saveGlobalSettings();
  }

  input.addEventListener('blur', commit);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') input.blur();
    if (e.key === 'Escape') { input.value = current; input.blur(); }
  });
};

// ========== PORTFOLIO DROPDOWN ==========
let portfolioDropdownOpen = false;

Portfolio.togglePortfolioDropdown = function(e) {
  e.stopPropagation();
  if (portfolioDropdownOpen) { Portfolio.closePortfolioDropdown(); }
  else { Portfolio.openPortfolioDropdown(); }
};

Portfolio.openPortfolioDropdown = function() {
  Portfolio.renderPortfolioDropdown();
  $portfolioDropdown.style.display = '';
  portfolioDropdownOpen = true;
  setTimeout(() => document.addEventListener('click', Portfolio.closePortfolioDropdownOutside), 0);
};

Portfolio.closePortfolioDropdown = function() {
  $portfolioDropdown.style.display = 'none';
  portfolioDropdownOpen = false;
  document.removeEventListener('click', Portfolio.closePortfolioDropdownOutside);
};

Portfolio.closePortfolioDropdownOutside = function(e) {
  if (!$portfolioDropdown.contains(e.target) && !e.target.closest('.portfolio-title-wrap')) {
    Portfolio.closePortfolioDropdown();
  }
};

Portfolio.renderPortfolioDropdown = function() {
  const reg = Portfolio.getPortfolioRegistry();
  let html = '';
  for (const p of reg) {
    const isActive = p.id === state.activePortfolioId;
    const check = isActive ? '<svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>' : '<span style="width:14px;display:inline-block"></span>';
    html += `<div class="portfolio-item${isActive ? ' active' : ''}" onclick="Portfolio.handlePortfolioClick('${p.id}')">${check}<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${Utils.esc(p.name)}</span></div>`;
  }
  html += '<div class="portfolio-divider"></div>';
  html += '<div class="portfolio-action" onclick="Portfolio.handleNewPortfolio()">+ New Portfolio</div>';
  html += '<div class="portfolio-action" onclick="Portfolio.handleRenamePortfolio()">Rename</div>';
  html += '<div class="portfolio-action" onclick="Portfolio.handleDuplicatePortfolio()">Duplicate</div>';
  if (reg.length > 1) {
    html += `<div class="portfolio-action" style="color:var(--red)" onclick="Portfolio.handleDeletePortfolio()">Delete</div>`;
  }
  $portfolioDropdown.innerHTML = html;
};

Portfolio.handlePortfolioClick = function(id) {
  Portfolio.closePortfolioDropdown();
  if (id !== state.activePortfolioId) Portfolio.switchPortfolio(id);
};

Portfolio.handleNewPortfolio = function() {
  Portfolio.closePortfolioDropdown();
  const name = prompt('New portfolio name:', 'New Portfolio');
  if (!name || !name.trim()) return;
  App.saveState();
  Portfolio.createPortfolio(name.trim(), true);
  Portfolio.applyProjectName();
  state.zoom = 'weeks';
  $zoomSelect.value = 'weeks';
  App.goToday();
};

Portfolio.handleRenamePortfolio = function() {
  Portfolio.closePortfolioDropdown();
  Portfolio.editProjectName();
};

Portfolio.handleDuplicatePortfolio = function() {
  Portfolio.closePortfolioDropdown();
  App.saveState();
  Portfolio.duplicatePortfolio(state.activePortfolioId);
};

Portfolio.handleDeletePortfolio = function() {
  Portfolio.closePortfolioDropdown();
  const reg = Portfolio.getPortfolioRegistry();
  if (reg.length <= 1) return;
  const entry = reg.find(p => p.id === state.activePortfolioId);
  if (!confirm(`Delete portfolio "${entry ? entry.name : ''}"? This cannot be undone.`)) return;
  Portfolio.deletePortfolio(state.activePortfolioId);
};

// ========== ADD MENU ==========
Sidebar.showAddMenu = function(e) {
  e.stopPropagation();
  const items = [
    { label: '+ New Program', action: () => Sidebar.showAddCatModal() },
    ...state.categories.map(c => ({
      label: `+ Project in "${c.name}"`,
      action: () => Projects.showAddProjectModal(c.id)
    }))
  ];
  UI.showCtxMenu(e.clientX, e.clientY, items);
};

// ========== CONTEXT MENU ==========
UI.showCtxMenu = function(x, y, items) {
  let html = '';
  for (const item of items) {
    html += `<div class="ctx-item${item.danger ? ' danger' : ''}" data-idx="${items.indexOf(item)}">${item.label}</div>`;
  }
  $ctxMenu.innerHTML = html;
  $ctxMenu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
  $ctxMenu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
  $ctxMenu.classList.add('open');
  $ctxMenu._items = items;
  $ctxMenu.querySelectorAll('.ctx-item').forEach(el => {
    el.addEventListener('click', () => {
      items[Number(el.dataset.idx)].action();
      UI.closeCtxMenu();
    });
  });
};

UI.closeCtxMenu = function() { $ctxMenu.classList.remove('open'); };

Sidebar.showCatCtx = function(e, catId) {
  e.preventDefault(); e.stopPropagation();
  UI.showCtxMenu(e.clientX, e.clientY, [
    { label: 'Add Project', action: () => Projects.showAddProjectModal(catId) },
    { label: 'Edit Program', action: () => Sidebar.showEditCatModal(catId) },
    { label: 'Delete Program', danger: true, action: () => Sidebar.deleteCat(catId) }
  ]);
};

Sidebar.showProjectCtx = function(e, catId, projectId) {
  e.preventDefault(); e.stopPropagation();
  UI.showCtxMenu(e.clientX, e.clientY, [
    { label: 'Add Task', action: () => Tasks.showAddTaskModal(catId, projectId) },
    { label: 'Edit Project', action: () => Projects.showEditProjectModal(catId, projectId) },
    { label: 'Delete Project', danger: true, action: () => Projects.deleteProject(catId, projectId) }
  ]);
};

document.addEventListener('click', () => UI.closeCtxMenu());
document.addEventListener('contextmenu', (e) => {
  if (!e.target.closest('.s-cat-header') && !e.target.closest('.s-task')) UI.closeCtxMenu();
});

// ========== SIDEBAR REORDER ==========
Drag.onGripMouseDown = function(e, catId, projectId, pIdx) {
  e.stopPropagation();
  e.preventDefault();
  const row = e.target.closest('.s-task');
  if (!row) return;
  Drag.reorderState = {
    catId,
    projectId,
    fromIdx: pIdx,
    row,
    startY: e.clientY,
    started: false,
    indicator: null
  };
};


Drag.reorderGroup = function(catId, projectId, fromGroupIdx, toGroupIdx) {
  const cat = Utils.findCat(catId);
  if (!cat || !cat.projects) return;
  if (fromGroupIdx < 0 || fromGroupIdx >= cat.projects.length) return;
  if (toGroupIdx < 0 || toGroupIdx >= cat.projects.length) return;
  // Reorder cat.projects
  const [movedProj] = cat.projects.splice(fromGroupIdx, 1);
  cat.projects.splice(toGroupIdx, 0, movedProj);
  // Rebuild cat.tasks in new project order
  const tasksByProject = new Map();
  for (const proj of cat.projects) tasksByProject.set(proj.id, []);
  const orphaned = [];
  for (const task of cat.tasks) {
    if (tasksByProject.has(task.projectId)) {
      tasksByProject.get(task.projectId).push(task);
    } else {
      orphaned.push(task);
    }
  }
  cat.tasks = [];
  for (const proj of cat.projects) {
    cat.tasks.push(...tasksByProject.get(proj.id));
  }
  cat.tasks.push(...orphaned);
  App.render();
  App.saveState();
};

// ========== DRAG: REORDER CATEGORIES ==========
Drag.onCatGripMouseDown = function(e, catId, catIdx) {
  e.stopPropagation();
  e.preventDefault();
  const catEl = e.target.closest('.s-cat');
  if (!catEl) return;
  Drag.catReorderState = {
    catId,
    fromIdx: catIdx,
    catEl,
    startY: e.clientY,
    started: false,
    indicator: null
  };
};


// ========== DRAG: HELPERS ==========

Drag.showDragLabel = function(x, y, text) {
  if (!Drag.$dragDateLabel) {
    Drag.$dragDateLabel = document.createElement('div');
    Drag.$dragDateLabel.className = 'drag-date-label';
    document.body.appendChild(Drag.$dragDateLabel);
  }
  Drag.$dragDateLabel.textContent = text;
  Drag.$dragDateLabel.style.left = x + 'px';
  Drag.$dragDateLabel.style.top = y + 'px';
  Drag.$dragDateLabel.style.display = 'block';
};

Drag.hideDragLabel = function() {
  if (Drag.$dragDateLabel) Drag.$dragDateLabel.style.display = 'none';
};

Drag.calcBarPos = function(startDate, endDate) {
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const tStart = Utils.diffDays(Utils.toStr(state.viewStart), startDate);
  const tDur = Utils.diffDays(startDate, endDate) + 1;
  return { left: tStart * dayW, width: Math.max(tDur * dayW - 2, 20) };
};

Drag.pixelToDate = function(pixelX) {
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const dayOffset = Math.floor(pixelX / dayW);
  return Utils.toStr(Utils.addDays(state.viewStart, dayOffset));
};

Drag.timelinePixelX = function(e) {
  const rect = $timelineWrap.getBoundingClientRect();
  return e.clientX - rect.left + $timelineWrap.scrollLeft;
};

// ========== DRAG: MOVE/RESIZE TASK BARS ==========
Drag.onBarMouseDown = function(e, catId, taskId) {
  if (e.button !== 0) return;
  e.stopPropagation();
  e.preventDefault();
  const bar = e.target.closest('.task-bar') || e.target.closest('.milestone-diamond');
  if (!bar) return;
  const task = Utils.findTask(catId, taskId);
  if (!task) return;

  const isLeft = e.target.classList.contains('left');
  const isRight = e.target.classList.contains('right');
  const mode = (task.type === 'milestone') ? 'move' : (isLeft ? 'resize-start' : isRight ? 'resize-end' : 'move');

  Drag.dragState = {
    catId, taskId, mode,
    startX: e.clientX,
    startY: e.clientY,
    origStart: task.startDate,
    origEnd: task.endDate,
    dayWidth: ZOOM_CFG[state.zoom].dayWidth,
    bar,
    hasMoved: false,
    lastDayDelta: 0
  };
};

// (drag-to-create removed — use sidebar "+" buttons to add tasks)


// ========== DEPENDENCIES ==========
Deps.enforceDependency = function(catId, predId, depId) {
  const pred = Utils.findTask(catId, predId);
  const dep = Utils.findTask(catId, depId);
  if (!pred || !dep) return;
  const minStart = Utils.toStr(Utils.addDays(Utils.toDate(pred.endDate), 1));
  if (Utils.toDate(dep.startDate) < Utils.toDate(minStart)) {
    const shift = Utils.diffDays(dep.startDate, minStart);
    dep.startDate = minStart;
    dep.endDate = Utils.toStr(Utils.addDays(Utils.toDate(dep.endDate), shift));
    Deps.cascadeDependencies(catId, dep.id);
  }
};

Deps.cascadeDependencies = function(catId, movedTaskId) {
  const cat = Utils.findCat(catId);
  if (!cat) return;
  for (const task of cat.tasks) {
    if (task.dependencies && task.dependencies.includes(movedTaskId)) {
      Deps.enforceDependency(catId, movedTaskId, task.id);
    }
  }
};

Deps.enforceAllDependencies = function(catId, taskId) {
  Deps.cascadeDependencies(catId, taskId);
};

Deps.wouldCreateCycle = function(catId, fromId, toId) {
  const visited = new Set();
  function dfs(taskId) {
    if (taskId === toId) return true;
    if (visited.has(taskId)) return false;
    visited.add(taskId);
    const task = Utils.findTask(catId, taskId);
    if (!task || !task.dependencies) return false;
    for (const depId of task.dependencies) {
      if (dfs(depId)) return true;
    }
    return false;
  }
  return dfs(fromId);
};

Deps.onDepBubbleMouseDown = function(e, catId, taskId) {
  e.stopPropagation();
  e.preventDefault();
  const bar = e.target.closest('.task-bar') || e.target.closest('.milestone-diamond');
  if (!bar) return;
  const barRect = bar.getBoundingClientRect();
  Drag.depDragState = {
    catId,
    fromTaskId: taskId,
    startX: barRect.right,
    startY: barRect.top + barRect.height / 2,
    svgLine: null,
    started: false
  };
};

Deps.showDepCtx = function(e, catId, fromId, toId) {
  e.preventDefault();
  e.stopPropagation();
  UI.showCtxMenu(e.clientX, e.clientY, [
    { label: 'Remove dependency', danger: true, action: () => {
      const depTask = Utils.findTask(catId, toId);
      if (depTask && depTask.dependencies) {
        depTask.dependencies = depTask.dependencies.filter(id => id !== fromId);
        App.render(); App.saveState();
      }
    }}
  ]);
};

// ========== UNIFIED MOUSE DISPATCH ==========
Drag.handleSidebarResizeMove = function(e) {
  const newW = Math.max(120, Math.min(500, Drag.sidebarResizeState.startW + (e.clientX - Drag.sidebarResizeState.startX)));
  $sidebar.style.width = newW + 'px';
};
Drag.handleSidebarResizeUp = function() {
  Drag.sidebarResizeState = null;
  $sidebarResize.classList.remove('active');
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
};
Drag.handleCreateDragMove = function(e) {
  const dx = e.clientX - Drag.createDragState.startX;
  if (!Drag.createDragState.moved && Math.abs(dx) < 4) return;
  Drag.createDragState.moved = true;

  const currentPx = Drag.timelinePixelX(e);
  const leftPx = Math.min(Drag.createDragState.pixelX, currentPx);
  const widthPx = Math.max(Math.abs(currentPx - Drag.createDragState.pixelX), ZOOM_CFG[state.zoom].dayWidth);

  // Create or update ghost bar
  if (!Drag.createDragState.ghostBar) {
    const ghost = document.createElement('div');
    ghost.className = 'ghost-bar';
    ghost.style.background = Drag.createDragState.color;
    Drag.createDragState.taskRow.appendChild(ghost);
    Drag.createDragState.ghostBar = ghost;
    document.body.style.cursor = 'crosshair';
  }
  Drag.createDragState.ghostBar.style.left = leftPx + 'px';
  Drag.createDragState.ghostBar.style.width = widthPx + 'px';

  // Show date label
  const startDate = Drag.pixelToDate(Math.min(Drag.createDragState.pixelX, currentPx));
  const endDate = Drag.pixelToDate(Math.max(Drag.createDragState.pixelX, currentPx));
  const dur = Utils.diffDays(startDate, endDate) + 1;
  Drag.showDragLabel(e.clientX, Drag.createDragState.taskRow.getBoundingClientRect().top,
    `${Utils.formatDateShort(Utils.toDate(startDate))} → ${Utils.formatDateShort(Utils.toDate(endDate))}  (${dur}d)`);
};
Drag.handlePanMove = function(e) {
  const dx = e.clientX - Drag.panState.startX;
  const dy = e.clientY - Drag.panState.startY;
  if (!Drag.panState.moved && Math.abs(dx) < 4 && Math.abs(dy) < 4) return;
  Drag.panState.moved = true;
  $timelineWrap.scrollLeft = Drag.panState.scrollLeft - dx;
  $timelineWrap.scrollTop = Drag.panState.scrollTop - dy;
};
Drag.handleCreateDragUp = function(e) {
  const { catId, projectId, moved, ghostBar, pixelX } = Drag.createDragState;
  if (ghostBar) ghostBar.remove();
  Drag.hideDragLabel();
  document.body.style.cursor = '';

  if (moved) {
    const currentPx = Drag.timelinePixelX(e);
    const startDate = Drag.pixelToDate(Math.min(pixelX, currentPx));
    const endDate = Drag.pixelToDate(Math.max(pixelX, currentPx));
    Drag.createDragState = null;
    if (projectId) {
      Tasks.showAddTaskModal(catId, projectId, endDate, startDate);
    } else {
      Tasks.showAddTaskModal(catId, startDate, endDate);
    }
  } else {
    Drag.createDragState = null;
  }
};
Drag.handleTaskReorderMove = function(e) {
  if (!Drag.reorderState.started) {
    if (Math.abs(e.clientY - Drag.reorderState.startY) < 4) return;
    Drag.reorderState.started = true;
    Drag.reorderState.row.classList.add('drag-ghost');
    document.body.style.cursor = 'grabbing';
  }
  // Find all .s-task rows in the same category
  const catEl = Drag.reorderState.row.closest('.s-cat');
  if (!catEl) return;
  const rows = [...catEl.querySelectorAll('.s-task')];
  // Remove old indicator
  if (Drag.reorderState.indicator) Drag.reorderState.indicator.remove();
  // Find insertion point
  let insertIdx = rows.length;
  for (let i = 0; i < rows.length; i++) {
    const rect = rows[i].getBoundingClientRect();
    if (e.clientY < rect.top + rect.height / 2) {
      insertIdx = i;
      break;
    }
  }
  Drag.reorderState.insertIdx = insertIdx;
  // Show indicator line
  const indicator = document.createElement('div');
  indicator.className = 's-reorder-line';
  if (insertIdx < rows.length) {
    rows[insertIdx].style.position = 'relative';
    indicator.style.top = '0px';
    rows[insertIdx].prepend(indicator);
  } else if (rows.length > 0) {
    rows[rows.length - 1].style.position = 'relative';
    indicator.style.bottom = '0px';
    indicator.style.top = 'auto';
    rows[rows.length - 1].append(indicator);
  }
  Drag.reorderState.indicator = indicator;
};
Drag.handleTaskReorderUp = function(e) {
  if (Drag.reorderState.indicator) Drag.reorderState.indicator.remove();
  Drag.reorderState.row.classList.remove('drag-ghost');
  document.body.style.cursor = '';
  if (Drag.reorderState.started && Drag.reorderState.insertIdx !== undefined) {
    const fromIdx = Drag.reorderState.fromIdx;
    let toIdx = Drag.reorderState.insertIdx;
    if (fromIdx !== toIdx && fromIdx !== toIdx - 1) {
      Drag.reorderGroup(Drag.reorderState.catId, Drag.reorderState.projectId, fromIdx, toIdx > fromIdx ? toIdx - 1 : toIdx);
    }
  }
  Drag.reorderState = null;
};
Drag.handleCatReorderMove = function(e) {
  if (!Drag.catReorderState.started) {
    if (Math.abs(e.clientY - Drag.catReorderState.startY) < 4) return;
    Drag.catReorderState.started = true;
    Drag.catReorderState.catEl.classList.add('cat-drag-ghost');
    document.body.style.cursor = 'grabbing';
  }
  const allCats = [...$sidebarBody.querySelectorAll('.s-cat')];
  if (Drag.catReorderState.indicator) Drag.catReorderState.indicator.remove();
  // Find insertion point
  let insertIdx = allCats.length;
  for (let i = 0; i < allCats.length; i++) {
    const rect = allCats[i].getBoundingClientRect();
    if (e.clientY < rect.top + rect.height / 2) {
      insertIdx = i;
      break;
    }
  }
  Drag.catReorderState.insertIdx = insertIdx;
  // Show indicator line
  const indicator = document.createElement('div');
  indicator.className = 's-cat-reorder-line';
  if (insertIdx < allCats.length) {
    allCats[insertIdx].style.position = 'relative';
    indicator.style.top = '0px';
    allCats[insertIdx].prepend(indicator);
  } else if (allCats.length > 0) {
    allCats[allCats.length - 1].style.position = 'relative';
    indicator.style.bottom = '0px';
    indicator.style.top = 'auto';
    allCats[allCats.length - 1].append(indicator);
  }
  Drag.catReorderState.indicator = indicator;
};
Drag.handleCatReorderUp = function() {
  if (Drag.catReorderState.indicator) Drag.catReorderState.indicator.remove();
  Drag.catReorderState.catEl.classList.remove('cat-drag-ghost');
  document.body.style.cursor = '';
  if (Drag.catReorderState.started && Drag.catReorderState.insertIdx !== undefined) {
    const fromIdx = Drag.catReorderState.fromIdx;
    let toIdx = Drag.catReorderState.insertIdx;
    if (fromIdx !== toIdx && fromIdx !== toIdx - 1) {
      const adjustedTo = toIdx > fromIdx ? toIdx - 1 : toIdx;
      const [moved] = state.categories.splice(fromIdx, 1);
      state.categories.splice(adjustedTo, 0, moved);
      App.render();
      App.saveState();
    }
  }
  Drag.catReorderState = null;
};
Drag.handleBarDragMove = function(e) {
  const dx = e.clientX - Drag.dragState.startX;

  // Detect if drag threshold crossed
  if (!Drag.dragState.hasMoved) {
    if (Math.abs(dx) > 3) {
      Drag.dragState.hasMoved = true;
      Drag.dragState.bar.classList.add('dragging');
      document.body.classList.add(Drag.dragState.mode === 'move' ? 'dragging' : 'resizing');
      UI.hideTooltip();
    } else {
      return;
    }
  }

  const dayDelta = Math.round(dx / Drag.dragState.dayWidth);
  if (dayDelta === Drag.dragState.lastDayDelta) {
    // Only update label position, skip DOM changes
    const task = Utils.findTask(Drag.dragState.catId, Drag.dragState.taskId);
    if (task) {
      if (task.type === 'milestone') {
        Drag.showDragLabel(e.clientX, Drag.dragState.bar.getBoundingClientRect().top,
          `${Utils.formatDateShort(Utils.toDate(task.startDate))}`);
      } else {
        const dur = Utils.diffDays(task.startDate, task.endDate) + 1;
        Drag.showDragLabel(e.clientX, Drag.dragState.bar.getBoundingClientRect().top,
          `${Utils.formatDateShort(Utils.toDate(task.startDate))} \u2192 ${Utils.formatDateShort(Utils.toDate(task.endDate))}  (${dur}d)`);
      }
    }
    return;
  }
  Drag.dragState.lastDayDelta = dayDelta;

  // Compute new dates
  let newStart, newEnd;
  if (Drag.dragState.mode === 'move') {
    newStart = Utils.toStr(Utils.addDays(Utils.toDate(Drag.dragState.origStart), dayDelta));
    newEnd = Utils.toStr(Utils.addDays(Utils.toDate(Drag.dragState.origEnd), dayDelta));
  } else if (Drag.dragState.mode === 'resize-start') {
    newStart = Utils.toStr(Utils.addDays(Utils.toDate(Drag.dragState.origStart), dayDelta));
    newEnd = Drag.dragState.origEnd;
    if (Utils.toDate(newStart) > Utils.toDate(newEnd)) newStart = newEnd;
  } else {
    newStart = Drag.dragState.origStart;
    newEnd = Utils.toStr(Utils.addDays(Utils.toDate(Drag.dragState.origEnd), dayDelta));
    if (Utils.toDate(newEnd) < Utils.toDate(newStart)) newEnd = newStart;
  }

  // Milestones: endDate always equals startDate
  const dragTaskForType = Utils.findTask(Drag.dragState.catId, Drag.dragState.taskId);
  if (dragTaskForType && dragTaskForType.type === 'milestone') {
    newEnd = newStart;
  }

  // Clamp: dependent task cannot start before predecessor ends
  const dragTask = dragTaskForType;
  if (dragTask && dragTask.dependencies && dragTask.dependencies.length > 0) {
    const cat = Utils.findCat(Drag.dragState.catId);
    if (cat) {
      let latestPredEnd = null;
      for (const predId of dragTask.dependencies) {
        const pred = cat.tasks.find(t => t.id === predId);
        if (pred) {
          const pe = Utils.toDate(pred.endDate);
          if (!latestPredEnd || pe > latestPredEnd) latestPredEnd = pe;
        }
      }
      if (latestPredEnd) {
        const minStart = Utils.toStr(Utils.addDays(latestPredEnd, 1));
        if (newStart < minStart) {
          if (Drag.dragState.mode === 'move') {
            const shift = Utils.diffDays(newStart, minStart);
            newStart = minStart;
            newEnd = Utils.toStr(Utils.addDays(Utils.toDate(newEnd), shift));
          } else {
            newStart = minStart;
          }
        }
      }
    }
  }

  // For milestones re-sync after clamping
  if (dragTaskForType && dragTaskForType.type === 'milestone') {
    newEnd = newStart;
  }

  // Update bar position directly (no re-render)
  const pos = Drag.calcBarPos(newStart, newEnd);
  if (dragTaskForType && dragTaskForType.type === 'milestone') {
    Drag.dragState.bar.style.left = pos.left + 'px';
  } else {
    Drag.dragState.bar.style.left = pos.left + 'px';
    Drag.dragState.bar.style.width = pos.width + 'px';
  }

  // Store computed dates on dragState for commit on mouseup
  Drag.dragState.newStart = newStart;
  Drag.dragState.newEnd = newEnd;

  // Show floating date label
  if (dragTaskForType && dragTaskForType.type === 'milestone') {
    Drag.showDragLabel(e.clientX, Drag.dragState.bar.getBoundingClientRect().top,
      `${Utils.formatDateShort(Utils.toDate(newStart))}`);
  } else {
    const dur = Utils.diffDays(newStart, newEnd) + 1;
    Drag.showDragLabel(e.clientX, Drag.dragState.bar.getBoundingClientRect().top,
      `${Utils.formatDateShort(Utils.toDate(newStart))} \u2192 ${Utils.formatDateShort(Utils.toDate(newEnd))}  (${dur}d)`);
  }
};
Drag.handleDepDragMove = function(e) {
  if (!Drag.depDragState.started) {
    Drag.depDragState.started = true;
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:500';
    svg.innerHTML = `<line x1="${Drag.depDragState.startX}" y1="${Drag.depDragState.startY}" x2="${e.clientX}" y2="${e.clientY}" stroke="#6b7280" stroke-width="2" stroke-dasharray="6,3"/>`;
    document.body.appendChild(svg);
    Drag.depDragState.svgLine = svg;
  }
  if (Drag.depDragState.svgLine) {
    const line = Drag.depDragState.svgLine.querySelector('line');
    line.setAttribute('x2', e.clientX);
    line.setAttribute('y2', e.clientY);
  }
};
Drag.handleBarDragUp = function(e) {
  const wasClick = !Drag.dragState.hasMoved;
  const catId = Drag.dragState.catId;
  const taskId = Drag.dragState.taskId;

  // Clean up visual state
  Drag.dragState.bar.classList.remove('dragging');
  document.body.classList.remove('dragging', 'resizing');
  Drag.hideDragLabel();

  if (wasClick) {
    Drag.dragState = null;
    Tasks.openPanel(catId, taskId);
  } else {
    // Commit the date changes to state
    const task = Utils.findTask(catId, taskId);
    if (task && Drag.dragState.newStart && Drag.dragState.newEnd) {
      task.startDate = Drag.dragState.newStart;
      task.endDate = Drag.dragState.newEnd;
      Deps.enforceAllDependencies(catId, taskId);
    }
    Drag.dragState = null;
    App.render();
    App.saveState();
  }
};
Drag.handleDepDragUp = function(e) {
  if (Drag.depDragState.svgLine) Drag.depDragState.svgLine.remove();
  if (Drag.depDragState.started) {
    const el = document.elementFromPoint(e.clientX, e.clientY);
    const targetBar = el?.closest('.task-bar') || el?.closest('.milestone-diamond');
    if (targetBar) {
      const toTaskId = targetBar.dataset.task;
      const toCatId = targetBar.dataset.cat;
      if (toTaskId && toTaskId !== Drag.depDragState.fromTaskId && toCatId === Drag.depDragState.catId) {
        const fromTask = Utils.findTask(Drag.depDragState.catId, Drag.depDragState.fromTaskId);
        const toTask = Utils.findTask(toCatId, toTaskId);
        if (fromTask && toTask && fromTask.projectId === toTask.projectId) {
          if (!Deps.wouldCreateCycle(Drag.depDragState.catId, Drag.depDragState.fromTaskId, toTaskId)) {
            if (!toTask.dependencies) toTask.dependencies = [];
            if (!toTask.dependencies.includes(Drag.depDragState.fromTaskId)) {
              toTask.dependencies.push(Drag.depDragState.fromTaskId);
              Deps.enforceDependency(Drag.depDragState.catId, Drag.depDragState.fromTaskId, toTaskId);
              App.render(); App.saveState();
            }
          }
        }
      }
    }
  }
  Drag.depDragState = null;
};
Drag.handleTooltipMove = function(e) {
  if ($tooltip.style.display === 'block') UI.positionTooltip(e);
};

document.addEventListener('mousemove', (e) => {
  if (Drag.sidebarResizeState) { Drag.handleSidebarResizeMove(e); return; }
  if (Drag.createDragState) { Drag.handleCreateDragMove(e); return; }
  if (Drag.panState) { Drag.handlePanMove(e); return; }
  if (Drag.reorderState) { Drag.handleTaskReorderMove(e); return; }
  if (Drag.catReorderState) { Drag.handleCatReorderMove(e); return; }
  if (Drag.dragState) Drag.handleBarDragMove(e);
  if (Drag.depDragState) Drag.handleDepDragMove(e);
  Drag.handleTooltipMove(e);
});

document.addEventListener('mouseup', (e) => {
  if (Drag.sidebarResizeState) Drag.handleSidebarResizeUp();
  if (Drag.createDragState) Drag.handleCreateDragUp(e);
  if (Drag.panState) { Drag.panState = null; }
  if (Drag.reorderState) Drag.handleTaskReorderUp(e);
  if (Drag.catReorderState) Drag.handleCatReorderUp();
  if (Drag.dragState) Drag.handleBarDragUp(e);
  if (Drag.depDragState) Drag.handleDepDragUp(e);
});

// ========== TOOLTIP ==========
UI.showBarTooltip = function(e, catId, taskId) {
  if ($panelOverlay.classList.contains('open') || $modalBg.classList.contains('open') || $aiPanel.classList.contains('open')) return;
  const task = Utils.findTask(catId, taskId);
  const cat = Utils.findCat(catId);
  if (!task || !cat) return;
  const sOpt = STATUS_OPTIONS.find(s => s.value === task.status);
  const sLabel = sOpt ? sOpt.label : task.status;
  const proj = (cat.projects || []).find(p => p.id === task.projectId);
  const projPrefix = proj ? proj.name + ' \u203A ' : '';
  if (task.type === 'milestone') {
    $tooltip.textContent = `\u25C6 ${projPrefix}${task.name} | ${sLabel} | ${Utils.formatDateShort(Utils.toDate(task.startDate))}`;
  } else {
    const dur = Utils.diffDays(task.startDate, task.endDate) + 1;
    $tooltip.textContent = `${projPrefix}${task.name} | ${sLabel} | ${Utils.formatDateShort(Utils.toDate(task.startDate))} - ${Utils.formatDateShort(Utils.toDate(task.endDate))} (${dur}d)`;
  }
  $tooltip.style.display = 'block';
  UI.positionTooltip(e);
};

UI.positionTooltip = function(e) {
  $tooltip.style.left = e.clientX + 'px';
  $tooltip.style.top = (e.clientY - 36) + 'px';
};

UI.hideTooltip = function() { $tooltip.style.display = 'none'; };

// ========== KEYBOARD ==========
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd+K to toggle command palette
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    if ($cmdBg.classList.contains('open')) Cmd.closeCmdPalette();
    else Cmd.openCmdPalette();
    return;
  }

  // Escape: close layers in priority order
  if (e.key === 'Escape') {
    if ($cmdBg.classList.contains('open')) { Cmd.closeCmdPalette(); return; }
    UI.closeModal(); Tasks.closePanel(); UI.closeCtxMenu(); AI.closeAI();
    return;
  }

  // Command palette keyboard nav
  if ($cmdBg.classList.contains('open')) {
    const query = $cmdInput.value.trim();
    const results = Cmd.searchAll(query);
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      cmdActiveIdx = Math.min(cmdActiveIdx + 1, results.length - 1);
      Cmd.renderCmdResults(query);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      cmdActiveIdx = Math.max(cmdActiveIdx - 1, 0);
      Cmd.renderCmdResults(query);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      Cmd.cmdSelect(cmdActiveIdx);
    }
    return;
  }

  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowLeft') App.navigate(-1);
  if (e.key === 'ArrowRight') App.navigate(1);
  if (e.key === 't' || e.key === 'T') App.goToday();
});

// ========== DARK MODE ==========
App.toggleDarkMode = function() {
  const isDark = document.documentElement.classList.toggle('dark');
  state.darkMode = isDark;
  App.updateDarkModeIcon(isDark);
  localStorage.setItem('rm_darkMode', isDark ? '1' : '0');
  App.render();
};

App.updateDarkModeIcon = function(isDark) {
  const btn = document.getElementById('darkModeBtn');
  if (!btn) return;
  btn.innerHTML = isDark
    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
    : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 0111.21 3 7 7 0 0012 21a9 9 0 009-8.21z"/></svg>';
  btn.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
};

App.initDarkMode = function() {
  const saved = localStorage.getItem('rm_darkMode');
  const isDark = saved === '1';
  state.darkMode = isDark;
  if (isDark) document.documentElement.classList.add('dark');
  App.updateDarkModeIcon(isDark);
};

// ========== AI PANEL ==========
AI.toggleAI = function() {
  if ($aiPanel.classList.contains('open')) AI.closeAI();
  else AI.openAI();
};

AI.openAI = function() {
  Tasks.closePanel();
  AI.renderAIPanel();
  $aiPanel.classList.add('open');
};

AI.closeAI = function() { $aiPanel.classList.remove('open'); };

AI.renderAIPanel = function() {
  let msgsHtml = '';
  if (!state.aiKey) {
    const gemSel = state.aiProvider === 'gemini' ? ' checked' : '';
    const custSel = state.aiProvider === 'custom' ? ' checked' : '';
    msgsHtml = `<div class="ai-key-setup">
      <div class="ai-setup-title">AI Assistant Setup</div>
      <div class="ai-setup-desc">Choose a provider and enter your API key to get started.</div>
      <div class="ai-provider-group">
        <label class="ai-provider-option${state.aiProvider === 'gemini' ? ' selected' : ''}">
          <input type="radio" name="aiProvider" value="gemini"${gemSel} onchange="state.aiProvider='gemini';AI.renderAIPanel()">
          <div class="ai-provider-label"><span class="ai-provider-name">Google Gemini</span><span class="ai-provider-tag">Free tier available</span></div>
        </label>
        <label class="ai-provider-option${state.aiProvider === 'custom' ? ' selected' : ''}">
          <input type="radio" name="aiProvider" value="custom"${custSel} onchange="state.aiProvider='custom';AI.renderAIPanel()">
          <div class="ai-provider-label"><span class="ai-provider-name">Custom LLM</span><span class="ai-provider-tag">OpenAI, Anthropic, Groq, Ollama, etc.</span></div>
        </label>
      </div>
      ${state.aiProvider === 'gemini' ? `
        <div class="ai-setup-fields">
          <input id="aiKeyInput" type="password" placeholder="Paste your Gemini API key">
        </div>
        <div class="ai-setup-action">
          <button class="btn btn-primary" onclick="AI.saveAIKey()">Save Key</button>
          <span class="ai-setup-hint"><a href="https://aistudio.google.com/app/apikey" target="_blank">Get a free API key from Google AI Studio &rarr;</a></span>
        </div>
      ` : `
        <div class="ai-setup-fields">
          <input id="aiCustomEndpointInput" type="text" placeholder="API Endpoint URL" value="${Utils.esc(state.aiCustomEndpoint)}">
          <input id="aiCustomModelInput" type="text" placeholder="Model name (e.g. gpt-4o)" value="${Utils.esc(state.aiCustomModel)}">
          <input id="aiKeyInput" type="password" placeholder="API Key">
        </div>
        <div class="ai-setup-action">
          <button class="btn btn-primary" onclick="AI.saveAIKey()">Save Key</button>
          <span class="ai-setup-hint">Works with any OpenAI-compatible API endpoint</span>
        </div>
      `}
    </div>`;
  } else {
    if (state.aiMessages.length === 0) {
      msgsHtml = `<div class="ai-msg system">AI Assistant ready. Ask questions about your projects, request schedule analysis, or get resource allocation suggestions.</div>`;
    }
    for (const msg of state.aiMessages) {
      msgsHtml += `<div class="ai-msg ${msg.role}">${Utils.escNl(msg.text)}</div>`;
    }
  }

  $aiPanel.innerHTML = `
    <div class="ai-header">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v3a4 4 0 01-8 0v-3H7a3 3 0 01-3-3v-2a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg> AI Assistant</h3>
      <div style="display:flex;gap:4px">
        ${state.aiKey ? `<button class="s-action" onclick="state.aiKey='';state.aiProvider='gemini';state.aiCustomEndpoint='';state.aiCustomModel='';state.aiMessages=[];App.saveState();AI.renderAIPanel()" title="Reset API Key">&#9881;</button>` : ''}
        <button class="s-action" onclick="AI.closeAI()">&#10005;</button>
      </div>
    </div>
    <div class="ai-messages" id="aiMessages">${msgsHtml}</div>
    ${state.aiKey ? `<div class="ai-input-row">
      <input class="ai-input" id="aiInput" placeholder="Ask about your projects..." onkeydown="if(event.key==='Enter')AI.sendAI()">
      <button class="btn btn-primary btn-icon" onclick="AI.sendAI()">&#10148;</button>
    </div>` : ''}`;

  // Scroll to bottom
  setTimeout(() => {
    const el = document.getElementById('aiMessages');
    if (el) el.scrollTop = el.scrollHeight;
  }, 50);
};

AI.saveAIKey = function() {
  const key = document.getElementById('aiKeyInput')?.value.trim();
  if (!key) return;
  state.aiKey = key;
  if (state.aiProvider === 'custom') {
    state.aiCustomEndpoint = document.getElementById('aiCustomEndpointInput')?.value.trim() || '';
    state.aiCustomModel = document.getElementById('aiCustomModelInput')?.value.trim() || '';
    if (!state.aiCustomEndpoint) { alert('Please enter an API endpoint URL.'); return; }
  }
  App.saveState();
  AI.renderAIPanel();
};

AI.sendAI = async function() {
  const input = document.getElementById('aiInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;

  // Validate API key is set
  if (!state.aiKey) {
    state.aiMessages.push({ role: 'user', text });
    state.aiMessages.push({ role: 'assistant', text: 'Please set up your API key in the AI Settings above before sending messages.' });
    App.saveState(); AI.renderAIPanel();
    return;
  }
  if (state.aiProvider === 'custom' && !state.aiCustomEndpoint) {
    state.aiMessages.push({ role: 'user', text });
    state.aiMessages.push({ role: 'assistant', text: 'Please enter your custom LLM endpoint URL in the AI Settings above.' });
    App.saveState(); AI.renderAIPanel();
    return;
  }

  input.value = '';
  state.aiMessages.push({ role: 'user', text });
  AI.renderAIPanel();

  // Build context
  const projectCtx = state.categories.map(c => {
    const tasks = c.tasks.map(t => {
      const dur = Utils.diffDays(t.startDate, t.endDate) + 1;
      return `  - ${t.name}: ${t.startDate} to ${t.endDate} (${dur} days), Status: ${t.status}, Links: ${(t.urls||[]).length}`;
    }).join('\n');
    return `Program: ${c.name}\n${tasks || '  (no tasks)'}`;
  }).join('\n\n');

  const today = Utils.toStr(Utils.todayDate());
  const systemPrompt = `You are an AI assistant for a project resource manager application. Today's date is ${today}. Here is the current project data:\n\n${projectCtx}\n\nHelp the user with project scheduling, resource analysis, timeline calculations, budget summaries, and planning suggestions. Be concise and practical. Format numbers clearly. If asked for calculations, show your work briefly.`;

  try {
    let reply;
    if (state.aiProvider === 'custom' && state.aiCustomEndpoint) {
      // Custom LLM (OpenAI-compatible endpoint)
      const endpoint = state.aiCustomEndpoint.replace(/\/+$/, '');
      const url = endpoint.includes('/chat/completions') ? endpoint : endpoint + '/chat/completions';
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${state.aiKey}`
        },
        body: JSON.stringify({
          model: state.aiCustomModel || 'gpt-3.5-turbo',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: text }
          ],
          max_tokens: 2048
        })
      });
      if (!response.ok) {
        const errData = await response.json().catch(() => ({}));
        throw new Error(errData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      reply = data?.choices?.[0]?.message?.content || 'Sorry, I could not generate a response.';
    } else {
      // Google Gemini (free)
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${state.aiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              { role: 'user', parts: [{ text: systemPrompt + '\n\nUser question: ' + text }] }
            ]
          })
        }
      );
      const data = await response.json();
      reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
    }
    state.aiMessages.push({ role: 'assistant', text: reply });
  } catch (err) {
    state.aiMessages.push({ role: 'assistant', text: 'Error: ' + err.message + '. Please check your API key and settings.' });
  }

  App.saveState();
  AI.renderAIPanel();
};

// ========== EXPORT CSV ==========
CSV.csvEscape = function(val) {
  if (val == null) return '';
  const str = String(val);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
};

CSV.exportCSV = function() {
  const headers = ['Program', 'Program Color', 'Type', 'Task Name', 'Project', 'Project Color', 'Start Date', 'End Date', 'Duration (days)', 'Status', 'Notes', 'Links', 'Dependencies'];
  const rows = [headers.map(CSV.csvEscape).join(',')];

  for (const cat of state.categories) {
    for (const task of cat.tasks) {
      const dur = Utils.diffDays(task.startDate, task.endDate) + 1;
      const links = (task.urls || []).map(u => u.title ? u.title + ': ' + u.url : u.url).join('; ');
      const deps = (task.dependencies || []).map(depId => {
        const depTask = cat.tasks.find(t => t.id === depId);
        return depTask ? depTask.name : depId;
      }).join('; ');
      const proj = (cat.projects || []).find(p => p.id === task.projectId);

      rows.push([
        CSV.csvEscape(cat.name),
        CSV.csvEscape(cat.color),
        CSV.csvEscape(task.type || 'task'),
        CSV.csvEscape(task.name),
        CSV.csvEscape(proj ? proj.name : ''),
        CSV.csvEscape(proj ? proj.color : ''),
        CSV.csvEscape(task.startDate),
        CSV.csvEscape(task.endDate),
        CSV.csvEscape(dur),
        CSV.csvEscape(task.status),
        CSV.csvEscape(task.notes),
        CSV.csvEscape(links),
        CSV.csvEscape(deps)
      ].join(','));
    }
  }

  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (state.projectName || 'project') + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

// ========== IMPORT CSV ==========
CSV.parseCSVRow = function(line) {
  const cells = [];
  let cur = '', inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQuotes) {
      if (ch === '"' && line[i + 1] === '"') { cur += '"'; i++; }
      else if (ch === '"') inQuotes = false;
      else cur += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { cells.push(cur); cur = ''; }
      else cur += ch;
    }
  }
  cells.push(cur);
  return cells;
};

CSV.importCSV = function(input) {
  const file = input.files[0];
  if (!file) return;
  input.value = '';

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) { alert('CSV file is empty or has no data rows.'); return; }

    const headerRow = CSV.parseCSVRow(lines[0]);
    const hMap = {};
    headerRow.forEach((h, i) => hMap[h.trim()] = i);

    const required = ['Task Name', 'Start Date', 'End Date'];
    const missing = required.filter(r => hMap[r] === undefined);
    if (hMap['Program'] === undefined && hMap['Category'] === undefined) missing.unshift('Program');
    if (missing.length) { alert('Missing required columns: ' + missing.join(', ')); return; }

    const catIdx = hMap['Program'] !== undefined ? hMap['Program'] : hMap['Category'];
    const colorIdx = hMap['Program Color'] !== undefined ? hMap['Program Color'] : hMap['Category Color'];
    const nameIdx = hMap['Task Name'];
    const groupIdx = hMap['Project'] !== undefined ? hMap['Project'] : hMap['Group'];
    const projColorIdx = hMap['Project Color'];
    const startIdx = hMap['Start Date'];
    const endIdx = hMap['End Date'];
    const statusIdx = hMap['Status'];
    const notesIdx = hMap['Notes'];
    const linksIdx = hMap['Links'];
    const depsIdx = hMap['Dependencies'];
    const typeIdx = hMap['Type'];

    const catMap = new Map();
    const taskRows = [];

    for (let i = 1; i < lines.length; i++) {
      const cells = CSV.parseCSVRow(lines[i]);
      const catName = (cells[catIdx] || '').trim();
      const taskName = (cells[nameIdx] || '').trim();
      if (!catName || !taskName) continue;

      const startDate = (cells[startIdx] || '').trim();
      const endDate = (cells[endIdx] || '').trim();
      if (!startDate || !endDate) continue;

      if (!catMap.has(catName)) {
        const color = colorIdx !== undefined ? (cells[colorIdx] || '').trim() : '';
        catMap.set(catName, {
          id: Utils.uid(), name: catName,
          color: /^#[0-9a-fA-F]{6}$/.test(color) ? color : '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
          collapsed: false, tasks: []
        });
      }

      let status = statusIdx !== undefined ? (cells[statusIdx] || '').trim().toLowerCase() : 'draft';
      if (!STATUS_OPTIONS.find(s => s.value === status)) {
        if (status === 'in planning') status = 'planning';
        else if (!STATUS_OPTIONS.find(s => s.value === status)) status = 'draft';
      }

      const urls = [];
      if (linksIdx !== undefined && cells[linksIdx]) {
        cells[linksIdx].split(';').forEach(part => {
          part = part.trim();
          if (!part) return;
          const colonIdx = part.indexOf(': http');
          if (colonIdx > 0) {
            urls.push({ title: part.slice(0, colonIdx).trim(), url: part.slice(colonIdx + 2).trim() });
          } else if (part.startsWith('http')) {
            urls.push({ title: '', url: part });
          }
        });
      }

      const taskType = typeIdx !== undefined ? ((cells[typeIdx] || '').trim().toLowerCase() || 'task') : 'task';
      const resolvedEndDate = taskType === 'milestone' ? startDate : endDate;
      const task = {
        id: Utils.uid(),
        name: taskName,
        type: taskType,
        _projectName: groupIdx !== undefined && cells[groupIdx] ? cells[groupIdx].trim() : taskName,
        _projectColor: projColorIdx !== undefined ? (cells[projColorIdx] || '').trim() : '',
        startDate, endDate: resolvedEndDate, status,
        notes: notesIdx !== undefined ? (cells[notesIdx] || '') : '',
        urls,
        dependencies: [],
        lastUpdated: new Date().toISOString()
      };

      const depNames = depsIdx !== undefined && cells[depsIdx] ? cells[depsIdx].split(';').map(d => d.trim()).filter(Boolean) : [];

      catMap.get(catName).tasks.push(task);
      taskRows.push({ task, depNames, catName });
    }

    // Resolve dependency names to IDs within same category
    for (const { task, depNames, catName } of taskRows) {
      const cat = catMap.get(catName);
      for (const depName of depNames) {
        const dep = cat.tasks.find(t => t.name === depName && t.id !== task.id);
        if (dep) task.dependencies.push(dep.id);
      }
    }

    // Create project entities from imported tasks
    for (const [catName, cat] of catMap) {
      const projMap = new Map();
      const projOrder = [];
      for (const task of cat.tasks) {
        const pName = task._projectName || task.name;
        const pColor = task._projectColor && /^#[0-9a-fA-F]{6}$/.test(task._projectColor) ? task._projectColor : cat.color;
        if (!projMap.has(pName)) {
          const proj = { id: Utils.uid(), name: pName, notes: '', color: pColor };
          projMap.set(pName, proj);
          projOrder.push(proj);
        }
        task.projectId = projMap.get(pName).id;
        delete task._projectName;
        delete task._projectColor;
      }
      cat.projects = projOrder;
    }

    const newCats = Array.from(catMap.values());
    if (!newCats.length) { alert('No valid tasks found in CSV.'); return; }

    const mode = confirm(
      'Import ' + taskRows.length + ' task(s) across ' + newCats.length + ' program(s).\n\n' +
      'OK = Replace all existing data\nCancel = Merge with existing data'
    );

    if (mode) {
      state.categories = newCats;
    } else {
      for (const newCat of newCats) {
        const existing = state.categories.find(c => c.name.toLowerCase() === newCat.name.toLowerCase());
        if (existing) {
          for (const task of newCat.tasks) existing.tasks.push(task);
        } else {
          state.categories.push(newCat);
        }
      }
    }

    App.render();
    App.saveState();
    App.goToday();
  };
  reader.readAsText(file);
};

// ========== COMMAND PALETTE ==========
let cmdActiveIdx = -1;

Cmd.openCmdPalette = function() {
  $cmdBg.classList.add('open');
  $cmdInput.value = '';
  cmdActiveIdx = -1;
  Cmd.renderCmdResults('');
  setTimeout(() => $cmdInput.focus(), 50);
};

Cmd.closeCmdPalette = function() {
  $cmdBg.classList.remove('open');
  $cmdInput.blur();
};

Cmd.searchAll = function(query) {
  const q = query.toLowerCase().trim();
  if (!q) return [];
  const results = [];
  // Search portfolios (other than active)
  const reg = Portfolio.getPortfolioRegistry();
  for (const p of reg) {
    if (p.id !== state.activePortfolioId && p.name.toLowerCase().includes(q)) {
      results.push({
        type: 'portfolio', portfolioId: p.id,
        name: p.name, color: '#8b5cf6',
        meta: 'Switch to portfolio'
      });
    }
  }
  // Search current portfolio's programs and tasks
  for (const cat of state.categories) {
    if (cat.name.toLowerCase().includes(q)) {
      results.push({
        type: 'category', catId: cat.id, taskId: null,
        name: cat.name, color: cat.color,
        meta: (() => { const n = (cat.projects || []).length; return n + ' project' + (n !== 1 ? 's' : ''); })()
      });
    }
    // Search projects
    for (const proj of (cat.projects || [])) {
      if (proj.name.toLowerCase().includes(q)) {
        const taskCount = cat.tasks.filter(t => t.projectId === proj.id).length;
        results.push({
          type: 'project', catId: cat.id, projectId: proj.id,
          name: proj.name, color: proj.color,
          meta: cat.name + ' \u00b7 ' + taskCount + ' task' + (taskCount !== 1 ? 's' : '')
        });
      }
    }
    for (const task of cat.tasks) {
      if (task.name.toLowerCase().includes(q)) {
        const dur = Utils.diffDays(task.startDate, task.endDate) + 1;
        results.push({
          type: 'task', catId: cat.id, taskId: task.id,
          name: task.name, color: cat.color,
          meta: cat.name + ' \u00b7 ' + Utils.formatDateShort(Utils.toDate(task.startDate)) + ' \u2013 ' + Utils.formatDateShort(Utils.toDate(task.endDate)) + ' (' + dur + 'd)'
        });
      }
    }
  }
  return results;
};

Cmd.highlightMatch = function(text, query) {
  if (!query) return Utils.esc(text);
  const idx = text.toLowerCase().indexOf(query.toLowerCase());
  if (idx === -1) return Utils.esc(text);
  return Utils.esc(text.slice(0, idx)) + '<mark>' + Utils.esc(text.slice(idx, idx + query.length)) + '</mark>' + Utils.esc(text.slice(idx + query.length));
};

Cmd.renderCmdResults = function(query) {
  const results = Cmd.searchAll(query);
  if (!query.trim()) {
    $cmdResults.innerHTML = '<div class="cmd-empty">Type to search projects, programs, and portfolios\u2026</div>';
    return;
  }
  if (results.length === 0) {
    $cmdResults.innerHTML = '<div class="cmd-empty">No results for \u201c' + Utils.esc(query) + '\u201d</div>';
    return;
  }
  if (cmdActiveIdx >= results.length) cmdActiveIdx = results.length - 1;
  if (cmdActiveIdx < 0) cmdActiveIdx = 0;
  let html = '';
  for (let i = 0; i < results.length; i++) {
    const r = results[i];
    const active = i === cmdActiveIdx ? ' active' : '';
    html += '<div class="cmd-item' + active + '" data-idx="' + i + '" onmouseenter="Cmd.cmdHover(' + i + ')" onclick="Cmd.cmdSelect(' + i + ')">';
    html += '<div class="cmd-item-dot" style="background:' + r.color + '"></div>';
    html += '<div class="cmd-item-info">';
    html += '<div class="cmd-item-name">' + Cmd.highlightMatch(r.name, query) + '</div>';
    html += '<div class="cmd-item-meta">' + Utils.esc(r.meta) + '</div>';
    html += '</div>';
    html += '<div class="cmd-item-type">' + (r.type === 'category' ? 'program' : r.type === 'portfolio' ? 'portfolio' : r.type) + '</div>';
    html += '</div>';
  }
  $cmdResults.innerHTML = html;
  const activeEl = $cmdResults.querySelector('.cmd-item.active');
  if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
};

Cmd.cmdHover = function(idx) {
  cmdActiveIdx = idx;
  $cmdResults.querySelectorAll('.cmd-item').forEach((el, i) => {
    el.classList.toggle('active', i === idx);
  });
};

Cmd.cmdSelect = function(idx) {
  const query = $cmdInput.value.trim();
  const results = Cmd.searchAll(query);
  if (idx < 0 || idx >= results.length) return;
  const r = results[idx];
  Cmd.closeCmdPalette();

  if (r.type === 'portfolio') {
    Portfolio.switchPortfolio(r.portfolioId);
    return;
  }
  if (r.type === 'category') {
    const cat = Utils.findCat(r.catId);
    if (cat && cat.collapsed) { cat.collapsed = false; App.render(); App.saveState(); }
    setTimeout(() => {
      const el = $sidebarBody.querySelector('[data-cat="' + r.catId + '"] .s-cat-header');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
    return;
  }
  if (r.type === 'project') {
    const cat = Utils.findCat(r.catId);
    if (cat && cat.collapsed) { cat.collapsed = false; App.render(); App.saveState(); }
    setTimeout(() => {
      const el = $sidebarBody.querySelector('[data-project="' + r.projectId + '"]');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
    return;
  }
  {
    const cat = Utils.findCat(r.catId);
    if (cat && cat.collapsed) { cat.collapsed = false; App.render(); App.saveState(); }
    Cmd.scrollToTask(r.catId, r.taskId);
    setTimeout(() => Tasks.openPanel(r.catId, r.taskId), 100);
  }
};

Cmd.scrollToTask = function(catId, taskId) {
  const task = Utils.findTask(catId, taskId);
  if (!task) return;
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const totalDays = ZOOM_CFG[state.zoom].totalDays;
  const startOff = Utils.diffDays(Utils.toStr(state.viewStart), task.startDate);
  const endOff = Utils.diffDays(Utils.toStr(state.viewStart), task.endDate);
  const midOff = (startOff + endOff) / 2;

  if (midOff < 0 || midOff > totalDays) {
    const midDate = Utils.addDays(Utils.toDate(task.startDate), Math.floor(Utils.diffDays(task.startDate, task.endDate) / 2));
    state.viewStart = Utils.addDays(midDate, -Math.floor(totalDays / 3));
    App.render();
    const newStartOff = Utils.diffDays(Utils.toStr(state.viewStart), task.startDate);
    const newEndOff = Utils.diffDays(Utils.toStr(state.viewStart), task.endDate);
    const newMidPx = ((newStartOff + newEndOff) / 2) * dayW;
    $timelineWrap.scrollLeft = Math.max(0, newMidPx - $timelineWrap.clientWidth / 2);
  } else {
    $timelineWrap.scrollLeft = Math.max(0, midOff * dayW - $timelineWrap.clientWidth / 2);
  }

  const taskRow = task ? $sidebarBody.querySelector('.s-task[data-project="' + task.projectId + '"]') : null;
  if (taskRow) taskRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
};

$cmdInput.addEventListener('input', () => {
  cmdActiveIdx = 0;
  Cmd.renderCmdResults($cmdInput.value);
});

// ========== INIT ==========
App.init = async function() {
  if (FileStorage.isSupported()) {
    FileStorage._clearLocalPortfolioData(); // file is the source of truth; localStorage is session cache only
    const connected = await FileStorage.init();
    if (connected) {
      await FileStorage.importToLocalStorage();
      FileStorage.startPolling();
    }
    FileStorage._updateStatus(); // show setup or reconnect banner as appropriate
  }
  Portfolio.loadState();
  App.initDarkMode();
  // Only load sample data in localStorage-only mode (File System Access API not supported)
  if (state.categories.length === 0 && !FileStorage.isSupported()) App.loadSampleData();
  Portfolio.applyProjectName();
  Portfolio.applyOrgName();
  // Set initial view
  state.zoom = 'weeks';
  $zoomSelect.value = 'weeks';
  App.goToday();
};

// Handle enter in modal inputs
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && $modalBg.classList.contains('open')) {
    const btn = $modal.querySelector('.modal-footer .btn-primary');
    if (btn && e.target.tagName !== 'TEXTAREA') btn.click();
  }
});

App.init();
</script>
<div class="fs-toast" id="fsToast"></div>
</body>
</html>
