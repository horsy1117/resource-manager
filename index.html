<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resource Manager - Project Plan</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --sidebar-w:250px;
  --topbar-h:44px;
  --header-h:48px;
  --row-h:34px;
  --cat-row-h:32px;
  --border:#e5e7eb;
  --bg:#ffffff;
  --bg2:#f9fafb;
  --bg-weekend:rgba(0,0,0,.025);
  --text:#1f2937;
  --text2:#6b7280;
  --text3:#9ca3af;
  --blue:#3b82f6;
  --blue-light:#dbeafe;
  --red:#ef4444;
  --green:#10b981;
  --shadow:0 1px 3px rgba(0,0,0,.1);
  --day-w:120px;
}
html,body{height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;color:var(--text);background:var(--bg)}

/* ===== TOPBAR ===== */
.topbar{height:var(--topbar-h);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:var(--bg);z-index:100;position:relative}
.topbar h1{font-size:16px;font-weight:600;display:flex;align-items:center;gap:6px}
.project-name{cursor:pointer;border-radius:4px;padding:0 4px;transition:background .15s}
.project-name:hover{background:var(--bg2)}
.project-name-input{font-size:16px;font-weight:600;border:1px solid var(--blue);border-radius:4px;padding:0 4px;outline:none;background:var(--bg);color:var(--text);font-family:inherit}
.topbar-controls{display:flex;align-items:center;gap:6px}
.btn{border:1px solid var(--border);background:var(--bg);border-radius:5px;padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text);display:inline-flex;align-items:center;gap:4px;transition:all .15s}
.btn:hover{background:var(--bg2);border-color:#d1d5db}
.btn-primary{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn-primary:hover{background:#2563eb}
.btn-icon{padding:4px 6px;min-width:28px;justify-content:center}
.btn-danger{color:var(--red);border-color:var(--red)}
.btn-danger:hover{background:#fef2f2}
.zoom-select{border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;background:var(--bg);cursor:pointer;color:var(--text)}
.today-btn{font-weight:500}

/* ===== MAIN LAYOUT ===== */
.main-area{display:flex;flex:1;overflow:hidden;height:calc(100vh - var(--topbar-h))}
.sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg);z-index:10;position:relative}
.sidebar-header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;align-items:flex-end;padding:0 10px 6px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;background:var(--bg)}
.sidebar-body{flex:1;overflow-y:auto;overflow-x:hidden}
.sidebar-body::-webkit-scrollbar{width:0}

/* ===== SIDEBAR ROWS ===== */
.s-cat{}
.s-cat-header{height:var(--cat-row-h);display:flex;align-items:center;padding:0 8px 0 0;cursor:pointer;position:relative;background:var(--bg);border-bottom:1px solid var(--border)}
.s-cat-header:hover{filter:brightness(0.97)}
.s-cat-color{width:4px;height:100%;flex-shrink:0;border-radius:0 2px 2px 0}
.s-cat-toggle{width:28px;height:100%;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text3);font-size:10px;transition:transform .2s}
.s-cat-toggle.collapsed{transform:rotate(-90deg)}
.s-cat-name{flex:1;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.s-cat-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s}
.s-cat-header:hover .s-cat-actions{opacity:1}
.s-action{width:24px;height:24px;border:none;background:transparent;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:12px}
.s-action:hover{background:var(--border);color:var(--text)}

.s-task{min-height:var(--row-h);display:flex;align-items:center;padding:0 6px 0 28px;border-bottom:1px solid #f3f4f6;position:relative;cursor:pointer}
.s-task:hover{background:var(--bg2)}
.s-task.selected{background:var(--blue-light)}
.s-task-dot{width:7px;height:7px;border-radius:50%;margin-right:6px;flex-shrink:0}
.s-task-name{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.s-task-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s}
.s-task:hover .s-task-actions{opacity:1}

.s-add-row{height:24px;display:flex;align-items:center;padding:0 6px 0 28px;cursor:pointer;color:var(--text3);font-size:11px;gap:4px;border-bottom:1px solid #f3f4f6}
.s-add-row:hover{background:var(--bg2);color:var(--blue)}

.s-add-cat{height:32px;display:flex;align-items:center;padding:0 12px;cursor:pointer;color:var(--text3);font-size:12px;gap:6px;border-bottom:1px solid var(--border)}
.s-add-cat:hover{background:var(--bg2);color:var(--blue)}

/* ===== TIMELINE ===== */
.timeline{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
.timeline-header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;background:var(--bg);flex-shrink:0;position:relative}
.t-header-row{display:flex;height:50%}
.t-header-row.row1{border-bottom:1px solid #f3f4f6}
.t-group{display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text2);font-weight:500;border-right:1px solid #f3f4f6;white-space:nowrap;overflow:hidden}
.t-col{display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text3);border-right:1px solid #f3f4f6;white-space:nowrap;flex-shrink:0;position:relative}
.t-col.today{color:var(--blue);font-weight:700}
.t-col.today::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:22px;height:22px;background:var(--blue);border-radius:50%;z-index:-1;opacity:.1}
.t-col.weekend{background:var(--bg-weekend)}

.timeline-body-wrap{flex:1;overflow:auto;position:relative}
.timeline-body{position:relative;min-height:100%}
.t-grid{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0}
.t-weekend{position:absolute;top:0;bottom:0;background:var(--bg-weekend)}
.t-today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--blue);z-index:5;opacity:.6}
.t-gridline{position:absolute;top:0;bottom:0;width:1px;background:var(--border);opacity:.5}

.t-rows{position:relative;z-index:1}
.t-row{height:var(--row-h);position:relative;border-bottom:1px solid #f3f4f6}
.t-row.cat-row{height:var(--cat-row-h);background:var(--bg2);border-bottom:1px solid var(--border)}
.t-row.task-row{cursor:crosshair}
.t-row.task-row:hover{background:rgba(59,130,246,.02)}

/* ===== TASK BARS ===== */
.task-bar{position:absolute;top:6px;height:calc(var(--row-h) - 14px);border-radius:6px;display:flex;align-items:center;padding:0 8px;font-size:12px;font-weight:500;color:#fff;cursor:grab;z-index:2;transition:box-shadow .15s,filter .15s;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;user-select:none;min-width:24px}
.task-bar:hover{box-shadow:0 2px 8px rgba(0,0,0,.2);filter:brightness(1.05);z-index:3}
.task-bar .resize-handle{position:absolute;top:0;width:10px;height:100%;cursor:col-resize;z-index:1}
.task-bar .resize-handle.left{left:-2px}
.task-bar .resize-handle.right{right:-2px}
.task-bar-label{position:relative;z-index:0;pointer-events:none;text-shadow:0 1px 2px rgba(0,0,0,.2)}
.task-bar-dates{position:absolute;top:-16px;left:0;font-size:10px;color:var(--text3);white-space:nowrap;pointer-events:none;font-weight:400}
body.dragging{cursor:grabbing!important}
body.dragging *{cursor:grabbing!important}
body.resizing{cursor:col-resize!important}
body.resizing *{cursor:col-resize!important}
.task-bar.dragging{opacity:.85;z-index:10;box-shadow:0 4px 16px rgba(0,0,0,.25);transition:none}
.drag-date-label{position:fixed;background:#1f2937;color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;z-index:600;pointer-events:none;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.2);transform:translate(-50%,-100%);margin-top:-8px}

/* ===== DEPENDENCY BUBBLE ===== */
.dep-bubble{position:absolute;right:-5px;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.7);border:2px solid rgba(255,255,255,.9);cursor:crosshair;z-index:4;opacity:0;transition:opacity .15s}
.task-bar:hover .dep-bubble{opacity:1}
.dep-bubble:hover{background:#fff;transform:translateY(-50%) scale(1.3)}

/* ===== DEPENDENCY ARROWS ===== */
.dep-svg-overlay{position:absolute;top:0;left:0;pointer-events:none;z-index:3;overflow:visible}
.dep-arrow{fill:none;stroke:#6b7280;stroke-width:1.5;pointer-events:stroke;cursor:pointer}
.dep-arrow:hover{stroke:var(--red);stroke-width:2.5}

/* ===== URL LIST ===== */
.url-list{display:flex;flex-direction:column;gap:6px}
.url-item{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg2);border-radius:6px;font-size:13px;border:1px solid var(--border)}
.url-item a{color:var(--blue);text-decoration:none;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.url-item a:hover{text-decoration:underline}
.url-item-title{font-weight:500;color:var(--text);margin-right:4px;white-space:nowrap}
.url-item .s-action{flex-shrink:0}
.url-add-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.url-add-inputs{display:flex;gap:6px}
.url-add-inputs input{flex:1;border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px}
.url-add-inputs input:focus{outline:none;border-color:var(--blue)}
.url-add-btn{align-self:flex-start}

/* ===== DETAIL PANEL ===== */
.panel-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.15);z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.panel-overlay.open{opacity:1;pointer-events:auto}
.detail-panel{position:fixed;top:0;right:0;width:440px;height:100%;background:var(--bg);z-index:201;box-shadow:-4px 0 24px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.detail-panel.open{transform:translateX(0)}
.dp-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.dp-breadcrumb{font-size:12px;color:var(--text3)}
.dp-title-row{display:flex;align-items:center;gap:10px;padding:16px 20px}
.dp-color-dot{width:28px;height:28px;border-radius:50%;flex-shrink:0}
.dp-title-input{flex:1;font-size:18px;font-weight:600;border:none;outline:none;background:transparent;color:var(--text)}
.dp-body{flex:1;overflow-y:auto;padding:0 20px 20px}
.dp-field{margin-bottom:16px}
.dp-label{font-size:12px;color:var(--text3);margin-bottom:4px;display:block}
.dp-input,.dp-select,.dp-textarea{width:100%;border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:13px;font-family:inherit;color:var(--text);background:var(--bg)}
.dp-input:focus,.dp-select:focus,.dp-textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.dp-textarea{min-height:80px;resize:vertical}
.dp-date-row{display:flex;gap:8px;align-items:center}
.dp-date-row span{color:var(--text3)}
.dp-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:8px}

/* ===== MODAL ===== */
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:300;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--bg);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:360px;max-width:90vw;max-height:90vh;overflow-y:auto}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);font-size:16px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:20px}
.modal-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px;font-weight:500}
.form-group input,.form-group select,.form-group textarea{width:100%;border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:13px;font-family:inherit}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--blue)}
.color-picker{display:flex;gap:6px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .15s}
.color-swatch:hover{transform:scale(1.1)}
.color-swatch.selected{border-color:var(--text)}

/* ===== AI PANEL ===== */
.ai-panel{position:fixed;top:0;right:0;width:380px;height:100%;background:var(--bg);z-index:201;box-shadow:-4px 0 24px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.ai-panel.open{transform:translateX(0)}
.ai-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ai-header h3{font-size:15px;display:flex;align-items:center;gap:6px}
.ai-messages{flex:1;overflow-y:auto;padding:16px}
.ai-msg{margin-bottom:12px;padding:10px 14px;border-radius:10px;font-size:13px;line-height:1.5;max-width:90%}
.ai-msg.user{background:var(--blue);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
.ai-msg.assistant{background:var(--bg2);color:var(--text);border-bottom-left-radius:4px}
.ai-msg.system{background:#fef3c7;color:#92400e;font-size:12px;text-align:center;max-width:100%;border-radius:6px}
.ai-input-row{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px}
.ai-input{flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;font-family:inherit;resize:none;height:40px}
.ai-input:focus{outline:none;border-color:var(--blue)}
.ai-key-setup{padding:20px;text-align:center}
.ai-key-setup p{font-size:13px;color:var(--text2);margin-bottom:12px;line-height:1.5}
.ai-key-setup input{width:100%;border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:13px;margin-bottom:12px}
.ai-key-setup a{color:var(--blue);text-decoration:none;font-size:12px}

/* ===== CONTEXT MENU ===== */
.ctx-menu{position:fixed;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:500;min-width:160px;padding:4px;display:none}
.ctx-menu.open{display:block}
.ctx-item{padding:8px 12px;font-size:13px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px}
.ctx-item:hover{background:var(--bg2)}
.ctx-item.danger{color:var(--red)}
.ctx-item.danger:hover{background:#fef2f2}

/* ===== SCROLLBAR ===== */
.timeline-body-wrap::-webkit-scrollbar{width:8px;height:8px}
.timeline-body-wrap::-webkit-scrollbar-track{background:var(--bg2)}
.timeline-body-wrap::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}
.timeline-body-wrap::-webkit-scrollbar-thumb:hover{background:#9ca3af}

/* ===== EMPTY STATE ===== */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px;margin-bottom:8px}

/* ===== TOOLTIP ===== */
.tooltip{position:fixed;background:#1f2937;color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;z-index:600;pointer-events:none;white-space:nowrap;transform:translateX(-50%);box-shadow:0 2px 8px rgba(0,0,0,.2)}
</style>
</head>
<body>

<div id="app">
  <!-- Top Bar -->
  <div class="topbar">
    <h1>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span id="projectName" class="project-name" onclick="editProjectName()" title="Click to rename">Project Plan</span>
    </h1>
    <div class="topbar-controls">
      <button class="btn btn-icon" onclick="navigate(-1)" title="Previous">&#9664;</button>
      <button class="btn today-btn" onclick="goToday()">Today</button>
      <button class="btn btn-icon" onclick="navigate(1)" title="Next">&#9654;</button>
      <select class="zoom-select" id="zoomSelect" onchange="setZoom(this.value)">
        <option value="days">Days</option>
        <option value="weeks" selected>Weeks</option>
        <option value="months">Months</option>
        <option value="year">Year</option>
      </select>
      <button class="btn btn-primary btn-icon" onclick="showAddMenu(event)" title="Add">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="btn btn-icon" onclick="toggleAI()" title="AI Assistant" id="aiBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v3a4 4 0 01-8 0v-3H7a3 3 0 01-3-3v-2a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg>
      </button>
    </div>
  </div>

  <!-- Main Area -->
  <div class="main-area">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">Projects / Categories</div>
      <div class="sidebar-body" id="sidebarBody"></div>
    </div>
    <!-- Timeline -->
    <div class="timeline">
      <div class="timeline-header" id="timelineHeader"></div>
      <div class="timeline-body-wrap" id="timelineWrap">
        <div class="timeline-body" id="timelineBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- Panel Overlay -->
<div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
<div class="detail-panel" id="detailPanel"></div>

<!-- AI Panel -->
<div class="ai-panel" id="aiPanel"></div>

<!-- Modal -->
<div class="modal-bg" id="modalBg" onclick="event.target===this&&closeModal()">
  <div class="modal" id="modal"></div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu"></div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip" style="display:none"></div>

<script>
// ========== CONSTANTS ==========
const COLORS = ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316','#14b8a6','#6366f1','#e11d48','#84cc16'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const ZOOM_CFG = {
  days:   { dayWidth: 80,  totalDays: 56,  navStep: 7 },
  weeks:  { dayWidth: 36,  totalDays: 98,  navStep: 14 },
  months: { dayWidth: 14,  totalDays: 210, navStep: 30 },
  year:   { dayWidth: 3,   totalDays: 730, navStep: 90 }
};

const STATUS_OPTIONS = [
  { value: 'confirmed', label: 'Confirmed', color: '#10b981' },
  { value: 'tentative', label: 'Tentative', color: '#f59e0b' },
  { value: 'draft', label: 'Draft', color: '#9ca3af' }
];

// ========== STATE ==========
let state = {
  categories: [],
  zoom: 'weeks',
  viewStart: null,
  selectedTask: null,
  aiKey: '',
  aiMessages: [],
  projectName: 'Project Plan'
};

let dragState = null;
let createDragState = null;
let depDragState = null;

// ========== DOM REFS ==========
const $sidebarBody = document.getElementById('sidebarBody');
const $timelineHeader = document.getElementById('timelineHeader');
const $timelineBody = document.getElementById('timelineBody');
const $timelineWrap = document.getElementById('timelineWrap');
const $panelOverlay = document.getElementById('panelOverlay');
const $detailPanel = document.getElementById('detailPanel');
const $aiPanel = document.getElementById('aiPanel');
const $modalBg = document.getElementById('modalBg');
const $modal = document.getElementById('modal');
const $ctxMenu = document.getElementById('ctxMenu');
const $tooltip = document.getElementById('tooltip');
const $zoomSelect = document.getElementById('zoomSelect');

// ========== UTILITIES ==========
function uid() { return 'id_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36); }
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function toDate(s) {
  if (s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function toStr(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${dd}`;
}

function addDays(d, n) {
  const r = new Date(d);
  r.setDate(r.getDate() + n);
  return r;
}

function diffDays(a, b) {
  const msDay = 86400000;
  return Math.round((toDate(b) - toDate(a)) / msDay);
}

function getWeek(d) {
  const date = new Date(d);
  date.setHours(0, 0, 0, 0);
  date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
  const week1 = new Date(date.getFullYear(), 0, 4);
  return 1 + Math.round(((date - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
}

function formatDateShort(d) {
  return `${d.getDate()} ${MONTHS_SHORT[d.getMonth()]}`;
}

function formatDateLong(d) {
  return `${d.getDate()} ${MONTHS_SHORT[d.getMonth()]} ${d.getFullYear()}`;
}

function todayDate() {
  const t = new Date();
  return new Date(t.getFullYear(), t.getMonth(), t.getDate());
}

function lightenColor(hex, amount = 0.88) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  const lr = Math.round(r + (255 - r) * amount);
  const lg = Math.round(g + (255 - g) * amount);
  const lb = Math.round(b + (255 - b) * amount);
  return `rgb(${lr},${lg},${lb})`;
}

function findCat(catId) { return state.categories.find(c => c.id === catId); }
function findTask(catId, taskId) {
  const cat = findCat(catId);
  return cat ? cat.tasks.find(t => t.id === taskId) : null;
}

// ========== PERSISTENCE ==========
function saveState() {
  const data = { categories: state.categories, aiKey: state.aiKey, projectName: state.projectName };
  localStorage.setItem('rm_state', JSON.stringify(data));
}

function loadState() {
  try {
    const raw = localStorage.getItem('rm_state');
    if (raw) {
      const data = JSON.parse(raw);
      if (data.categories) state.categories = data.categories;
      if (data.aiKey) state.aiKey = data.aiKey;
      if (data.projectName) state.projectName = data.projectName;
      // Migration: ensure every task has dependencies and urls arrays
      for (const cat of state.categories) {
        for (const task of cat.tasks) {
          if (!task.dependencies) task.dependencies = [];
          if (!task.urls) task.urls = [];
        }
      }
    }
  } catch (e) { console.warn('Failed to load state', e); }
}

// ========== SAMPLE DATA ==========
function loadSampleData() {
  const today = todayDate();
  state.categories = [
    {
      id: uid(), name: 'Website Redesign', color: '#3b82f6', collapsed: false,
      tasks: [
        { id: uid(), name: 'UX Research', startDate: toStr(addDays(today, -5)), endDate: toStr(addDays(today, 8)), status: 'confirmed', notes: 'User interviews and competitive analysis', urls: [{title:'Figma Board', url:'https://figma.com/example'}] },
        { id: uid(), name: 'Wireframing', startDate: toStr(addDays(today, 6)), endDate: toStr(addDays(today, 18)), status: 'confirmed', notes: '', urls: [] },
        { id: uid(), name: 'Visual Design', startDate: toStr(addDays(today, 15)), endDate: toStr(addDays(today, 30)), status: 'tentative', notes: 'Pending wireframe approval', urls: [] }
      ]
    },
    {
      id: uid(), name: 'Mobile App', color: '#10b981', collapsed: false,
      tasks: [
        { id: uid(), name: 'Sprint Planning', startDate: toStr(addDays(today, -2)), endDate: toStr(addDays(today, 1)), status: 'confirmed', notes: '', urls: [] },
        { id: uid(), name: 'Development Phase 1', startDate: toStr(addDays(today, 3)), endDate: toStr(addDays(today, 22)), status: 'confirmed', notes: 'Core features implementation', urls: [{title:'GitHub Repo', url:'https://github.com/example/app'}] },
        { id: uid(), name: 'QA Testing', startDate: toStr(addDays(today, 20)), endDate: toStr(addDays(today, 32)), status: 'draft', notes: '', urls: [] }
      ]
    },
    {
      id: uid(), name: 'Marketing Campaign', color: '#f59e0b', collapsed: false,
      tasks: [
        { id: uid(), name: 'Strategy', startDate: toStr(addDays(today, -8)), endDate: toStr(addDays(today, 2)), status: 'confirmed', notes: 'Define target audience and channels', urls: [] },
        { id: uid(), name: 'Content Creation', startDate: toStr(addDays(today, 1)), endDate: toStr(addDays(today, 16)), status: 'confirmed', notes: '', urls: [] },
        { id: uid(), name: 'Launch', startDate: toStr(addDays(today, 17)), endDate: toStr(addDays(today, 24)), status: 'tentative', notes: 'Dependent on content completion', urls: [] }
      ]
    },
    {
      id: uid(), name: 'Infrastructure', color: '#8b5cf6', collapsed: false,
      tasks: [
        { id: uid(), name: 'Cloud Migration', startDate: toStr(addDays(today, 0)), endDate: toStr(addDays(today, 14)), status: 'confirmed', notes: 'AWS to GCP migration', urls: [] },
        { id: uid(), name: 'CI/CD Pipeline', startDate: toStr(addDays(today, 10)), endDate: toStr(addDays(today, 20)), status: 'draft', notes: '', urls: [] }
      ]
    }
  ];
}

// ========== GROUPING ==========
const LANE_HEIGHT = 28;
const LANE_PADDING = 6;

function computeRowHeight(numLanes) {
  return numLanes * LANE_HEIGHT + LANE_PADDING;
}

function assignLanes(tasks) {
  const lanes = new Map();
  if (tasks.length <= 1) {
    if (tasks.length === 1) lanes.set(tasks[0].id, 0);
    return { lanes, numLanes: 1 };
  }
  const sorted = [...tasks].sort((a, b) => {
    const cmp = toDate(a.startDate) - toDate(b.startDate);
    return cmp !== 0 ? cmp : toDate(a.endDate) - toDate(b.endDate);
  });
  const laneEnds = [];
  for (const task of sorted) {
    const tStart = toDate(task.startDate);
    let assigned = -1;
    for (let i = 0; i < laneEnds.length; i++) {
      if (tStart > laneEnds[i]) {
        assigned = i;
        laneEnds[i] = toDate(task.endDate);
        break;
      }
    }
    if (assigned === -1) {
      assigned = laneEnds.length;
      laneEnds.push(toDate(task.endDate));
    }
    lanes.set(task.id, assigned);
  }
  return { lanes, numLanes: laneEnds.length };
}

function buildGroups() {
  const result = [];
  for (const cat of state.categories) {
    if (cat.collapsed) {
      result.push({ cat, groups: [] });
      continue;
    }
    const groupMap = new Map();
    const groupOrder = [];
    for (const task of cat.tasks) {
      if (!groupMap.has(task.name)) {
        groupMap.set(task.name, []);
        groupOrder.push(task.name);
      }
      groupMap.get(task.name).push(task);
    }
    const groups = [];
    for (const name of groupOrder) {
      const tasks = groupMap.get(name);
      const { lanes, numLanes } = assignLanes(tasks);
      const rowHeight = computeRowHeight(numLanes);
      groups.push({ groupName: name, catId: cat.id, tasks, lanes, numLanes, rowHeight });
    }
    result.push({ cat, groups });
  }
  return result;
}

// ========== RENDERING ==========
let cachedGroups = null;
function render() {
  cachedGroups = buildGroups();
  renderSidebar();
  renderTimeline();
}

function renderSidebar() {
  let html = '';
  const grouped = cachedGroups || buildGroups();
  for (const { cat, groups } of grouped) {
    const collapsed = cat.collapsed;
    const catBg = lightenColor(cat.color, 0.88);
    html += `<div class="s-cat" data-cat="${cat.id}">
      <div class="s-cat-header" style="background:${catBg}" oncontextmenu="showCatCtx(event,'${cat.id}')" onclick="toggleCat('${cat.id}')">
        <div class="s-cat-color" style="background:${cat.color}"></div>
        <div class="s-cat-toggle ${collapsed ? 'collapsed' : ''}">&#9660;</div>
        <div class="s-cat-name">${esc(cat.name)}</div>
        <div class="s-cat-actions">
          <button class="s-action" onclick="event.stopPropagation();showEditCatModal('${cat.id}')" title="Edit">&#9998;</button>
          <button class="s-action" onclick="event.stopPropagation();deleteCat('${cat.id}')" title="Delete">&#10005;</button>
        </div>
      </div>`;
    if (!collapsed) {
      for (const group of groups) {
        const firstTask = group.tasks[0];
        const sel = state.selectedTask && group.tasks.some(t => t.id === state.selectedTask.taskId) ? ' selected' : '';
        const countBadge = group.tasks.length > 1 ? ` <span style="color:var(--text3);font-weight:400;font-size:11px">(${group.tasks.length})</span>` : '';
        html += `<div class="s-task${sel}" style="height:${group.rowHeight}px" data-cat="${cat.id}" data-task="${firstTask.id}" onclick="openPanel('${cat.id}','${firstTask.id}')" oncontextmenu="showTaskCtx(event,'${cat.id}','${firstTask.id}')">
          <div class="s-task-dot" style="background:${cat.color}"></div>
          <div class="s-task-name">${esc(group.groupName)}${countBadge}</div>
          <div class="s-task-actions">
            <button class="s-action" onclick="event.stopPropagation();showEditTaskModal('${cat.id}','${firstTask.id}')" title="Edit">&#9998;</button>
            <button class="s-action" onclick="event.stopPropagation();deleteTask('${cat.id}','${firstTask.id}')" title="Delete">&#10005;</button>
          </div>
        </div>`;
      }
      html += `<div class="s-add-row" onclick="showAddTaskModal('${cat.id}')">+ Add task</div>`;
    }
    html += `</div>`;
  }
  html += `<div class="s-add-cat" onclick="showAddCatModal()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Add category
  </div>`;
  $sidebarBody.innerHTML = html;
}

function renderTimeline() {
  const cfg = ZOOM_CFG[state.zoom];
  const dayW = cfg.dayWidth;
  const totalDays = cfg.totalDays;
  const start = state.viewStart;
  const totalWidth = totalDays * dayW;
  const today = todayDate();

  // ----- HEADER -----
  let row1 = '', row2 = '';
  if (state.zoom === 'year') {
    // Row 1: Year groups, Row 2: Month columns
    let i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const yr = d.getFullYear();
      let span = 0;
      while (i + span < totalDays && addDays(start, i + span).getFullYear() === yr) span++;
      row1 += `<div class="t-group" style="width:${span * dayW}px">${yr}</div>`;
      i += span;
    }
    i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const isToday = today.getMonth() === mo && today.getFullYear() === d.getFullYear();
      row2 += `<div class="t-col${isToday ? ' today' : ''}" style="width:${span * dayW}px">${MONTHS_SHORT[mo]}</div>`;
      i += span;
    }
  } else if (state.zoom === 'months') {
    // Row 1: Month groups, Row 2: Day numbers
    let i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      row1 += `<div class="t-group" style="width:${span * dayW}px">${MONTHS_SHORT[mo]} ${d.getFullYear()}</div>`;
      i += span;
    }
    for (let j = 0; j < totalDays; j++) {
      const d = addDays(start, j);
      const isWe = d.getDay() === 0 || d.getDay() === 6;
      const isT = d.getTime() === today.getTime();
      row2 += `<div class="t-col${isWe ? ' weekend' : ''}${isT ? ' today' : ''}" style="width:${dayW}px">${d.getDate()}</div>`;
    }
  } else {
    // Days & Weeks: Row 1: Month group, Row 2: Day name + date
    let i = 0;
    while (i < totalDays) {
      const d = addDays(start, i);
      const mo = d.getMonth();
      let span = 0;
      while (i + span < totalDays) {
        const d2 = addDays(start, i + span);
        if (d2.getMonth() !== mo || d2.getFullYear() !== d.getFullYear()) break;
        span++;
      }
      const label = state.zoom === 'days'
        ? `${MONTHS[mo]} ${d.getFullYear()}`
        : `${MONTHS_SHORT[mo]} ${d.getFullYear()}`;
      row1 += `<div class="t-group" style="width:${span * dayW}px">${label}</div>`;
      i += span;
    }
    for (let j = 0; j < totalDays; j++) {
      const d = addDays(start, j);
      const isWe = d.getDay() === 0 || d.getDay() === 6;
      const isT = d.getTime() === today.getTime();
      const label = state.zoom === 'days'
        ? `${DAYS_SHORT[d.getDay()]} ${d.getDate()}`
        : `${d.getDate()}`;
      row2 += `<div class="t-col${isWe ? ' weekend' : ''}${isT ? ' today' : ''}" style="width:${dayW}px">${label}</div>`;
    }
  }

  $timelineHeader.innerHTML =
    `<div class="t-header-row row1" style="width:${totalWidth}px">${row1}</div>
     <div class="t-header-row" style="width:${totalWidth}px">${row2}</div>`;

  // ----- BODY -----
  let gridHTML = '';
  // Weekend columns
  for (let j = 0; j < totalDays; j++) {
    const d = addDays(start, j);
    if (d.getDay() === 0 || d.getDay() === 6) {
      gridHTML += `<div class="t-weekend" style="left:${j * dayW}px;width:${dayW}px"></div>`;
    }
  }
  // Gridlines
  for (let j = 0; j <= totalDays; j++) {
    gridHTML += `<div class="t-gridline" style="left:${j * dayW}px"></div>`;
  }
  // Today line
  const todayOff = diffDays(toStr(start), toStr(today));
  if (todayOff >= 0 && todayOff < totalDays) {
    gridHTML += `<div class="t-today-line" style="left:${todayOff * dayW + dayW / 2}px"></div>`;
  }

  let rowsHTML = '';
  const taskPositions = new Map();
  let currentY = 0;
  const grouped = cachedGroups || buildGroups();

  for (const { cat, groups } of grouped) {
    const catLightBg = lightenColor(cat.color, 0.88);
    rowsHTML += `<div class="t-row cat-row" data-cat="${cat.id}" style="width:${totalWidth}px;background:${catLightBg}"></div>`;
    currentY += 32; // cat-row-h
    if (!cat.collapsed) {
      for (const group of groups) {
        const groupTop = currentY;
        rowsHTML += `<div class="t-row task-row" data-cat="${cat.id}" data-group="${encodeURIComponent(group.groupName)}" style="width:${totalWidth}px;height:${group.rowHeight}px"
          onmousedown="onTimelineRowMouseDown(event,'${cat.id}')">`;
        for (const task of group.tasks) {
          const tStart = diffDays(toStr(start), task.startDate);
          const tDur = diffDays(task.startDate, task.endDate) + 1;
          const barLeft = tStart * dayW;
          const barWidth = Math.max(tDur * dayW - 2, 20);
          const vis = (tStart + tDur > 0 && tStart < totalDays);
          const lane = group.lanes.get(task.id);
          const barTop = lane * LANE_HEIGHT + 4;

          taskPositions.set(task.id, {
            left: barLeft,
            right: barLeft + barWidth,
            centerY: groupTop + barTop + 10
          });

          if (vis) {
            rowsHTML += `<div class="task-bar" data-cat="${cat.id}" data-task="${task.id}"
              style="left:${barLeft}px;width:${barWidth}px;top:${barTop}px;height:20px;background:${cat.color}"
              onmousedown="onBarMouseDown(event,'${cat.id}','${task.id}')"
              onclick="event.stopPropagation();openPanel('${cat.id}','${task.id}')"
              onmouseenter="showBarTooltip(event,'${cat.id}','${task.id}')"
              onmouseleave="hideTooltip()">
              <div class="resize-handle left"></div>
              <span class="task-bar-label">${esc(task.name)}</span>
              <div class="resize-handle right"></div>
              <div class="dep-bubble" onmousedown="onDepBubbleMouseDown(event,'${cat.id}','${task.id}')"></div>
            </div>`;
          }
        }
        rowsHTML += `</div>`;
        currentY += group.rowHeight;
      }
      // Add-row placeholder (matches sidebar s-add-row height)
      rowsHTML += `<div class="t-row task-row" data-cat="${cat.id}" data-add="1" style="width:${totalWidth}px;height:24px"
        onmousedown="onTimelineRowMouseDown(event,'${cat.id}')"></div>`;
      currentY += 24;
    }
  }

  // Build dependency SVG overlay
  let depSVG = `<svg class="dep-svg-overlay" width="${totalWidth}" height="${currentY}">
    <defs><marker id="dep-arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6b7280"/>
    </marker></defs>`;
  for (const cat of state.categories) {
    if (cat.collapsed) continue;
    for (const task of cat.tasks) {
      if (!task.dependencies || task.dependencies.length === 0) continue;
      const toPos = taskPositions.get(task.id);
      if (!toPos) continue;
      for (const predId of task.dependencies) {
        const fromPos = taskPositions.get(predId);
        if (!fromPos) continue;
        const x1 = fromPos.right, y1 = fromPos.centerY;
        const x2 = toPos.left, y2 = toPos.centerY;
        let pathD;
        const gap = x2 - x1;
        if (gap < 20) {
          // Route arrow below the bars when they're adjacent
          const dropY = Math.max(y1, y2) + 16;
          pathD = `M${x1},${y1} L${x1 + 4},${y1} L${x1 + 4},${dropY} L${x2 - 4},${dropY} L${x2 - 4},${y2} L${x2},${y2}`;
        } else {
          const midX = (x1 + x2) / 2;
          pathD = `M${x1},${y1} C${midX},${y1} ${midX},${y2} ${x2},${y2}`;
        }
        depSVG += `<path class="dep-arrow" d="${pathD}"
          data-from="${predId}" data-to="${task.id}" data-cat="${cat.id}"
          oncontextmenu="showDepCtx(event,'${cat.id}','${predId}','${task.id}')"/>`;
      }
    }
  }
  depSVG += `</svg>`;

  $timelineBody.style.width = totalWidth + 'px';
  $timelineBody.innerHTML = `<div class="t-grid">${gridHTML}</div><div class="t-rows">${rowsHTML}${depSVG}</div>`;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ========== NAVIGATION ==========
function navigate(dir) {
  const step = ZOOM_CFG[state.zoom].navStep;
  state.viewStart = addDays(state.viewStart, step * dir);
  render();
}

function goToday() {
  const today = todayDate();
  const totalDays = ZOOM_CFG[state.zoom].totalDays;
  state.viewStart = addDays(today, -Math.floor(totalDays / 4));
  render();
  // Scroll to bring today into view
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const todayOff = diffDays(toStr(state.viewStart), toStr(today));
  $timelineWrap.scrollLeft = Math.max(0, todayOff * dayW - $timelineWrap.clientWidth / 3);
}

function setZoom(z) {
  state.zoom = z;
  $zoomSelect.value = z;
  goToday();
}

// ========== SCROLL SYNC ==========
$timelineWrap.addEventListener('scroll', () => {
  $timelineHeader.scrollLeft = $timelineWrap.scrollLeft;
  $sidebarBody.scrollTop = $timelineWrap.scrollTop;
});
$sidebarBody.addEventListener('scroll', () => {
  $timelineWrap.scrollTop = $sidebarBody.scrollTop;
});

// ========== CATEGORY CRUD ==========
function toggleCat(catId) {
  const cat = findCat(catId);
  if (cat) { cat.collapsed = !cat.collapsed; render(); saveState(); }
}

function showAddCatModal() {
  const html = `
    <div class="modal-header">Add Category<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Name</label><input id="mCatName" placeholder="Category name" autofocus></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map((c, i) => `<div class="color-swatch${i === 0 ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doAddCat()">Add</button>
    </div>`;
  openModal(html);
  setTimeout(() => document.getElementById('mCatName')?.focus(), 100);
}

function doAddCat() {
  const name = document.getElementById('mCatName').value.trim();
  if (!name) return;
  const color = document.querySelector('#mColorPicker .selected')?.dataset.color || COLORS[0];
  state.categories.push({ id: uid(), name, color, collapsed: false, tasks: [] });
  closeModal(); render(); saveState();
}

function showEditCatModal(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  const html = `
    <div class="modal-header">Edit Category<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Name</label><input id="mCatName" value="${esc(cat.name)}"></div>
      <div class="form-group"><label>Color</label><div class="color-picker" id="mColorPicker">
        ${COLORS.map(c => `<div class="color-swatch${c === cat.color ? ' selected' : ''}" style="background:${c}" data-color="${c}" onclick="pickColor(this)"></div>`).join('')}
      </div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeModal();deleteCat('${catId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doEditCat('${catId}')">Save</button>
    </div>`;
  openModal(html);
}

function doEditCat(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  cat.name = document.getElementById('mCatName').value.trim() || cat.name;
  cat.color = document.querySelector('#mColorPicker .selected')?.dataset.color || cat.color;
  closeModal(); render(); saveState();
}

function deleteCat(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  showConfirmModal('Delete Category', `Are you sure you want to delete "${esc(cat.name)}" and all its tasks? This cannot be undone.`, () => {
    state.categories = state.categories.filter(c => c.id !== catId);
    if (state.selectedTask?.catId === catId) closePanel();
    render(); saveState();
  });
}

// ========== TASK CRUD ==========
function showAddTaskModal(catId, prefillStart, prefillEnd) {
  const today = toStr(todayDate());
  const startVal = prefillStart || today;
  const endVal = prefillEnd || toStr(addDays(toDate(startVal), 6));
  const html = `
    <div class="modal-header">Add Task<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Task Name</label><input id="mTaskName" placeholder="Task name" autofocus></div>
      <div class="form-group"><label>Start Date</label><input id="mStartDate" type="date" value="${startVal}"></div>
      <div class="form-group"><label>End Date</label><input id="mEndDate" type="date" value="${endVal}"></div>
      <div class="form-group"><label>Status</label>
        <select id="mStatus">${STATUS_OPTIONS.map(s => `<option value="${s.value}">${s.label}</option>`).join('')}</select>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="mNotes" rows="3" placeholder="Add notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doAddTask('${catId}')">Add</button>
    </div>`;
  openModal(html);
  setTimeout(() => document.getElementById('mTaskName')?.focus(), 100);
}

function doAddTask(catId) {
  const cat = findCat(catId);
  if (!cat) return;
  const name = document.getElementById('mTaskName').value.trim();
  if (!name) return;
  cat.tasks.push({
    id: uid(),
    name,
    startDate: document.getElementById('mStartDate').value,
    endDate: document.getElementById('mEndDate').value,
    status: document.getElementById('mStatus').value,
    notes: document.getElementById('mNotes').value,
    urls: [],
    dependencies: []
  });
  closeModal(); render(); saveState();
}

function showEditTaskModal(catId, taskId) {
  const task = findTask(catId, taskId);
  if (!task) return;
  const html = `
    <div class="modal-header">Edit Task<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Task Name</label><input id="mTaskName" value="${esc(task.name)}"></div>
      <div class="form-group"><label>Start Date</label><input id="mStartDate" type="date" value="${task.startDate}"></div>
      <div class="form-group"><label>End Date</label><input id="mEndDate" type="date" value="${task.endDate}"></div>
      <div class="form-group"><label>Status</label>
        <select id="mStatus">${STATUS_OPTIONS.map(s => `<option value="${s.value}"${s.value === task.status ? ' selected' : ''}>${s.label}</option>`).join('')}</select>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="mNotes" rows="3">${esc(task.notes)}</textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeModal();deleteTask('${catId}','${taskId}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doEditTask('${catId}','${taskId}')">Save</button>
    </div>`;
  openModal(html);
}

function doEditTask(catId, taskId) {
  const task = findTask(catId, taskId);
  if (!task) return;
  task.name = document.getElementById('mTaskName').value.trim() || task.name;
  task.startDate = document.getElementById('mStartDate').value;
  task.endDate = document.getElementById('mEndDate').value;
  task.status = document.getElementById('mStatus').value;
  task.notes = document.getElementById('mNotes').value;
  enforceAllDependencies(catId, taskId);
  closeModal(); render(); saveState();
  if (state.selectedTask?.taskId === taskId) renderPanel();
}

function deleteTask(catId, taskId) {
  const cat = findCat(catId);
  if (!cat) return;
  const task = findTask(catId, taskId);
  if (!task) return;
  showConfirmModal('Delete Task', `Are you sure you want to delete "${esc(task.name)}"? This cannot be undone.`, () => {
    // Clean up dependency references
    for (const t of cat.tasks) {
      if (t.dependencies) {
        t.dependencies = t.dependencies.filter(id => id !== taskId);
      }
    }
    cat.tasks = cat.tasks.filter(t => t.id !== taskId);
    if (state.selectedTask?.taskId === taskId) closePanel();
    render(); saveState();
  });
}

// ========== DETAIL PANEL ==========
function openPanel(catId, taskId) {
  hideTooltip();
  state.selectedTask = { catId, taskId };
  renderPanel();
  $panelOverlay.classList.add('open');
  $detailPanel.classList.add('open');
  render();
}

function closePanel() {
  state.selectedTask = null;
  $panelOverlay.classList.remove('open');
  $detailPanel.classList.remove('open');
  render();
}

function renderPanel() {
  if (!state.selectedTask) return;
  const { catId, taskId } = state.selectedTask;
  const cat = findCat(catId);
  const task = findTask(catId, taskId);
  if (!cat || !task) { closePanel(); return; }

  const statusOpt = STATUS_OPTIONS.find(s => s.value === task.status) || STATUS_OPTIONS[0];

  $detailPanel.innerHTML = `
    <div class="dp-header">
      <span class="dp-breadcrumb">${esc(cat.name)} / ${esc(task.name)}</span>
      <button class="s-action" onclick="closePanel()">&#10005;</button>
    </div>
    <div class="dp-title-row">
      <div class="dp-color-dot" style="background:${cat.color}"></div>
      <input class="dp-title-input" value="${esc(task.name)}" onchange="panelUpdate('name',this.value)">
    </div>
    <div class="dp-body">
      <div class="dp-field">
        <label class="dp-label">Status</label>
        <select class="dp-select" onchange="panelUpdate('status',this.value)">
          ${STATUS_OPTIONS.map(s => `<option value="${s.value}"${s.value === task.status ? ' selected' : ''}>${s.label}</option>`).join('')}
        </select>
      </div>
      <div class="dp-field">
        <label class="dp-label">Dates</label>
        <div class="dp-date-row">
          <input class="dp-input" type="date" value="${task.startDate}" onchange="panelUpdate('startDate',this.value)" style="flex:1">
          <span>&rarr;</span>
          <input class="dp-input" type="date" value="${task.endDate}" onchange="panelUpdate('endDate',this.value)" style="flex:1">
        </div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">${diffDays(task.startDate, task.endDate) + 1} days</div>
      </div>
      <div class="dp-field">
        <label class="dp-label">Notes</label>
        <textarea class="dp-textarea" onchange="panelUpdate('notes',this.value)">${esc(task.notes)}</textarea>
      </div>
      <div class="dp-field">
        <label class="dp-label">Links</label>
        <div class="url-list" id="dpUrlList">
          ${(task.urls || []).map((u, i) => `<div class="url-item">
            <span class="url-item-title">${esc(u.title || 'Link')}</span>
            <a href="${esc(u.url)}" target="_blank" rel="noopener">${esc(u.url)}</a>
            <button class="s-action" onclick="removeUrl(${i})" title="Remove">&#10005;</button>
          </div>`).join('')}
        </div>
        <div class="url-add-row">
          <div class="url-add-inputs">
            <input id="dpUrlTitle" placeholder="Title" style="flex:0.4">
            <input id="dpUrlValue" placeholder="https://..." style="flex:0.6">
            <button class="btn btn-icon" onclick="addUrlFromPanel()" title="Add link" style="flex-shrink:0">+</button>
          </div>
        </div>
      </div>
      ${(() => {
        const predecessors = (task.dependencies || []).map(id => findTask(catId, id)).filter(Boolean);
        const dependents = cat.tasks.filter(t => t.dependencies && t.dependencies.includes(task.id));
        if (predecessors.length === 0 && dependents.length === 0) return '';
        let depHtml = '<div class="dp-field"><label class="dp-label">Dependencies</label>';
        if (predecessors.length > 0) {
          depHtml += '<div style="font-size:11px;color:var(--text3);margin-bottom:4px">Depends on:</div>';
          for (const p of predecessors) {
            depHtml += `<div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:2px">
              <span style="color:var(--text2)">${esc(p.name)} (${formatDateShort(toDate(p.endDate))})</span>
              <button class="s-action" onclick="removeDep('${catId}','${task.id}','${p.id}')" title="Remove">&#10005;</button>
            </div>`;
          }
        }
        if (dependents.length > 0) {
          depHtml += '<div style="font-size:11px;color:var(--text3);margin-bottom:4px;margin-top:6px">Blocks:</div>';
          for (const d of dependents) {
            depHtml += `<div style="font-size:12px;color:var(--text2);margin-bottom:2px">${esc(d.name)} (${formatDateShort(toDate(d.startDate))})</div>`;
          }
        }
        depHtml += '</div>';
        return depHtml;
      })()}
    </div>
    <div class="dp-footer">
      <button class="btn btn-danger" onclick="closePanel();deleteTask('${catId}','${taskId}')">Delete</button>
      <button class="btn btn-primary" onclick="closePanel()">Done</button>
    </div>`;
}

function panelUpdate(key, value) {
  if (!state.selectedTask) return;
  const task = findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task) return;
  task[key] = value;
  if (key === 'startDate' || key === 'endDate') {
    enforceAllDependencies(state.selectedTask.catId, state.selectedTask.taskId);
  }
  render(); saveState();
  renderPanel();
}

function addUrlFromPanel() {
  if (!state.selectedTask) return;
  const task = findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task) return;
  const title = document.getElementById('dpUrlTitle')?.value.trim() || 'Link';
  const url = document.getElementById('dpUrlValue')?.value.trim();
  if (!url) return;
  if (!task.urls) task.urls = [];
  task.urls.push({ title, url });
  render(); saveState();
  renderPanel();
}

function removeDep(catId, taskId, predId) {
  const task = findTask(catId, taskId);
  if (!task || !task.dependencies) return;
  task.dependencies = task.dependencies.filter(id => id !== predId);
  render(); saveState();
  renderPanel();
}

function removeUrl(idx) {
  if (!state.selectedTask) return;
  const task = findTask(state.selectedTask.catId, state.selectedTask.taskId);
  if (!task || !task.urls) return;
  task.urls.splice(idx, 1);
  render(); saveState();
  renderPanel();
}

// ========== MODAL ==========
function openModal(html) {
  hideTooltip();
  $modal.innerHTML = html;
  $modalBg.classList.add('open');
}
function closeModal() { $modalBg.classList.remove('open'); }

let _confirmCb = null;
function showConfirmModal(title, message, onConfirm) {
  _confirmCb = onConfirm;
  const html = `
    <div class="modal-header" style="color:var(--red)">${title}<button class="s-action" onclick="closeModal()">&#10005;</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin:0">${message}</p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-danger" onclick="_confirmCb&&_confirmCb();closeModal()">Delete</button>
    </div>`;
  openModal(html);
}

function pickColor(el) {
  el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
}

// ========== PROJECT NAME ==========
const $projectName = document.getElementById('projectName');

function editProjectName() {
  const span = $projectName;
  const current = state.projectName;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = current;
  input.className = 'project-name-input';
  span.replaceWith(input);
  input.focus();
  input.select();

  function commit() {
    const val = input.value.trim() || current;
    state.projectName = val;
    const newSpan = document.createElement('span');
    newSpan.id = 'projectName';
    newSpan.className = 'project-name';
    newSpan.textContent = val;
    newSpan.title = 'Click to rename';
    newSpan.onclick = editProjectName;
    input.replaceWith(newSpan);
    document.title = `Resource Manager - ${val}`;
    saveState();
  }

  input.addEventListener('blur', commit);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') input.blur();
    if (e.key === 'Escape') { input.value = current; input.blur(); }
  });
}

function applyProjectName() {
  $projectName.textContent = state.projectName;
  document.title = `Resource Manager - ${state.projectName}`;
}

// ========== ADD MENU ==========
function showAddMenu(e) {
  e.stopPropagation();
  const items = [
    { label: '+ New Category', action: () => showAddCatModal() },
    ...state.categories.map(c => ({
      label: `+ Task in "${c.name}"`,
      action: () => showAddTaskModal(c.id)
    }))
  ];
  showCtxMenu(e.clientX, e.clientY, items);
}

// ========== CONTEXT MENU ==========
function showCtxMenu(x, y, items) {
  let html = '';
  for (const item of items) {
    html += `<div class="ctx-item${item.danger ? ' danger' : ''}" data-idx="${items.indexOf(item)}">${item.label}</div>`;
  }
  $ctxMenu.innerHTML = html;
  $ctxMenu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
  $ctxMenu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
  $ctxMenu.classList.add('open');
  $ctxMenu._items = items;
  $ctxMenu.querySelectorAll('.ctx-item').forEach(el => {
    el.addEventListener('click', () => {
      items[Number(el.dataset.idx)].action();
      closeCtxMenu();
    });
  });
}

function closeCtxMenu() { $ctxMenu.classList.remove('open'); }

function showCatCtx(e, catId) {
  e.preventDefault(); e.stopPropagation();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'Add Task', action: () => showAddTaskModal(catId) },
    { label: 'Edit Category', action: () => showEditCatModal(catId) },
    { label: 'Delete Category', danger: true, action: () => deleteCat(catId) }
  ]);
}

function showTaskCtx(e, catId, taskId) {
  e.preventDefault(); e.stopPropagation();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'Edit Task', action: () => showEditTaskModal(catId, taskId) },
    { label: 'Open Details', action: () => openPanel(catId, taskId) },
    { label: 'Delete Task', danger: true, action: () => deleteTask(catId, taskId) }
  ]);
}

document.addEventListener('click', () => closeCtxMenu());
document.addEventListener('contextmenu', (e) => {
  if (!e.target.closest('.s-cat-header') && !e.target.closest('.s-task')) closeCtxMenu();
});

// ========== DRAG: HELPERS ==========
let $dragDateLabel = null;

function showDragLabel(x, y, text) {
  if (!$dragDateLabel) {
    $dragDateLabel = document.createElement('div');
    $dragDateLabel.className = 'drag-date-label';
    document.body.appendChild($dragDateLabel);
  }
  $dragDateLabel.textContent = text;
  $dragDateLabel.style.left = x + 'px';
  $dragDateLabel.style.top = y + 'px';
  $dragDateLabel.style.display = 'block';
}

function hideDragLabel() {
  if ($dragDateLabel) $dragDateLabel.style.display = 'none';
}

function calcBarPos(startDate, endDate) {
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const tStart = diffDays(toStr(state.viewStart), startDate);
  const tDur = diffDays(startDate, endDate) + 1;
  return { left: tStart * dayW, width: Math.max(tDur * dayW - 2, 20) };
}

// ========== DRAG: MOVE/RESIZE TASK BARS ==========
function onBarMouseDown(e, catId, taskId) {
  if (e.button !== 0) return;
  e.stopPropagation();
  e.preventDefault();
  const bar = e.target.closest('.task-bar');
  if (!bar) return;
  const task = findTask(catId, taskId);
  if (!task) return;

  const isLeft = e.target.classList.contains('left');
  const isRight = e.target.classList.contains('right');
  const mode = isLeft ? 'resize-start' : isRight ? 'resize-end' : 'move';

  dragState = {
    catId, taskId, mode,
    startX: e.clientX,
    startY: e.clientY,
    origStart: task.startDate,
    origEnd: task.endDate,
    dayWidth: ZOOM_CFG[state.zoom].dayWidth,
    bar,
    hasMoved: false,
    lastDayDelta: 0
  };
}

// ========== DRAG: CREATE NEW TASK ==========
function onTimelineRowMouseDown(e, catId) {
  if (e.button !== 0 || e.target.closest('.task-bar')) return;
  const dayW = ZOOM_CFG[state.zoom].dayWidth;
  const row = e.target.closest('.t-row');
  if (!row) return;
  const rowRect = row.getBoundingClientRect();
  const clickX = e.clientX - rowRect.left + $timelineWrap.scrollLeft;
  const dayOffset = Math.floor(clickX / dayW);
  const clickDate = toStr(addDays(state.viewStart, dayOffset));

  createDragState = {
    catId,
    startDate: clickDate,
    endDate: clickDate,
    startX: e.clientX,
    dayWidth: dayW,
    row,
    preview: null,
    origDayOffset: dayOffset,
    started: false
  };
}

document.addEventListener('mousemove', (e) => {
  // ---- Task bar move/resize ----
  if (dragState) {
    const dx = e.clientX - dragState.startX;

    // Detect if drag threshold crossed
    if (!dragState.hasMoved) {
      if (Math.abs(dx) > 3) {
        dragState.hasMoved = true;
        dragState.bar.classList.add('dragging');
        document.body.classList.add(dragState.mode === 'move' ? 'dragging' : 'resizing');
        hideTooltip();
      } else {
        return;
      }
    }

    const dayDelta = Math.round(dx / dragState.dayWidth);
    if (dayDelta === dragState.lastDayDelta) {
      // Only update label position, skip DOM changes
      const task = findTask(dragState.catId, dragState.taskId);
      if (task) {
        const dur = diffDays(task.startDate, task.endDate) + 1;
        showDragLabel(e.clientX, dragState.bar.getBoundingClientRect().top,
          `${formatDateShort(toDate(task.startDate))} \u2192 ${formatDateShort(toDate(task.endDate))}  (${dur}d)`);
      }
      return;
    }
    dragState.lastDayDelta = dayDelta;

    // Compute new dates
    let newStart, newEnd;
    if (dragState.mode === 'move') {
      newStart = toStr(addDays(toDate(dragState.origStart), dayDelta));
      newEnd = toStr(addDays(toDate(dragState.origEnd), dayDelta));
    } else if (dragState.mode === 'resize-start') {
      newStart = toStr(addDays(toDate(dragState.origStart), dayDelta));
      newEnd = dragState.origEnd;
      if (toDate(newStart) > toDate(newEnd)) newStart = newEnd;
    } else {
      newStart = dragState.origStart;
      newEnd = toStr(addDays(toDate(dragState.origEnd), dayDelta));
      if (toDate(newEnd) < toDate(newStart)) newEnd = newStart;
    }

    // Update bar position directly (no re-render)
    const pos = calcBarPos(newStart, newEnd);
    dragState.bar.style.left = pos.left + 'px';
    dragState.bar.style.width = pos.width + 'px';

    // Store computed dates on dragState for commit on mouseup
    dragState.newStart = newStart;
    dragState.newEnd = newEnd;

    // Show floating date label
    const dur = diffDays(newStart, newEnd) + 1;
    showDragLabel(e.clientX, dragState.bar.getBoundingClientRect().top,
      `${formatDateShort(toDate(newStart))} \u2192 ${formatDateShort(toDate(newEnd))}  (${dur}d)`);
  }

  // ---- Create new task by dragging empty area ----
  if (createDragState) {
    const dx = e.clientX - createDragState.startX;
    if (Math.abs(dx) < 5) return;
    if (!createDragState.started) {
      createDragState.started = true;
      document.body.classList.add('dragging');
      const preview = document.createElement('div');
      preview.className = 'task-bar dragging';
      const cat = findCat(createDragState.catId);
      preview.style.cssText = `left:${createDragState.origDayOffset * createDragState.dayWidth}px;width:${createDragState.dayWidth}px;background:${cat?.color || '#3b82f6'};opacity:0.5;pointer-events:none;transition:none`;
      createDragState.row.appendChild(preview);
      createDragState.preview = preview;
    }
    const dayDelta = Math.round(dx / createDragState.dayWidth);
    const newDayOffset = createDragState.origDayOffset + dayDelta;
    const minOff = Math.min(createDragState.origDayOffset, newDayOffset);
    const maxOff = Math.max(createDragState.origDayOffset, newDayOffset);
    createDragState.startDate = toStr(addDays(state.viewStart, minOff));
    createDragState.endDate = toStr(addDays(state.viewStart, maxOff));

    if (createDragState.preview) {
      createDragState.preview.style.left = minOff * createDragState.dayWidth + 'px';
      createDragState.preview.style.width = (maxOff - minOff + 1) * createDragState.dayWidth + 'px';
    }

    const dur = maxOff - minOff + 1;
    showDragLabel(e.clientX, createDragState.row.getBoundingClientRect().top,
      `${formatDateShort(toDate(createDragState.startDate))} \u2192 ${formatDateShort(toDate(createDragState.endDate))}  (${dur}d)`);
  }

  // ---- Dependency bubble drag ----
  if (depDragState) {
    if (!depDragState.started) {
      depDragState.started = true;
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:500';
      svg.innerHTML = `<line x1="${depDragState.startX}" y1="${depDragState.startY}" x2="${e.clientX}" y2="${e.clientY}" stroke="#6b7280" stroke-width="2" stroke-dasharray="6,3"/>`;
      document.body.appendChild(svg);
      depDragState.svgLine = svg;
    }
    if (depDragState.svgLine) {
      const line = depDragState.svgLine.querySelector('line');
      line.setAttribute('x2', e.clientX);
      line.setAttribute('y2', e.clientY);
    }
  }
});

document.addEventListener('mouseup', (e) => {
  if (dragState) {
    const wasClick = !dragState.hasMoved;
    const catId = dragState.catId;
    const taskId = dragState.taskId;

    // Clean up visual state
    dragState.bar.classList.remove('dragging');
    document.body.classList.remove('dragging', 'resizing');
    hideDragLabel();

    if (wasClick) {
      dragState = null;
      openPanel(catId, taskId);
    } else {
      // Commit the date changes to state
      const task = findTask(catId, taskId);
      if (task && dragState.newStart && dragState.newEnd) {
        task.startDate = dragState.newStart;
        task.endDate = dragState.newEnd;
        enforceAllDependencies(catId, taskId);
      }
      dragState = null;
      render();
      saveState();
    }
  }
  if (createDragState) {
    document.body.classList.remove('dragging');
    hideDragLabel();
    if (createDragState.preview) createDragState.preview.remove();
    if (createDragState.started) {
      const dur = diffDays(createDragState.startDate, createDragState.endDate);
      if (dur >= 0) {
        showAddTaskModal(createDragState.catId, createDragState.startDate, createDragState.endDate);
      }
    }
    createDragState = null;
  }
  if (depDragState) {
    if (depDragState.svgLine) depDragState.svgLine.remove();
    if (depDragState.started) {
      const el = document.elementFromPoint(e.clientX, e.clientY);
      const targetBar = el?.closest('.task-bar');
      if (targetBar) {
        const toTaskId = targetBar.dataset.task;
        const toCatId = targetBar.dataset.cat;
        if (toTaskId && toTaskId !== depDragState.fromTaskId && toCatId === depDragState.catId) {
          const fromTask = findTask(depDragState.catId, depDragState.fromTaskId);
          const toTask = findTask(toCatId, toTaskId);
          if (fromTask && toTask && fromTask.name === toTask.name) {
            if (!wouldCreateCycle(depDragState.catId, depDragState.fromTaskId, toTaskId)) {
              if (!toTask.dependencies) toTask.dependencies = [];
              if (!toTask.dependencies.includes(depDragState.fromTaskId)) {
                toTask.dependencies.push(depDragState.fromTaskId);
                enforceDependency(depDragState.catId, depDragState.fromTaskId, toTaskId);
                render(); saveState();
              }
            }
          }
        }
      }
    }
    depDragState = null;
  }
});

// ========== DEPENDENCIES ==========
function enforceDependency(catId, predId, depId) {
  const pred = findTask(catId, predId);
  const dep = findTask(catId, depId);
  if (!pred || !dep) return;
  const minStart = toStr(addDays(toDate(pred.endDate), 1));
  if (toDate(dep.startDate) < toDate(minStart)) {
    const shift = diffDays(dep.startDate, minStart);
    dep.startDate = minStart;
    dep.endDate = toStr(addDays(toDate(dep.endDate), shift));
    cascadeDependencies(catId, dep.id);
  }
}

function cascadeDependencies(catId, movedTaskId) {
  const cat = findCat(catId);
  if (!cat) return;
  for (const task of cat.tasks) {
    if (task.dependencies && task.dependencies.includes(movedTaskId)) {
      enforceDependency(catId, movedTaskId, task.id);
    }
  }
}

function enforceAllDependencies(catId, taskId) {
  cascadeDependencies(catId, taskId);
}

function wouldCreateCycle(catId, fromId, toId) {
  const visited = new Set();
  function dfs(taskId) {
    if (taskId === toId) return true;
    if (visited.has(taskId)) return false;
    visited.add(taskId);
    const task = findTask(catId, taskId);
    if (!task || !task.dependencies) return false;
    for (const depId of task.dependencies) {
      if (dfs(depId)) return true;
    }
    return false;
  }
  return dfs(fromId);
}

function onDepBubbleMouseDown(e, catId, taskId) {
  e.stopPropagation();
  e.preventDefault();
  const bar = e.target.closest('.task-bar');
  if (!bar) return;
  const barRect = bar.getBoundingClientRect();
  depDragState = {
    catId,
    fromTaskId: taskId,
    startX: barRect.right,
    startY: barRect.top + barRect.height / 2,
    svgLine: null,
    started: false
  };
}

function showDepCtx(e, catId, fromId, toId) {
  e.preventDefault();
  e.stopPropagation();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'Remove dependency', danger: true, action: () => {
      const depTask = findTask(catId, toId);
      if (depTask && depTask.dependencies) {
        depTask.dependencies = depTask.dependencies.filter(id => id !== fromId);
        render(); saveState();
      }
    }}
  ]);
}

// ========== TOOLTIP ==========
function showBarTooltip(e, catId, taskId) {
  if ($panelOverlay.classList.contains('open') || $modalBg.classList.contains('open') || $aiPanel.classList.contains('open')) return;
  const task = findTask(catId, taskId);
  const cat = findCat(catId);
  if (!task || !cat) return;
  const dur = diffDays(task.startDate, task.endDate) + 1;
  $tooltip.textContent = `${task.name} | ${formatDateShort(toDate(task.startDate))} - ${formatDateShort(toDate(task.endDate))} (${dur}d)`;
  $tooltip.style.display = 'block';
  positionTooltip(e);
}

function positionTooltip(e) {
  $tooltip.style.left = e.clientX + 'px';
  $tooltip.style.top = (e.clientY - 36) + 'px';
}

function hideTooltip() { $tooltip.style.display = 'none'; }

document.addEventListener('mousemove', (e) => {
  if ($tooltip.style.display === 'block') positionTooltip(e);
});

// ========== KEYBOARD ==========
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closePanel();
    closeCtxMenu();
    closeAI();
  }
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowLeft') navigate(-1);
  if (e.key === 'ArrowRight') navigate(1);
  if (e.key === 't' || e.key === 'T') goToday();
});

// ========== AI PANEL ==========
function toggleAI() {
  if ($aiPanel.classList.contains('open')) closeAI();
  else openAI();
}

function openAI() {
  closePanel();
  renderAIPanel();
  $aiPanel.classList.add('open');
}

function closeAI() { $aiPanel.classList.remove('open'); }

function renderAIPanel() {
  let msgsHtml = '';
  if (!state.aiKey) {
    msgsHtml = `<div class="ai-key-setup">
      <p><strong>AI Assistant Setup</strong><br><br>
      Enter your free Google Gemini API key to enable AI-powered project analysis and calculations.</p>
      <input id="aiKeyInput" type="password" placeholder="Paste your Gemini API key">
      <br><button class="btn btn-primary" onclick="saveAIKey()" style="margin-bottom:8px">Save Key</button>
      <br><a href="https://aistudio.google.com/app/apikey" target="_blank">Get a free API key from Google AI Studio &rarr;</a>
    </div>`;
  } else {
    if (state.aiMessages.length === 0) {
      msgsHtml = `<div class="ai-msg system">AI Assistant ready. Ask questions about your projects, request schedule analysis, or get resource allocation suggestions.</div>`;
    }
    for (const msg of state.aiMessages) {
      msgsHtml += `<div class="ai-msg ${msg.role}">${escNl(msg.text)}</div>`;
    }
  }

  $aiPanel.innerHTML = `
    <div class="ai-header">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 014 4v1h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v3a4 4 0 01-8 0v-3H7a3 3 0 01-3-3v-2a3 3 0 013-3h1V6a4 4 0 014-4z"/><circle cx="9" cy="11" r="1" fill="currentColor"/><circle cx="15" cy="11" r="1" fill="currentColor"/></svg> AI Assistant</h3>
      <div style="display:flex;gap:4px">
        ${state.aiKey ? `<button class="s-action" onclick="state.aiKey='';state.aiMessages=[];saveState();renderAIPanel()" title="Reset API Key">&#9881;</button>` : ''}
        <button class="s-action" onclick="closeAI()">&#10005;</button>
      </div>
    </div>
    <div class="ai-messages" id="aiMessages">${msgsHtml}</div>
    ${state.aiKey ? `<div class="ai-input-row">
      <input class="ai-input" id="aiInput" placeholder="Ask about your projects..." onkeydown="if(event.key==='Enter')sendAI()">
      <button class="btn btn-primary btn-icon" onclick="sendAI()">&#10148;</button>
    </div>` : ''}`;

  // Scroll to bottom
  setTimeout(() => {
    const el = document.getElementById('aiMessages');
    if (el) el.scrollTop = el.scrollHeight;
  }, 50);
}

function escNl(s) {
  return esc(s).replace(/\n/g, '<br>');
}

function saveAIKey() {
  const key = document.getElementById('aiKeyInput')?.value.trim();
  if (key) {
    state.aiKey = key;
    saveState();
    renderAIPanel();
  }
}

async function sendAI() {
  const input = document.getElementById('aiInput');
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  state.aiMessages.push({ role: 'user', text });
  renderAIPanel();

  // Build context
  const projectCtx = state.categories.map(c => {
    const tasks = c.tasks.map(t => {
      const dur = diffDays(t.startDate, t.endDate) + 1;
      return `  - ${t.name}: ${t.startDate} to ${t.endDate} (${dur} days), Status: ${t.status}, Links: ${(t.urls||[]).length}`;
    }).join('\n');
    return `Category: ${c.name}\n${tasks || '  (no tasks)'}`;
  }).join('\n\n');

  const today = toStr(todayDate());
  const systemPrompt = `You are an AI assistant for a project resource manager application. Today's date is ${today}. Here is the current project data:\n\n${projectCtx}\n\nHelp the user with project scheduling, resource analysis, timeline calculations, budget summaries, and planning suggestions. Be concise and practical. Format numbers clearly. If asked for calculations, show your work briefly.`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${state.aiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [
            { role: 'user', parts: [{ text: systemPrompt + '\n\nUser question: ' + text }] }
          ]
        })
      }
    );
    const data = await response.json();
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
    state.aiMessages.push({ role: 'assistant', text: reply });
  } catch (err) {
    state.aiMessages.push({ role: 'assistant', text: 'Error: ' + err.message + '. Please check your API key.' });
  }

  saveState();
  renderAIPanel();
}

// ========== INIT ==========
function init() {
  loadState();
  if (state.categories.length === 0) loadSampleData();

  applyProjectName();

  // Set initial view
  state.zoom = 'weeks';
  $zoomSelect.value = 'weeks';
  goToday();
}

// Handle enter in modal inputs
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && $modalBg.classList.contains('open')) {
    const btn = $modal.querySelector('.modal-footer .btn-primary');
    if (btn && e.target.tagName !== 'TEXTAREA') btn.click();
  }
});

init();
</script>
</body>
</html>
